<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Jira · Sprint Tasks v2.0</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@300;400;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f8f7f4;
            --bg-secondary: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --accent: #d4380d;
            --good: #389e0d;
            --warn: #cf1322;
            --muted: #bfbfbf;
            --alert-missing: #fa8c16;
            --alert-blocked: #d4380d;
            --border: #e0ddd7;
            --shadow: rgba(0, 0, 0, 0.04);
        }

        body {
            font-family: 'Crimson Pro', serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1040px;
            margin: 0 auto;
            padding: 2.5rem 1.5rem 3rem;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        header {
            margin-bottom: 2.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1.5rem;
        }

        h1 {
            font-size: 3rem;
            font-weight: 300;
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
            animation: slideDown 0.8s ease-out 0.2s both;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .subtitle {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            animation: slideDown 0.8s ease-out 0.4s both;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-input {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            text-transform: none;
            letter-spacing: normal;
            width: 260px;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(212, 56, 13, 0.1);
        }

        .search-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }

        .sprint-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
            position: relative;
        }

        .sprint-selector label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin: 0;
        }

        .sprint-selector button {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            margin: 0;
        }

        select {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(212, 56, 13, 0.1);
        }

        select:hover {
            border-color: var(--text-secondary);
        }

        select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .config-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 2rem;
            margin-bottom: 3rem;
            animation: slideUp 0.6s ease-out 0.4s both;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        input {
            width: 100%;
            padding: 0.875rem;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            font-family: 'Crimson Pro', serif;
            font-size: 1rem;
            transition: all 0.2s;
        }

        input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(212, 56, 13, 0.1);
        }

        button {
            background: var(--text-primary);
            color: var(--bg-primary);
            border: none;
            padding: 0.875rem 2rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 1rem;
        }

        button:hover {
            background: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        button.secondary:hover {
            background: var(--bg-primary);
            transform: none;
        }

        button.toggle {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            margin: 0 0.5rem;
        }

        button.toggle:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
            transform: none;
        }

        button.toggle.active {
            background: var(--text-primary);
            color: var(--bg-primary);
            border-color: var(--text-primary);
        }

        .toggle-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.25rem;
            flex-wrap: wrap;
        }

	        .alert-panels {
	            display: grid;
	            grid-template-columns: 1fr;
	            gap: 1rem;
	            margin: 1.5rem 0 1.75rem;
	        }

        .alert-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-left: 6px solid var(--accent);
            padding: 1.2rem 1.4rem;
            box-shadow: 0 10px 30px var(--shadow);
        }

        .alert-card.missing {
            border-left-color: var(--alert-missing);
        }

        .alert-card.blocked {
            border-left-color: var(--alert-blocked);
        }

        .alert-card.no-epic {
            border-left-color: #722ed1;
        }

	        .alert-card.empty-epic {
	            border-left-color: #fa8c16;
	        }

	        .alert-card.done-epic {
	            border-left-color: #52c41a;
	        }

        .alert-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 0.8rem;
            flex-wrap: wrap;
        }

        .alert-title {
            font-weight: 700;
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: 0.45rem;
        }

        .alert-subtitle {
            flex: 1;
            color: var(--text-secondary);
            font-size: 0.9rem;
            min-width: 220px;
        }

        .alert-chip {
            background: #1a1a1a;
            color: #fff;
            padding: 0.2rem 0.65rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-family: 'IBM Plex Mono', monospace;
        }

        .alert-toggle {
            background: transparent;
            border: none;
            color: var(--text-primary);
            padding: 0;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .alert-toggle:hover {
            background: transparent;
            transform: none;
            box-shadow: none;
        }

        .alert-toggle-icon {
            width: 1.15rem;
            height: 1.15rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #444;
        }

        .alert-toggle-chevron {
            width: 0.7rem;
            height: 0.7rem;
            display: block;
            transition: transform 0.2s ease;
        }

        .alert-toggle-chevron.collapsed {
            transform: rotate(-90deg);
        }

        .alert-toggle-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            letter-spacing: 0.02em;
        }

        .alert-card-body {
            margin-top: 0.5rem;
        }

        .alert-epic {
            border: 1px solid var(--border);
            padding: 0.85rem;
            margin-bottom: 0.6rem;
            background: #faf9f7;
        }

        .alert-epic-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            margin-bottom: 0.55rem;
            flex-wrap: wrap;
        }

        .alert-epic-title {
            display: flex;
            align-items: center;
            gap: 0.45rem;
            font-weight: 600;
        }

        .alert-epic-link {
            font-size: 0.85rem;
            color: var(--accent);
            text-decoration: none;
        }

        .alert-stories {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .alert-story {
            display: flex;
            align-items: flex-start;
            gap: 0.55rem;
            padding: 0.5rem 0.4rem;
            border-radius: 6px;
            border: 1px dashed var(--border);
            background: #fff;
        }

        .alert-story:hover {
            border-color: var(--accent);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }

        .alert-pill {
            padding: 0.25rem 0.55rem;
            border-radius: 999px;
            background: #f0f0f0;
            font-size: 0.75rem;
            font-family: 'IBM Plex Mono', monospace;
            color: #444;
            white-space: nowrap;
        }

        .alert-pill.team {
            background: #e6f4ff;
            color: #0958d9;
        }

        .alert-pill.status {
            background: #fff1f0;
            color: #d4380d;
        }

        .alert-story-main {
            flex: 1;
        }

        .alert-story-link {
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 600;
        }

        .alert-story-note {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 0.2rem;
        }

        .alert-action {
            color: var(--accent);
            font-weight: 600;
            text-decoration: none;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            white-space: nowrap;
        }

        .task-list {
            animation: fadeIn 0.8s ease-out 0.6s both;
        }

        .task-item {
            background: var(--bg-secondary);
            border-left: 4px solid var(--border);
            padding: 1.25rem 1.5rem;
            margin-bottom: 0.9rem;
            transition: all 0.3s;
            animation: slideUp 0.6s ease-out both;
        }

        .task-item:nth-child(1) { animation-delay: 0.7s; }
        .task-item:nth-child(2) { animation-delay: 0.8s; }
        .task-item:nth-child(3) { animation-delay: 0.9s; }
        .task-item:nth-child(4) { animation-delay: 1s; }
        .task-item:nth-child(5) { animation-delay: 1.1s; }

        .task-item:hover {
            transform: translateX(4px);
            box-shadow: -6px 0 18px var(--shadow);
        }

        /* Standard Jira priorities */
        .task-item.priority-blocker,
        .task-item.priority-highest {
            border-left-color: #a8071a;
        }

        .task-item.priority-critical,
        .task-item.priority-high {
            border-left-color: #d4380d;
        }

        .task-item.priority-major,
        .task-item.priority-medium {
            border-left-color: #faad14;
        }

        .task-item.priority-minor,
        .task-item.priority-low {
            border-left-color: #bfbfbf;
        }

        .task-item.priority-trivial,
        .task-item.priority-lowest {
            border-left-color: #d9d9d9;
        }

        .task-item.status-done {
            background: #f6ffed;
            border-left-color: #52c41a;
        }

        .task-item.status-killed {
            background: #f5f5f5;
            border-left-color: #d9d9d9;
            opacity: 0.6;
        }

        .task-item.status-killed .task-title,
        .task-item.status-killed .task-inline-meta,
        .task-item.status-killed .task-meta {
            color: #8c8c8c;
        }

        .task-item.status-killed .task-priority {
            color: #8c8c8c;
            border-color: #d9d9d9;
        }

        .task-item.status-killed:hover {
            opacity: 0.75;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .task-remove {
            position: absolute;
            top: -1.1rem;
            right: -1.1rem;
            width: 1.5rem;
            height: 1.5rem;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s;
            padding: 0;
            margin: 0;
            border-radius: 2px;
        }

        .task-item:hover .task-remove {
            opacity: 1;
        }

        .task-remove:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: none;
        }

        .task-headline {
            display: flex;
            align-items: baseline;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .task-title {
            font-size: 1.05rem;
            font-weight: 400;
            line-height: 1.25;
        }

        .task-title a {
            color: inherit;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.2s;
        }

        .task-title a:hover {
            border-bottom-color: var(--accent);
        }

        .task-inline-meta {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.68rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .task-key-link {
            color: inherit;
            text-decoration: none;
            border-bottom: 1px solid transparent;
        }

        .task-key-link:hover {
            border-bottom-color: var(--accent);
        }

        .task-inline-sp {
            color: #d48806;
            font-weight: 600;
        }

        .task-headline .task-checkbox {
            margin-left: 0.2rem;
        }

        .task-priority {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            padding: 0.2rem 0.6rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        /* Standard Jira priorities */
        .task-priority.blocker,
        .task-priority.highest {
            color: #a8071a;
            border-color: #a8071a;
            background: #fff1f0;
        }

        .task-priority.critical,
        .task-priority.high {
            color: #d4380d;
            border-color: #d4380d;
            background: #fff2e8;
        }

        .task-priority.major,
        .task-priority.medium {
            color: #d48806;
            border-color: #d48806;
            background: #fffbe6;
        }

        .task-priority.minor,
        .task-priority.low {
            color: #8c8c8c;
            border-color: #bfbfbf;
            background: #fafafa;
        }

        .task-priority.trivial,
        .task-priority.lowest {
            color: #bfbfbf;
            border-color: #d9d9d9;
            background: #fafafa;
        }

        .task-meta {
            display: flex;
            gap: 1rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            flex-wrap: wrap;
        }

        .task-team {
            background: #f6f4ff;
            color: #4b3fb0;
            padding: 0.18rem 0.45rem;
            border-radius: 2px;
            border: 1px solid #c7b8ff;
        }

        .task-assignee {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            color: var(--text-secondary);
        }

        .task-assignee-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            color: #8c8c8c;
        }

        .task-assignee-icon svg {
            width: 14px;
            height: 14px;
        }

        .epic-block {
            border: 1px solid var(--border);
            margin-bottom: 1.1rem;
            background: var(--bg-secondary);
            padding: 0.75rem;
        }

        .epic-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            padding: 0.5rem 0;
            margin-bottom: 0.75rem;
            position: sticky;
            top: calc(var(--planning-offset, 0px) + 0.5rem);
            background: var(--bg-secondary);
            z-index: 3;
            box-shadow: 0 1px 0 var(--border);
        }

        .epic-title {
            font-size: 1.1rem;
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .epic-title-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .epic-link {
            display: inline-flex;
            align-items: baseline;
            gap: 0.45rem;
            color: inherit;
            text-decoration: none;
        }

        .epic-link:hover {
            text-decoration: underline;
            text-decoration-thickness: 1px;
            text-underline-offset: 3px;
        }

        .epic-name {
            font-weight: 600;
        }

        .epic-key {
            font-family: 'IBM Plex Mono', monospace;
            color: var(--text-secondary);
            font-size: 0.9rem;
            letter-spacing: 0.02em;
        }

        .epic-icon,
        .story-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .epic-icon svg {
            width: 18px;
            height: 18px;
        }

        .story-icon svg {
            width: 16px;
            height: 16px;
        }

        .epic-title small {
            font-family: 'IBM Plex Mono', monospace;
            color: var(--text-secondary);
            letter-spacing: 0.05em;
        }

	        .epic-meta {
	            font-family: 'IBM Plex Mono', monospace;
	            color: var(--text-secondary);
	            text-transform: uppercase;
	            letter-spacing: 0.05em;
	            display: flex;
	            align-items: center;
	            gap: 0.65rem;
	        }

	        .epic-assignee {
	            text-transform: none;
	            letter-spacing: 0;
	        }

        .team-group {
            margin-bottom: 1rem;
        }

        .team-heading {
            font-family: 'IBM Plex Mono', monospace;
            color: #2f54eb;
            margin-bottom: 0.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .task-meta > span:not(.task-status) {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }


        .task-updated {
            color: var(--text-secondary);
        }

        .task-status {
            padding: 0.2rem 0.6rem;
            border-radius: 2px;
            font-weight: 500;
        }

        .task-status.killed {
            background: #595959;
            color: white;
        }

        .task-status.done {
            background: #52c41a;
            color: white;
        }

        .task-status.in-progress {
            background: #69c0ff;
            color: white;
        }

        .task-status.to-do {
            background: #597ef7;
            color: white;
        }

        .task-status.blocked {
            background: #ff4d4f;
            color: white;
        }

        .task-status.accepted {
            background: #597ef7;
            color: white;
        }

        .task-status.pending {
            background: #597ef7;
            color: white;
        }

        .task-status.postponed {
            background: #fa8c16;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 4rem 0;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--text-secondary);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        .error {
            background: #fff2e8;
            border: 1px solid #ffbb96;
            padding: 1.5rem;
            margin-bottom: 2rem;
            color: var(--accent);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 0.6rem;
            text-align: center;
            animation: slideUp 0.6s ease-out both;
            cursor: pointer;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(89, 126, 247, 0.2);
            background: #f6f8ff;
            border-color: #91a7ff;
        }

        .stat-card.active {
            border-color: #597ef7;
            box-shadow: 0 0 0 2px rgba(89, 126, 247, 0.25);
            background: #f0f5ff;
        }

        .stat-card:nth-child(1) { animation-delay: 0.5s; }
        .stat-card:nth-child(2) { animation-delay: 0.6s; }
        .stat-card:nth-child(3) { animation-delay: 0.7s; }
        .stat-card:nth-child(4) { animation-delay: 0.8s; }
        .stat-card:nth-child(5) { animation-delay: 0.9s; }

        .stat-value {
            font-size: 1.35rem;
            font-weight: 300;
            color: var(--accent);
            line-height: 1;
            margin-bottom: 0.25rem;
        }

        .stat-card.total .stat-value {
            color: var(--text-primary);
        }

        .stat-card.done .stat-value {
            color: #52c41a;
        }

        .stat-card.in-progress .stat-value {
            color: #597ef7;
        }

        .stat-card.todo-accepted .stat-value {
            color: #9254de;
        }

        .stat-card.high-priority .stat-value {
            color: #d4380d;
        }

        .stat-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state h2 {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 1rem;
        }

        /* Sprint Planning Styles */
        .planning-button {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: auto;
        }

        .planning-button:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
            transform: none;
        }

        .planning-button.active {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        .planning-button svg {
            width: 0.75rem;
            height: 0.75rem;
            transition: transform 0.3s;
        }

        .planning-button.active svg {
            transform: rotate(180deg);
        }

        .planning-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            margin-top: 1rem;
            margin-bottom: 1rem;
            overflow: hidden;
            max-height: 0;
            padding: 0 1rem;
            opacity: 0;
            transition: max-height 0.6s ease, opacity 0.6s ease, padding 0.6s ease;
        }

        .planning-panel.open {
            max-height: 1600px;
            padding: 0.75rem;
            opacity: 1;
            overflow: visible;
            position: sticky;
            top: 0.5rem;
            z-index: 4;
            box-shadow: 0 8px 24px rgba(26, 26, 26, 0.08);
        }

        .capacity-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 0.6rem 0.75rem;
            margin: 0 0 1rem;
        }

        .capacity-grid-wrapper {
            max-height: 520px;
            overflow-y: auto;
            padding-right: 0.25rem;
        }

        .capacity-header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .capacity-title {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        .capacity-subtitle {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.6rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .capacity-grid {
            display: grid;
            gap: 0.2rem;
        }

        .capacity-row {
            display: grid;
            grid-template-columns:
                minmax(160px, 1.4fr)
                minmax(112px, 0.6fr) minmax(70px, 0.5fr) minmax(70px, 0.5fr)
                minmax(112px, 0.6fr) minmax(70px, 0.5fr) minmax(70px, 0.5fr)
                minmax(112px, 0.6fr) minmax(70px, 0.5fr) minmax(70px, 0.5fr);
            align-items: center;
            padding: 0.08rem 0;
        }

        .capacity-group-row {
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.25rem;
            margin-bottom: 0.1rem;
        }

        .capacity-group-cell {
            grid-column: span 3;
            text-align: center;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        .capacity-group-cell.product {
            grid-column: 2 / span 3;
        }

        .capacity-group-cell.tech {
            grid-column: 5 / span 3;
        }

        .capacity-group-cell.total {
            grid-column: 8 / span 3;
        }

        .capacity-cell {
            padding: 0.3rem 0.4rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-primary);
        }

        .capacity-cell.metric {
            border-left: 1px solid var(--border);
            text-align: right;
        }

        .capacity-cell.product-col {
            background: #fff7e6;
        }

        .capacity-cell.tech-col {
            background: #e6f7ff;
        }

        .capacity-cell.total-col {
            background: #f6ffed;
        }

        .capacity-cell.divider-right {
            border-right: 2px solid var(--border);
        }

        .capacity-header-row .capacity-cell {
            font-size: 0.58rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .capacity-divider {
            border-top: 1px dashed var(--border);
        }

        .capacity-team {
            font-family: 'IBM Plex Mono', monospace;
            color: var(--text-primary);
        }


        .capacity-total {
            font-weight: 500;
        }

        .capacity-empty {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
            padding: 0.25rem 0;
        }

        .capacity-scroll-hint {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-secondary);
            margin-top: 0.3rem;
            text-align: right;
        }

        .metric-value {
            font-weight: 600;
        }

        .metric-muted {
            color: var(--muted);
        }

        .metric-accepted {
            color: var(--good);
        }

        .metric-warn {
            color: var(--warn);
        }

        .postponed-cell {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
        }

        .postponed-link {
            opacity: 0.6;
            font-size: 0.85em;
            text-decoration: none;
            color: inherit;
            transition: opacity 0.2s ease, color 0.2s ease;
        }

        .postponed-cell:hover .postponed-link {
            opacity: 1;
            color: var(--accent);
        }

        .todo-link {
            opacity: 0.6;
            font-size: 0.85em;
            text-decoration: none;
            color: inherit;
            transition: opacity 0.2s ease, color 0.2s ease;
        }

        .postponed-cell:hover .todo-link {
            opacity: 1;
            color: var(--accent);
        }

        .accepted-link {
            opacity: 0.6;
            font-size: 0.85em;
            text-decoration: none;
            color: inherit;
            transition: opacity 0.2s ease, color 0.2s ease;
        }

        .postponed-cell:hover .accepted-link {
            opacity: 1;
            color: var(--accent);
        }

        .planning-stats {
            display: flex;
            gap: 3rem;
            align-items: center;
            justify-content: space-between;
            font-family: 'IBM Plex Mono', monospace;
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .planning-stats.compact {
            gap: 1rem;
            font-size: 0.7rem;
            justify-content: flex-start;
        }

        .planning-stats.compact .planning-stat-label {
            font-size: 0.7rem;
            letter-spacing: 0.04em;
        }

        .planning-stats.compact .planning-stat-value {
            font-size: 0.7rem;
        }

        .planning-stat-separator {
            margin-left: 0.4rem;
            color: var(--text-secondary);
        }

        .team-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .team-stat-card {
            background: #fff;
            border: 1px solid var(--border);
            padding: 0.6rem 0.75rem;
            text-align: center;
            box-shadow: 0 6px 16px var(--shadow);
        }

        .team-stat-value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .team-stat-label {
            margin-top: 0.25rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        .uncheck-button {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            padding: 0.4rem 1rem;
            font-size: 0.7rem;
            margin: 0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .uncheck-button:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: none;
        }

        .uncheck-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .uncheck-button:disabled:hover {
            background: transparent;
            color: var(--text-secondary);
            border-color: var(--border);
        }

        .planning-action-button {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            padding: 0.4rem 1rem;
            font-size: 0.7rem;
            margin: 0;
            cursor: pointer;
            transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .planning-action-button:hover {
            background: rgba(22, 119, 255, 0.08);
            color: var(--text);
            border-color: rgba(22, 119, 255, 0.25);
            transform: none;
        }

        .planning-action-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .planning-action-button:disabled:hover {
            background: transparent;
            color: var(--text-secondary);
            border-color: var(--border);
        }

        .planning-action-button svg {
            width: 1rem;
            height: 1rem;
        }

        .planning-icon-button {
            width: 2.05rem;
            height: 2.05rem;
            padding: 0;
            border-radius: 999px;
            justify-content: center;
            gap: 0;
        }

        .planning-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: nowrap;
            white-space: nowrap;
        }

        .planning-stat {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }

        .planning-stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .planning-stat-value {
            font-size: 0.875rem;
            font-weight: 500;
            color: #d48806;
            line-height: 1;
        }

        .task-checkbox-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .task-checkbox {
            width: 0.75rem;
            height: 0.75rem;
            min-width: 0.75rem;
            min-height: 0.75rem;
            cursor: pointer;
            appearance: none;
            border: 1.5px solid var(--border);
            border-radius: 2px;
            background: var(--bg-secondary);
            transition: all 0.2s;
            position: relative;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .task-checkbox:hover {
            border-color: var(--text-secondary);
        }

        .task-checkbox:checked {
            background: #52c41a;
            border-color: #52c41a;
        }

        .task-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.55rem;
            font-weight: bold;
            line-height: 1;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Backend server URL
        const DEFAULT_BACKEND_PORT = 5050;
        const BACKEND_URL = window.BACKEND_URL ||
            (window.location.protocol.startsWith('http')
                ? `${window.location.protocol}//${window.location.hostname}:${DEFAULT_BACKEND_PORT}`
                : `http://localhost:${DEFAULT_BACKEND_PORT}`);

        // Get current quarter in format "2025Q1"
        function getCurrentQuarter() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1; // 1-12
            const quarter = Math.ceil(month / 3);
            return `${year}Q${quarter}`;
        }

        // Cookie helper functions
        function setCookie(name, value, days = 365) {
            const expires = new Date();
            expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
            document.cookie = `${name}=${JSON.stringify(value)};expires=${expires.toUTCString()};path=/`;
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) {
                    try {
                        return JSON.parse(c.substring(nameEQ.length, c.length));
                    } catch (e) {
                        return null;
                    }
                }
            }
            return null;
        }

        const UI_PREFS_KEY = 'jira_dashboard_ui_prefs_v1';

        function loadUiPrefs() {
            try {
                const raw = window.localStorage.getItem(UI_PREFS_KEY);
                if (!raw) return null;
                return JSON.parse(raw);
            } catch (e) {
                return null;
            }
        }

        function saveUiPrefs(prefs) {
            try {
                window.localStorage.setItem(UI_PREFS_KEY, JSON.stringify(prefs));
            } catch (e) {
                // ignore
            }
        }

	        function App() {
	            const savedPrefsRef = useRef(loadUiPrefs() || {});
	            const [productTasks, setProductTasks] = useState([]);
	            const [techTasks, setTechTasks] = useState([]);
	            const [productEpicsInScope, setProductEpicsInScope] = useState([]);
	            const [techEpicsInScope, setTechEpicsInScope] = useState([]);
	            const [techLoaded, setTechLoaded] = useState(false);
	            const [loading, setLoading] = useState(false);
	            const [error, setError] = useState('');
            const [showKilled, setShowKilled] = useState(savedPrefsRef.current.showKilled ?? false);
            const [showDone, setShowDone] = useState(savedPrefsRef.current.showDone ?? true);
            const [showTech, setShowTech] = useState(savedPrefsRef.current.showTech ?? true);
            const [showProduct, setShowProduct] = useState(savedPrefsRef.current.showProduct ?? true);
            const [sprintName, setSprintName] = useState('Sprint');
            const [statusFilter, setStatusFilter] = useState(savedPrefsRef.current.statusFilter ?? null); // null = show all, 'in-progress', 'todo-accepted', 'done', 'high-priority'
            const [selectedSprint, setSelectedSprint] = useState(savedPrefsRef.current.selectedSprint ?? null); // Sprint ID
            const [availableSprints, setAvailableSprints] = useState([]);
            const [sprintsLoading, setSprintsLoading] = useState(true);
            const [jiraUrl, setJiraUrl] = useState('');
            const [selectedTasks, setSelectedTasks] = useState(() => {
                // Load from cookie on init
                return getCookie('selectedTasks') || {};
            });
            const [showPlanning, setShowPlanning] = useState(savedPrefsRef.current.showPlanning ?? false);
            const [searchQuery, setSearchQuery] = useState(savedPrefsRef.current.searchQuery ?? '');
            const [selectedTeam, setSelectedTeam] = useState(savedPrefsRef.current.selectedTeam ?? 'all');
            const [epicDetails, setEpicDetails] = useState({});
            const [planningOffset, setPlanningOffset] = useState(0);
            const planningPanelRef = useRef(null);
	            const [showMissingAlert, setShowMissingAlert] = useState(savedPrefsRef.current.showMissingAlert ?? true);
	            const [showBlockedAlert, setShowBlockedAlert] = useState(savedPrefsRef.current.showBlockedAlert ?? true);
	            const [showNoEpicAlert, setShowNoEpicAlert] = useState(savedPrefsRef.current.showNoEpicAlert ?? true);
	            const [showEmptyEpicAlert, setShowEmptyEpicAlert] = useState(savedPrefsRef.current.showEmptyEpicAlert ?? true);
	            const [showDoneEpicAlert, setShowDoneEpicAlert] = useState(savedPrefsRef.current.showDoneEpicAlert ?? true);
	            const epicOrderRef = useRef({});
	            const epicOrderCounterRef = useRef(0);

            useEffect(() => {
                // Load config and sprints on component mount
                loadConfig();
                loadSprints();
            }, []);

            const normalizeStatus = (status) => {
                return (status || '').toLowerCase().replace(/\s+/g, ' ').trim();
            };

            useEffect(() => {
                if (!showPlanning) {
                    setPlanningOffset(0);
                }
            }, [showPlanning]);

            useEffect(() => {
                // Save selected tasks to cookie whenever they change
                setCookie('selectedTasks', selectedTasks);
            }, [selectedTasks]);

	            useEffect(() => {
	                saveUiPrefs({
	                    selectedSprint,
	                    selectedTeam,
	                    showPlanning,
	                    showTech,
	                    showProduct,
	                    showDone,
	                    showKilled,
	                    statusFilter,
	                    searchQuery,
	                    showMissingAlert,
	                    showBlockedAlert,
	                    showNoEpicAlert,
	                    showEmptyEpicAlert,
	                    showDoneEpicAlert
	                });
	            }, [
	                selectedSprint,
	                selectedTeam,
	                showPlanning,
	                showTech,
	                showProduct,
	                showDone,
	                showKilled,
	                statusFilter,
	                searchQuery,
	                showMissingAlert,
	                showBlockedAlert,
	                showNoEpicAlert,
	                showEmptyEpicAlert,
	                showDoneEpicAlert
	            ]);

            const loadConfig = async () => {
                try {
                    const response = await fetch(`${BACKEND_URL}/api/config`);
                    if (response.ok) {
                        const config = await response.json();
                        setJiraUrl(config.jiraUrl || '');
                    }
                } catch (err) {
                    console.error('Failed to load config:', err);
                }
            };

	            useEffect(() => {
	                // Load tasks when sprint changes (team is filtered client-side)
	                if (selectedSprint !== null) {
	                    setEpicDetails({});
	                    setProductEpicsInScope([]);
	                    setTechEpicsInScope([]);
	                    loadProductTasks();
	                    loadTechTasks();
	                }
	            }, [selectedSprint]);

            useEffect(() => {
                setTechLoaded(false);
            }, [selectedSprint]);

            useEffect(() => {
                epicOrderRef.current = {};
                epicOrderCounterRef.current = 0;
            }, [selectedSprint]);

            const loadSprints = async (forceRefresh = false) => {
                setSprintsLoading(true);
                try {
                    const params = new URLSearchParams({
                        t: Date.now().toString()
                    });
                    if (forceRefresh) {
                        params.append('refresh', 'true');
                    }
                    const response = await fetch(`${BACKEND_URL}/api/sprints?${params}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        cache: 'no-cache'
                    });

                    if (!response.ok) {
                        throw new Error(`Error ${response.status}`);
                    }

                    const data = await response.json();
                    const sprints = data.sprints || [];
                    setAvailableSprints(sprints);

                    const preferredSprintId = savedPrefsRef.current.selectedSprint;
                    const preferredSprint = preferredSprintId ? sprints.find(s => String(s.id) === String(preferredSprintId)) : null;

                    if (preferredSprint) {
                        setSelectedSprint(preferredSprint.id);
                        setSprintName(preferredSprint.name);
                    } else {
                        // Auto-select current quarter if available
                        const currentQuarter = getCurrentQuarter();
                        const currentSprint = sprints.find(s => s.name === currentQuarter);
                        if (currentSprint) {
                            setSelectedSprint(currentSprint.id);
                            setSprintName(currentSprint.name);
                        } else if (sprints.length > 0) {
                            // If current quarter not found, select the last sprint
                            const lastSprint = sprints[sprints.length - 1];
                            setSelectedSprint(lastSprint.id);
                            setSprintName(lastSprint.name);
                        }
                    }

                    console.log('✅ Loaded sprints:', sprints);
                } catch (err) {
                    console.error('Failed to load sprints:', err);
                    setError(`Failed to load sprints: ${err.message}`);
                } finally {
                    setSprintsLoading(false);
                }
            };

            const priorityOrder = {
                'Blocker': 1,
                'Highest': 1,
                'Critical': 2,
                'High': 2,
                'Major': 3,
                'Medium': 3,
                'Minor': 4,
                'Low': 4,
                'Trivial': 5,
                'Lowest': 5
            };

            const getTeamInfo = (task) => {
                const team = task.fields?.team;
                const teamName = task.fields?.teamName || team?.name || team?.displayName || team?.teamName || 'Unknown Team';
                const teamId = task.fields?.teamId || team?.id || team?.teamId || team?.key || teamName;
                return { id: teamId, name: teamName };
            };

	            const fetchTasks = async (project) => {
	                setLoading(true);
	                setError('');

                try {
                    // Add cache busting parameter and sprint parameter
                    const params = new URLSearchParams({
                        t: Date.now().toString(),
                        sprint: selectedSprint || '',
                        // always pull all teams; filtering happens client-side so capacity table can show every team
                        team: 'all',
                        project: project || 'all'
                    });
                    const response = await fetch(`${BACKEND_URL}/api/tasks-with-team-name?${params}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        cache: 'no-cache'
                    });

                    console.log('Response status:', response.status);
                    console.log('Response ok:', response.ok);

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ 
                            error: `HTTP ${response.status}` 
                        }));
                        console.error('Error data:', errorData);
                        throw new Error(errorData.error || `Error ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('Success! Received data:', data);

                    // Sort by priority
                    const sortedTasks = (data.issues || []).sort((a, b) => {
                        const priorityA = priorityOrder[a.fields.priority?.name] || 999;
                        const priorityB = priorityOrder[b.fields.priority?.name] || 999;
                        return priorityA - priorityB;
                    });

	                    setEpicDetails(prev => ({ ...prev, ...(data.epics || {}) }));
	                    if (project === 'product') {
	                        setProductEpicsInScope(data.epicsInScope || []);
	                    } else if (project === 'tech') {
	                        setTechEpicsInScope(data.epicsInScope || []);
	                    }
	                    return sortedTasks;
	                } catch (err) {
                    const errorMsg = `Failed to load tasks: ${err.message}. Make sure the Python server is running on ${BACKEND_URL}`;
                    setError(errorMsg);
                    console.error('Full error details:', err);
                    return [];
                } finally {
                    setLoading(false);
                }
            };

            const loadProductTasks = async () => {
                const data = await fetchTasks('product');
                setProductTasks(data);
            };

            const loadTechTasks = async () => {
                const data = await fetchTasks('tech');
                setTechTasks(data);
                setTechLoaded(true);
            };

	            const tasks = showTech ? [...productTasks, ...techTasks] : [...productTasks];
	            const capacityTasks = [...productTasks, ...techTasks];
	            const epicsInScope = React.useMemo(() => {
	                const seen = new Set();
	                const merged = [...productEpicsInScope, ...techEpicsInScope].filter(epic => {
	                    if (!epic?.key) return false;
	                    if (seen.has(epic.key)) return false;
	                    seen.add(epic.key);
	                    return true;
	                });
	                return merged;
	            }, [productEpicsInScope, techEpicsInScope]);
            const killedTasks = tasks.filter(t => t.fields.status?.name === 'Killed');
            const doneTasks = tasks.filter(t => t.fields.status?.name === 'Done');
            const techTasksCount = techTasks.length;
            const productTasksCount = productTasks.length;

            const teamOptions = ['all', ...new Set(capacityTasks.map(t => getTeamInfo(t).id || 'unknown'))]
                .map(id => ({ id, name: id === 'all' ? 'All Teams' : getTeamInfo(capacityTasks.find(t => getTeamInfo(t).id === id) || {}).name }))
                .filter((team, index, arr) => arr.findIndex(t => t.id === team.id) === index);

            const visibleTasks = tasks.filter(task => {
                // Filter by search query
                if (searchQuery.trim() !== '') {
                    const summary = task.fields.summary?.toLowerCase() || '';
                    const query = searchQuery.toLowerCase();
                    if (!summary.includes(query)) {
                        return false;
                    }
                }

                // Filter by Team
                if (selectedTeam !== 'all') {
                    const teamInfo = getTeamInfo(task);
                    if (teamInfo.id !== selectedTeam) {
                        return false;
                    }
                }

                // Filter by Killed status
                if (!showKilled && task.fields.status?.name === 'Killed') {
                    return false;
                }

                // Filter by Done status
                if (!showDone && task.fields.status?.name === 'Done') {
                    return false;
                }

                // Filter by task type
                const isTech = task.key.startsWith('TECH-');
                if (isTech && !showTech) {
                    return false;
                }
                if (!isTech && !showProduct) {
                    return false;
                }

                // Filter by status (from clickable elements)
                if (statusFilter === 'in-progress') {
                    return task.fields.status?.name === 'In Progress';
                } else if (statusFilter === 'todo-accepted') {
                    const status = task.fields.status?.name;
                    return status === 'To Do' || status === 'Pending' || status === 'Accepted';
                } else if (statusFilter === 'done') {
                    return task.fields.status?.name === 'Done';
                } else if (statusFilter === 'high-priority') {
                    const priority = task.fields.priority?.name;
                    return priority === 'Blocker' || priority === 'Highest' ||
                           priority === 'Critical' || priority === 'High';
                }

                return true;
            });

            const groupTasksByEpic = (taskList) => {
                const grouped = {};
                taskList.forEach(task => {
                    const epicKey = task.fields.epicKey || 'NO_EPIC';
                    if (!grouped[epicKey]) {
                        if (epicOrderRef.current[epicKey] === undefined) {
                            epicOrderRef.current[epicKey] = epicOrderCounterRef.current++;
                        }
                        grouped[epicKey] = {
                            epic: epicDetails[epicKey] || null,
                            key: epicKey,
                            tasks: [],
                            storyPoints: 0,
                            parentSummary: task.fields.parentSummary || null
                        };
                    }

                    grouped[epicKey].tasks.push(task);
                    const sp = parseFloat(task.fields.customfield_10004 || 0);
                    if (!Number.isNaN(sp)) {
                        grouped[epicKey].storyPoints += sp;
                    }
                    if (!grouped[epicKey].parentSummary && task.fields.parentSummary) {
                        grouped[epicKey].parentSummary = task.fields.parentSummary;
                    }
                });
                return grouped;
            };

            const epicGroups = Object.values(groupTasksByEpic(visibleTasks))
                .sort((a, b) => (epicOrderRef.current[a.key] ?? 999999) - (epicOrderRef.current[b.key] ?? 999999));

            const highPriorityCount = tasks.filter(t => {
                const priority = t.fields.priority?.name;
                return priority === 'Blocker' || priority === 'Highest' ||
                       priority === 'Critical' || priority === 'High';
            }).length;

            const doneTasksCount = tasks.filter(t =>
                t.fields.status?.name === 'Done'
            ).length;

            const inProgressTasksCount = tasks.filter(t =>
                t.fields.status?.name === 'In Progress'
            ).length;

            const todoAcceptedTasksCount = tasks.filter(t => {
                const status = t.fields.status?.name;
                return status === 'To Do' || status === 'Pending' || status === 'Accepted';
            }).length;

            const removeTask = (taskKey) => {
                setProductTasks(prev => prev.filter(t => t.key !== taskKey));
                setTechTasks(prev => prev.filter(t => t.key !== taskKey));
            };

            const toggleTaskSelection = (taskKey) => {
                setSelectedTasks(prev => {
                    const newSelected = { ...prev };
                    if (newSelected[taskKey]) {
                        delete newSelected[taskKey];
                    } else {
                        newSelected[taskKey] = true;
                    }
                    return newSelected;
                });
            };

            const clearSelectedTasks = () => {
                setSelectedTasks({});
            };

            const selectPlanningTasksByStatus = (statuses) => {
                const allowed = new Set((statuses || []).map(normalizeStatus));
                setSelectedTasks(() => {
                    const next = {};
                    visibleTasks.forEach(task => {
                        const status = normalizeStatus(task.fields.status?.name);
                        if (allowed.has(status)) {
                            next[task.key] = true;
                        }
                    });
                    return next;
                });
            };

            // Calculate sum of Story Points for selected tasks
            const calculateSelectedSP = () => {
                let sum = 0;
                visibleTasks.forEach(task => {
                    if (selectedTasks[task.key]) {
                        const sp = task.fields.customfield_10004;
                        if (sp) {
                            sum += parseFloat(sp);
                        }
                    }
                });
                return sum;
            };

            const selectedTasksList = visibleTasks.filter(task => selectedTasks[task.key]);
            const selectedSP = selectedTasksList.reduce((sum, task) => {
                const sp = parseFloat(task.fields.customfield_10004 || 0);
                return sum + (Number.isNaN(sp) ? 0 : sp);
            }, 0);
            const selectedCount = selectedTasksList.length;

            const selectedTeamStats = selectedTasksList.reduce((acc, task) => {
                const teamInfo = getTeamInfo(task);
                const sp = parseFloat(task.fields.customfield_10004 || 0);
                if (!acc[teamInfo.id]) {
                    acc[teamInfo.id] = { name: teamInfo.name, storyPoints: 0 };
                }
                acc[teamInfo.id].storyPoints += sp;
                return acc;
            }, {});

            const selectedProjectStats = selectedTasksList.reduce((acc, task) => {
                const projectKey = task.key.split('-')[0];
                const sp = parseFloat(task.fields.customfield_10004 || 0);
                if (!acc[projectKey]) {
                    acc[projectKey] = 0;
                }
                acc[projectKey] += sp;
                return acc;
            }, {});

            const selectedProjectEntries = Object.entries(selectedProjectStats)
                .map(([id, storyPoints]) => ({ id, name: id, storyPoints }))
                .sort((a, b) => {
                    const order = (key) => {
                        if (key === 'PRODUCT') return 0;
                        if (key === 'TECH') return 1;
                        return 99;
                    };
                    const diff = order(a.id) - order(b.id);
                    if (diff !== 0) return diff;
                    return a.name.localeCompare(b.name);
                });

            const teamCapacityStats = capacityTasks.reduce((acc, task) => {
                const status = normalizeStatus(task.fields.status?.name);
                const sp = parseFloat(task.fields.customfield_10004 || 0);
                if (!sp) {
                    return acc;
                }

                const teamInfo = getTeamInfo(task);
                if (!acc[teamInfo.id]) {
                    acc[teamInfo.id] = {
                        name: teamInfo.name,
                        product: { todoPending: 0, accepted: 0, postponed: 0 },
                        tech: { todoPending: 0, accepted: 0, postponed: 0 }
                    };
                }

                const bucket = task.key.startsWith('TECH-') ? 'tech' : 'product';
                if (status === 'to do' || status === 'pending') {
                    acc[teamInfo.id][bucket].todoPending += sp;
                }
                if (status === 'accepted') {
                    acc[teamInfo.id][bucket].accepted += sp;
                }
                if (status === 'postponed') {
                    acc[teamInfo.id][bucket].postponed += sp;
                }

                return acc;
            }, {});

            const teamCapacityEntries = Object.entries(teamCapacityStats)
                .map(([id, info]) => ({
                    id,
                    name: info.name,
                    product: info.product,
                    tech: info.tech,
                    total: {
                        todoPending: info.product.todoPending + info.tech.todoPending,
                        accepted: info.product.accepted + info.tech.accepted,
                        postponed: info.product.postponed + info.tech.postponed
                    }
                }))
                .sort((a, b) => a.name.localeCompare(b.name));

            const displayedTeamCapacityEntries = selectedTeam !== 'all'
                ? teamCapacityEntries.filter(entry => entry.id === selectedTeam)
                : teamCapacityEntries;

            const capacityTeamIds = selectedTeam !== 'all'
                ? [selectedTeam]
                : teamCapacityEntries.map(entry => entry.id);

            const selectedTeamEntries = displayedTeamCapacityEntries.map((team) => ({
                id: team.id,
                name: team.name,
                storyPoints: selectedTeamStats[team.id]?.storyPoints || 0
            }));

            const capacityTotals = displayedTeamCapacityEntries.reduce((acc, info) => {
                acc.product.todoPending += info.product.todoPending;
                acc.product.accepted += info.product.accepted;
                acc.product.postponed += info.product.postponed;
                acc.tech.todoPending += info.tech.todoPending;
                acc.tech.accepted += info.tech.accepted;
                acc.tech.postponed += info.tech.postponed;
                acc.total.todoPending += info.total.todoPending;
                acc.total.accepted += info.total.accepted;
                acc.total.postponed += info.total.postponed;
                return acc;
            }, {
                product: { todoPending: 0, accepted: 0, postponed: 0 },
                tech: { todoPending: 0, accepted: 0, postponed: 0 },
                total: { todoPending: 0, accepted: 0, postponed: 0 }
            });

            const showTotalsRow = displayedTeamCapacityEntries.length > 1;

            const formatCapacityValue = (value) => {
                const num = Number(value || 0);
                return num.toFixed(1);
            };

            const getMetricClass = (value, type, acceptedValue) => {
                const num = Number(value || 0);
                if (num === 0) {
                    return 'metric-value metric-muted';
                }
                if (type === 'accepted') {
                    return 'metric-value metric-accepted';
                }
                if (type === 'todo' && acceptedValue !== undefined && acceptedValue < num) {
                    return 'metric-value metric-warn';
                }
                return 'metric-value';
            };

            const buildTeamStatusLink = ({ teamId, teamIds, projectName, projectNames, statuses }) => {
                const ids = teamIds || (teamId ? [teamId] : []);
                if (!jiraUrl || !ids.length) return '';
                const clauses = [];
                const projects = projectNames || (projectName ? [projectName] : []);
                if (projects.length === 1) {
                    clauses.push(`project = "${projects[0]}"`);
                } else if (projects.length > 1) {
                    const quoted = projects.map(p => `"${p}"`).join(', ');
                    clauses.push(`project in (${quoted})`);
                }
                if (ids.length === 1) {
                    clauses.push(`"Team[Team]" = "${ids[0]}"`);
                } else {
                    const quotedTeams = ids.map(id => `"${id}"`).join(', ');
                    clauses.push(`"Team[Team]" in (${quotedTeams})`);
                }
                if (selectedSprint) {
                    clauses.push(`Sprint = ${selectedSprint}`);
                }
                if (statuses && statuses.length) {
                    if (statuses.length === 1) {
                        clauses.push(`status = "${statuses[0]}"`);
                    } else {
                        const quoted = statuses.map(s => `"${s}"`).join(', ');
                        clauses.push(`status in (${quoted})`);
                    }
                }
                const jql = encodeURIComponent(clauses.join(' AND '));
                return `${jiraUrl}/issues/?jql=${jql}`;
            };

            const buildPostponedLink = ({ teamId, teamIds, projectName, projectNames }) => {
                return buildTeamStatusLink({ teamId, teamIds, projectName, projectNames, statuses: ['Postponed'] });
            };

            const buildTodoPendingLink = ({ teamId, teamIds, projectName, projectNames }) => {
                return buildTeamStatusLink({ teamId, teamIds, projectName, projectNames, statuses: ['To Do', 'Pending'] });
            };

            const buildAcceptedLink = ({ teamId, teamIds, projectName, projectNames }) => {
                return buildTeamStatusLink({ teamId, teamIds, projectName, projectNames, statuses: ['Accepted'] });
            };

            const hasStoryPoints = (task) => {
                const sp = task.fields.customfield_10004;
                if (sp === null || sp === undefined || sp === '') {
                    return false;
                }
                const numeric = parseFloat(sp);
                return !Number.isNaN(numeric) && numeric > 0;
            };

            const isExcludedStatus = (status) => status === 'killed' || status === 'postponed';

            const missingInfoTasks = visibleTasks.filter(task => {
                const status = normalizeStatus(task.fields.status?.name);
                return !isExcludedStatus(status) && !hasStoryPoints(task);
            });

            const blockedTasks = visibleTasks.filter(task => {
                const status = normalizeStatus(task.fields.status?.name);
                if (!status) return false;
                if (isExcludedStatus(status) || status === 'done') return false;
                return status.includes('blocked');
            });

            const noEpicTasks = visibleTasks.filter(task => {
                const status = normalizeStatus(task.fields.status?.name);
                if (!status) return false;
                if (isExcludedStatus(status) || status === 'done') return false;
                return !task.fields.epicKey;
            });

            const emptyEpics = epicsInScope
                .filter(epic => {
                    const status = normalizeStatus(epic.status?.name);
                    if (status === 'killed' || status === 'done' || status === 'incomplete' || status === 'in progress') return false;
                    if (selectedTeam !== 'all' && epic.teamId && epic.teamId !== selectedTeam) return false;
                    return true;
                })
                .filter(epic => {
                    const hasStory = capacityTasks.some(task => {
                        if (!task.fields?.epicKey) return false;
                        if (selectedTeam !== 'all' && getTeamInfo(task).id !== selectedTeam) return false;
                        return task.fields.epicKey === epic.key;
                    });
                    return !hasStory;
                });

            const doneStoryEpics = epicsInScope
                .filter(epic => {
                    const status = normalizeStatus(epic.status?.name);
                    if (status === 'killed' || status === 'done' || status === 'incomplete') return false;
                    if (selectedTeam !== 'all' && epic.teamId && epic.teamId !== selectedTeam) return false;
                    return true;
                })
                .filter(epic => {
                    const epicStories = capacityTasks.filter(task => {
                        if (!task.fields?.epicKey) return false;
                        if (task.fields.epicKey !== epic.key) return false;
                        if (selectedTeam !== 'all' && getTeamInfo(task).id !== selectedTeam) return false;
                        return true;
                    });
                    if (epicStories.length === 0) return false;
                    return epicStories.every(task => normalizeStatus(task.fields.status?.name) === 'done');
                });

            const sortByPriorityThenSummary = (a, b) => {
                const priorityA = priorityOrder[a.fields.priority?.name] || 999;
                const priorityB = priorityOrder[b.fields.priority?.name] || 999;
                if (priorityA !== priorityB) return priorityA - priorityB;
                return (a.fields.summary || '').localeCompare(b.fields.summary || '');
            };

            const buildAlertGroups = (taskList) => {
                const grouped = groupTasksByEpic(taskList);
                return Object.values(grouped)
                    .map(group => ({
                        ...group,
                        tasks: [...group.tasks].sort(sortByPriorityThenSummary)
                    }))
                    .sort((a, b) => {
                        const diff = (b.tasks?.length || 0) - (a.tasks?.length || 0);
                        if (diff !== 0) return diff;
                        const nameA = (a.epic?.epicName || a.epic?.summary || a.parentSummary || a.key);
                        const nameB = (b.epic?.epicName || b.epic?.summary || b.parentSummary || b.key);
                        return nameA.localeCompare(nameB);
                    });
            };

            const missingInfoGroups = buildAlertGroups(missingInfoTasks);
            const blockedGroups = buildAlertGroups(blockedTasks);
            const noEpicTasksSorted = [...noEpicTasks].sort(sortByPriorityThenSummary);
            const emptyEpicsSorted = [...emptyEpics].sort((a, b) => (a.teamName || '').localeCompare(b.teamName || '') || (a.summary || '').localeCompare(b.summary || ''));
            const doneStoryEpicsSorted = [...doneStoryEpics].sort((a, b) => (a.teamName || '').localeCompare(b.teamName || '') || (a.summary || '').localeCompare(b.summary || ''));


            useEffect(() => {
                if (!showPlanning) {
                    return;
                }
                const updateOffset = () => {
                    const height = planningPanelRef.current?.getBoundingClientRect().height || 0;
                    setPlanningOffset(height);
                };
                updateOffset();
                window.addEventListener('resize', updateOffset);
                return () => window.removeEventListener('resize', updateOffset);
            }, [showPlanning, selectedCount, selectedSP, teamCapacityEntries.length]);

            const openSelectedInJira = () => {
                if (!jiraUrl) return;
                const keys = capacityTasks
                    .filter(task => selectedTasks[task.key])
                    .map(task => task.key)
                    .sort();
                if (keys.length === 0) return;
                const jql = encodeURIComponent(`key in (${keys.join(', ')})`);
                window.open(`${jiraUrl}/issues/?jql=${jql}`, '_blank', 'noopener,noreferrer');
            };

            return (
                <div className="container" style={{ '--planning-offset': `${planningOffset}px` }}>
                    <header>
                        <h1>Sprint Tasks</h1>
                        <div className="subtitle">
                            <span>Product & Tech Projects · {sprintName}</span>
                            <input
                                type="text"
                                className="search-input"
                                placeholder="Search tickets..."
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                            />
                        </div>
                        <div className="sprint-selector">
                            <label>Select Sprint:</label>
                            <select
                                value={selectedSprint || ''}
                                onChange={(e) => {
                                    const sprintId = parseInt(e.target.value);
                                    setSelectedSprint(sprintId);
                                    const sprint = availableSprints.find(s => s.id === sprintId);
                                    if (sprint) {
                                        setSprintName(sprint.name);
                                    }
                                }}
                                disabled={sprintsLoading || availableSprints.length === 0}
                            >
                                {sprintsLoading ? (
                                    <option value="">Loading sprints...</option>
                                ) : availableSprints.length === 0 ? (
                                    <option value="">No sprints available</option>
                                ) : (
                                    availableSprints.map(sprint => (
                                        <option key={sprint.id} value={sprint.id}>
                                            {sprint.name} ({sprint.state})
                                        </option>
                                    ))
                                )}
                            </select>
                            <label>Select Team:</label>
                            <select
                                value={selectedTeam}
                                onChange={(e) => setSelectedTeam(e.target.value)}
                                disabled={tasks.length === 0 && loading}
                            >
                                {teamOptions.map(team => (
                                    <option key={team.id} value={team.id}>{team.name}</option>
                                ))}
                            </select>
                            <button
                                className="secondary"
                                onClick={() => loadSprints(true)}
                                disabled={sprintsLoading}
                                title="Refresh sprints list from Jira"
                            >
                                {sprintsLoading ? 'Loading...' : 'Refresh Sprints'}
                            </button>
                            <button
                                className="secondary"
                                onClick={() => {
                                    loadProductTasks();
                                    loadTechTasks();
                                }}
                                disabled={loading || selectedSprint === null}
                                title="Refresh tasks from Jira"
                            >
                                {loading ? 'Loading...' : 'Refresh Page'}
                            </button>
                            <button
                                className={`planning-button ${showPlanning ? 'active' : ''}`}
                                onClick={() => setShowPlanning(!showPlanning)}
                                title="Toggle sprint planning panel"
                            >
                                Sprint Planning
                                <svg viewBox="0 0 12 12" fill="currentColor">
                                    <path d="M6 9L1 4h10z"/>
                                </svg>
                            </button>
                        </div>
                    </header>

                    {showPlanning && (
                        <div className="capacity-panel">
                            <div className="capacity-header">
                                <div className="capacity-title">Planned Teams Effort (Story Points)</div>
                                <div className="capacity-subtitle">1 SP ≈ 2 days of work</div>
                            </div>
                            <div className="capacity-grid-wrapper">
                                <div className="capacity-grid">
                                    <div className="capacity-row capacity-group-row">
                                        <div className="capacity-cell"></div>
                                        <div className="capacity-group-cell product">Product</div>
                                        <div className="capacity-group-cell tech">Tech</div>
                                        <div className="capacity-group-cell total">Total</div>
                                    </div>
                                    <div className="capacity-row capacity-header-row">
                                        <div className="capacity-cell">Team</div>
                                        <div className="capacity-cell metric product-col">To Do / Pending</div>
                                        <div className="capacity-cell metric product-col">Postponed</div>
                                        <div className="capacity-cell metric product-col divider-right">Accepted</div>
                                        <div className="capacity-cell metric tech-col">To Do / Pending</div>
                                        <div className="capacity-cell metric tech-col">Postponed</div>
                                        <div className="capacity-cell metric tech-col divider-right">Accepted</div>
                                        <div className="capacity-cell metric total-col">To Do / Pending</div>
                                        <div className="capacity-cell metric total-col">Postponed</div>
                                        <div className="capacity-cell metric total-col divider-right">Accepted</div>
                                    </div>
                                    {displayedTeamCapacityEntries.map((info) => (
                                        <div key={info.id} className="capacity-row capacity-divider">
                                            <div className="capacity-cell capacity-team">{info.name}</div>
                                            <div className="capacity-cell metric product-col">
                                                <div className="postponed-cell">
                                                    <span className={getMetricClass(info.product.todoPending, 'todo', info.product.accepted)}>
                                                        {formatCapacityValue(info.product.todoPending)}
                                                    </span>
                                                    {buildTodoPendingLink({ teamId: info.id, projectName: 'PRODUCT ROADMAPS' }) && (
                                                        <a
                                                            className="todo-link"
                                                            href={buildTodoPendingLink({ teamId: info.id, projectName: 'PRODUCT ROADMAPS' })}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            title="View To Do / Pending tasks for this team in Jira"
                                                            aria-label="Open To Do / Pending tasks in Jira"
                                                        >
                                                            ↗
                                                        </a>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="capacity-cell metric product-col">
                                                <div className="postponed-cell">
                                                    <span className="metric-value">
                                                        {formatCapacityValue(info.product.postponed)}
                                                    </span>
                                                    {buildPostponedLink({ teamId: info.id, projectName: 'PRODUCT ROADMAPS' }) && (
                                                        <a
                                                            className="postponed-link"
                                                            href={buildPostponedLink({ teamId: info.id, projectName: 'PRODUCT ROADMAPS' })}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            title="View postponed tasks for this team in Jira"
                                                            aria-label="Open postponed tasks in Jira"
                                                        >
                                                            ↗
                                                        </a>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="capacity-cell metric product-col divider-right">
                                                <div className="postponed-cell">
                                                    <span className={getMetricClass(info.product.accepted, 'accepted')}>
                                                        {formatCapacityValue(info.product.accepted)}
                                                    </span>
                                                    {buildAcceptedLink({ teamId: info.id, projectName: 'PRODUCT ROADMAPS' }) && (
                                                        <a
                                                            className="accepted-link"
                                                            href={buildAcceptedLink({ teamId: info.id, projectName: 'PRODUCT ROADMAPS' })}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            title="View accepted tasks for this team in Jira"
                                                            aria-label="Open accepted tasks in Jira"
                                                        >
                                                            ↗
                                                        </a>
                                                    )}
                                                </div>
                                            </div>

                                            <div className="capacity-cell metric tech-col">
                                                <div className="postponed-cell">
                                                    <span className={getMetricClass(info.tech.todoPending, 'todo', info.tech.accepted)}>
                                                        {formatCapacityValue(info.tech.todoPending)}
                                                    </span>
                                                    {buildTodoPendingLink({ teamId: info.id, projectName: 'TECHNICAL ROADMAP' }) && (
                                                        <a
                                                            className="todo-link"
                                                            href={buildTodoPendingLink({ teamId: info.id, projectName: 'TECHNICAL ROADMAP' })}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            title="View To Do / Pending tasks for this team in Jira"
                                                            aria-label="Open To Do / Pending tasks in Jira"
                                                        >
                                                            ↗
                                                        </a>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="capacity-cell metric tech-col">
                                                <div className="postponed-cell">
                                                    <span className="metric-value">
                                                        {formatCapacityValue(info.tech.postponed)}
                                                    </span>
                                                    {buildPostponedLink({ teamId: info.id, projectName: 'TECHNICAL ROADMAP' }) && (
                                                        <a
                                                            className="postponed-link"
                                                            href={buildPostponedLink({ teamId: info.id, projectName: 'TECHNICAL ROADMAP' })}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            title="View postponed tasks for this team in Jira"
                                                            aria-label="Open postponed tasks in Jira"
                                                        >
                                                            ↗
                                                        </a>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="capacity-cell metric tech-col divider-right">
                                                <div className="postponed-cell">
                                                    <span className={getMetricClass(info.tech.accepted, 'accepted')}>
                                                        {formatCapacityValue(info.tech.accepted)}
                                                    </span>
                                                    {buildAcceptedLink({ teamId: info.id, projectName: 'TECHNICAL ROADMAP' }) && (
                                                        <a
                                                            className="accepted-link"
                                                            href={buildAcceptedLink({ teamId: info.id, projectName: 'TECHNICAL ROADMAP' })}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            title="View accepted tasks for this team in Jira"
                                                            aria-label="Open accepted tasks in Jira"
                                                        >
                                                            ↗
                                                        </a>
                                                    )}
                                                </div>
                                            </div>

                                            <div className="capacity-cell metric total-col">
                                                <div className="postponed-cell">
                                                    <span className={getMetricClass(info.total.todoPending, 'todo', info.total.accepted)}>
                                                        {formatCapacityValue(info.total.todoPending)}
                                                    </span>
                                                    {buildTodoPendingLink({ teamId: info.id, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] }) && (
                                                        <a
                                                            className="todo-link"
                                                            href={buildTodoPendingLink({ teamId: info.id, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] })}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            title="View To Do / Pending tasks for this team in Jira"
                                                            aria-label="Open To Do / Pending tasks in Jira"
                                                        >
                                                            ↗
                                                        </a>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="capacity-cell metric total-col">
                                                <div className="postponed-cell">
                                                    <span className="metric-value">
                                                        {formatCapacityValue(info.total.postponed)}
                                                    </span>
                                                    {buildPostponedLink({ teamId: info.id, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] }) && (
                                                        <a
                                                            className="postponed-link"
                                                            href={buildPostponedLink({ teamId: info.id, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] })}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            title="View postponed tasks for this team in Jira"
                                                            aria-label="Open postponed tasks in Jira"
                                                        >
                                                            ↗
                                                        </a>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="capacity-cell metric total-col divider-right">
                                                <div className="postponed-cell">
                                                    <span className={getMetricClass(info.total.accepted, 'accepted')}>
                                                        {formatCapacityValue(info.total.accepted)}
                                                    </span>
                                                    {buildAcceptedLink({ teamId: info.id, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] }) && (
                                                        <a
                                                            className="accepted-link"
                                                            href={buildAcceptedLink({ teamId: info.id, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] })}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            title="View accepted tasks for this team in Jira"
                                                            aria-label="Open accepted tasks in Jira"
                                                        >
                                                            ↗
                                                        </a>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    {showTotalsRow && displayedTeamCapacityEntries.length > 0 && (
                                        <div className="capacity-row capacity-divider">
                                            <div className="capacity-cell capacity-team capacity-total">Total</div>
                                        <div className="capacity-cell metric product-col capacity-total">
                                            <div className="postponed-cell">
                                                <span className={getMetricClass(capacityTotals.product.todoPending, 'todo', capacityTotals.product.accepted)}>
                                                    {formatCapacityValue(capacityTotals.product.todoPending)}
                                                </span>
                                                {buildTodoPendingLink({ teamIds: capacityTeamIds, projectName: 'PRODUCT ROADMAPS' }) && (
                                                    <a
                                                        className="todo-link"
                                                        href={buildTodoPendingLink({ teamIds: capacityTeamIds, projectName: 'PRODUCT ROADMAPS' })}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        title="View To Do / Pending tasks for selected teams in Jira"
                                                        aria-label="Open To Do / Pending tasks in Jira"
                                                    >
                                                        ↗
                                                    </a>
                                                )}
                                            </div>
                                        </div>
                                        <div className="capacity-cell metric product-col capacity-total">
                                            <div className="postponed-cell">
                                                <span className="metric-value">
                                                    {formatCapacityValue(capacityTotals.product.postponed)}
                                                </span>
                                                {buildPostponedLink({ teamIds: capacityTeamIds, projectName: 'PRODUCT ROADMAPS' }) && (
                                                    <a
                                                        className="postponed-link"
                                                        href={buildPostponedLink({ teamIds: capacityTeamIds, projectName: 'PRODUCT ROADMAPS' })}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        title="View postponed tasks for selected teams in Jira"
                                                        aria-label="Open postponed tasks in Jira"
                                                    >
                                                        ↗
                                                    </a>
                                                )}
                                            </div>
                                        </div>
                                        <div className="capacity-cell metric product-col divider-right capacity-total">
                                            <div className="postponed-cell">
                                                <span className={getMetricClass(capacityTotals.product.accepted, 'accepted')}>
                                                    {formatCapacityValue(capacityTotals.product.accepted)}
                                                </span>
                                                {buildAcceptedLink({ teamIds: capacityTeamIds, projectName: 'PRODUCT ROADMAPS' }) && (
                                                    <a
                                                        className="accepted-link"
                                                        href={buildAcceptedLink({ teamIds: capacityTeamIds, projectName: 'PRODUCT ROADMAPS' })}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        title="View accepted tasks for selected teams in Jira"
                                                        aria-label="Open accepted tasks in Jira"
                                                    >
                                                        ↗
                                                    </a>
                                                )}
                                            </div>
                                            </div>

                                        <div className="capacity-cell metric tech-col capacity-total">
                                            <div className="postponed-cell">
                                                <span className={getMetricClass(capacityTotals.tech.todoPending, 'todo', capacityTotals.tech.accepted)}>
                                                    {formatCapacityValue(capacityTotals.tech.todoPending)}
                                                </span>
                                                {buildTodoPendingLink({ teamIds: capacityTeamIds, projectName: 'TECHNICAL ROADMAP' }) && (
                                                    <a
                                                        className="todo-link"
                                                        href={buildTodoPendingLink({ teamIds: capacityTeamIds, projectName: 'TECHNICAL ROADMAP' })}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        title="View To Do / Pending tasks for selected teams in Jira"
                                                        aria-label="Open To Do / Pending tasks in Jira"
                                                    >
                                                        ↗
                                                    </a>
                                                )}
                                            </div>
                                        </div>
                                        <div className="capacity-cell metric tech-col capacity-total">
                                            <div className="postponed-cell">
                                                <span className="metric-value">
                                                    {formatCapacityValue(capacityTotals.tech.postponed)}
                                                </span>
                                                {buildPostponedLink({ teamIds: capacityTeamIds, projectName: 'TECHNICAL ROADMAP' }) && (
                                                    <a
                                                        className="postponed-link"
                                                        href={buildPostponedLink({ teamIds: capacityTeamIds, projectName: 'TECHNICAL ROADMAP' })}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        title="View postponed tasks for selected teams in Jira"
                                                        aria-label="Open postponed tasks in Jira"
                                                    >
                                                        ↗
                                                    </a>
                                                )}
                                            </div>
                                        </div>
                                        <div className="capacity-cell metric tech-col divider-right capacity-total">
                                            <div className="postponed-cell">
                                                <span className={getMetricClass(capacityTotals.tech.accepted, 'accepted')}>
                                                    {formatCapacityValue(capacityTotals.tech.accepted)}
                                                </span>
                                                {buildAcceptedLink({ teamIds: capacityTeamIds, projectName: 'TECHNICAL ROADMAP' }) && (
                                                    <a
                                                        className="accepted-link"
                                                        href={buildAcceptedLink({ teamIds: capacityTeamIds, projectName: 'TECHNICAL ROADMAP' })}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        title="View accepted tasks for selected teams in Jira"
                                                        aria-label="Open accepted tasks in Jira"
                                                    >
                                                        ↗
                                                    </a>
                                                )}
                                            </div>
                                            </div>

                                        <div className="capacity-cell metric total-col capacity-total">
                                            <div className="postponed-cell">
                                                <span className={getMetricClass(capacityTotals.total.todoPending, 'todo', capacityTotals.total.accepted)}>
                                                    {formatCapacityValue(capacityTotals.total.todoPending)}
                                                </span>
                                                {buildTodoPendingLink({ teamIds: capacityTeamIds, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] }) && (
                                                    <a
                                                        className="todo-link"
                                                        href={buildTodoPendingLink({ teamIds: capacityTeamIds, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] })}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        title="View To Do / Pending tasks for selected teams in Jira"
                                                        aria-label="Open To Do / Pending tasks in Jira"
                                                    >
                                                        ↗
                                                    </a>
                                                )}
                                            </div>
                                        </div>
                                        <div className="capacity-cell metric total-col capacity-total">
                                            <div className="postponed-cell">
                                                <span className="metric-value">
                                                    {formatCapacityValue(capacityTotals.total.postponed)}
                                                </span>
                                                {buildPostponedLink({ teamIds: capacityTeamIds, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] }) && (
                                                    <a
                                                        className="postponed-link"
                                                        href={buildPostponedLink({ teamIds: capacityTeamIds, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] })}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        title="View postponed tasks for selected teams in Jira"
                                                        aria-label="Open postponed tasks in Jira"
                                                    >
                                                        ↗
                                                    </a>
                                                )}
                                            </div>
                                        </div>
                                            <div className="capacity-cell metric total-col divider-right capacity-total">
                                                <div className="postponed-cell">
                                                    <span className={getMetricClass(capacityTotals.total.accepted, 'accepted')}>
                                                        {formatCapacityValue(capacityTotals.total.accepted)}
                                                    </span>
                                                    {buildAcceptedLink({ teamIds: capacityTeamIds, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] }) && (
                                                        <a
                                                            className="accepted-link"
                                                            href={buildAcceptedLink({ teamIds: capacityTeamIds, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] })}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            title="View accepted tasks for selected teams in Jira"
                                                            aria-label="Open accepted tasks in Jira"
                                                        >
                                                            ↗
                                                        </a>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    {displayedTeamCapacityEntries.length === 0 && (
                                        <div className="capacity-empty">No capacity data for current filters.</div>
                                    )}
                                </div>
                                {displayedTeamCapacityEntries.length > 5 && (
                                    <div className="capacity-scroll-hint">Scroll for more teams</div>
                                )}
                            </div>
                        </div>
                    )}

	                    <div ref={planningPanelRef} className={`planning-panel ${showPlanning ? 'open' : ''}`}>
	                        <div className="planning-stats">
	                            <div className="planning-stat">
	                                <span className="planning-stat-label">Selected Tasks:</span>
	                                <span className="planning-stat-value">{selectedCount}</span>
	                            </div>
	                            <div className="planning-stat">
	                                <span className="planning-stat-label">Total:</span>
	                                <span className="planning-stat-value">{selectedSP.toFixed(1)}</span>
	                            </div>
	                            <div className="planning-actions">
	                                <button
	                                    className="planning-action-button"
	                                    onClick={() => selectPlanningTasksByStatus(['Accepted'])}
	                                    disabled={visibleTasks.length === 0}
	                                    title="Select all Accepted stories for the current view"
	                                >
	                                    Select Accepted
	                                </button>
	                                <button
	                                    className="planning-action-button"
	                                    onClick={() => selectPlanningTasksByStatus(['To Do', 'Pending'])}
	                                    disabled={visibleTasks.length === 0}
	                                    title="Select all To Do / Pending stories for the current view"
	                                >
	                                    Select To Do
	                                </button>
	                                <button
	                                    className="uncheck-button"
	                                    onClick={clearSelectedTasks}
	                                    disabled={selectedCount === 0}
	                                    title="Clear all selected tasks"
	                                >
	                                    Uncheck Selected
	                                </button>
	                                <button
	                                    className="planning-action-button planning-icon-button"
	                                    onClick={openSelectedInJira}
	                                    disabled={selectedCount === 0 || !jiraUrl}
	                                    title="Open selected stories in Jira (tip: bulk move them to Accepted)"
	                                    aria-label="Open selected stories in Jira"
	                                >
	                                    <svg viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
	                                        <path d="M10 2h4v4h-1.5V4.56L8.53 8.53l-1.06-1.06L11.44 3.5H10V2z" />
	                                        <path d="M13 9v4a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4v1.5H3.5v8h8V9H13z" />
	                                    </svg>
	                                </button>
	                            </div>
	                        </div>
	                        {selectedTeam === 'all' && (
	                            <>
	                                <div className="planning-stats compact" style={{ marginTop: '0.4rem' }}>
	                                    <div className="planning-stat">
	                                        <span className="planning-stat-label">Selected SP by Team:</span>
	                                    </div>
	                                </div>
	                                <div className="team-stats-grid">
	                                    {selectedTeamEntries.map((info) => (
	                                        <div key={info.id} className="team-stat-card">
	                                            <div className="team-stat-value">{info.storyPoints.toFixed(1)}</div>
	                                            <div className="team-stat-label">{info.name}</div>
	                                        </div>
	                                    ))}
	                                    {selectedTeamEntries.length === 0 && (
	                                        <div className="planning-stat">
	                                            <span className="planning-stat-value">No tasks selected</span>
	                                        </div>
	                                    )}
	                                </div>
	                            </>
	                        )}
	                        <div className="planning-stats compact" style={{ marginTop: '0.35rem' }}>
	                            <div className="planning-stat">
	                                <span className="planning-stat-label">Selected SP by Project:</span>
	                            </div>
	                        </div>
	                        <div className="team-stats-grid">
	                            {selectedProjectEntries.map((info) => (
	                                <div key={info.id} className="team-stat-card">
	                                    <div className="team-stat-value">{info.storyPoints.toFixed(1)}</div>
	                                    <div className="team-stat-label">{info.name}</div>
	                                </div>
	                            ))}
	                            {selectedProjectEntries.length === 0 && (
	                                <div className="planning-stat">
	                                    <span className="planning-stat-value">No tasks selected</span>
	                                </div>
	                            )}
	                        </div>
	                    </div>

                    {loading ? (
                        <div className="loading">Loading tasks...</div>
                    ) : error ? (
                        <div className="error">
                            {error}
                            <div style={{ marginTop: '1rem' }}>
                                <button onClick={fetchTasks}>Retry</button>
                            </div>
                        </div>
                    ) : (
                        <>
	                            {(missingInfoTasks.length > 0 || blockedTasks.length > 0 || noEpicTasks.length > 0 || emptyEpics.length > 0 || doneStoryEpics.length > 0) && (
	                                <div className="alert-panels">
	                                    {missingInfoTasks.length > 0 && (
	                                        <div className="alert-card missing">
                                            <div className="alert-card-header">
                                                <button
                                                    className="alert-toggle"
                                                    onClick={() => setShowMissingAlert(prev => !prev)}
                                                    title={showMissingAlert ? 'Collapse missing story points panel' : 'Expand missing story points panel'}
                                                >
                                                    <span className="alert-toggle-icon" aria-hidden="true">
                                                        <svg className={`alert-toggle-chevron ${showMissingAlert ? '' : 'collapsed'}`} viewBox="0 0 12 12">
                                                            <path d="M2.5 4.5l3.5 3 3.5-3" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
                                                        </svg>
                                                    </span>
                                                    <span className="alert-toggle-label">
                                                        {showMissingAlert ? 'Hide' : 'Show'}
                                                    </span>
                                                </button>
                                                <div className="alert-title">📄 Missing Story Points</div>
                                                <div className="alert-subtitle">These stories are wandering point-less—give them a quick estimate so planning can stop guessing.</div>
                                                <span className="alert-chip">
                                                    {missingInfoTasks.length} {missingInfoTasks.length === 1 ? 'story' : 'stories'}
                                                </span>
                                            </div>
                                            {showMissingAlert && (
                                                <div className="alert-card-body">
                                                    {missingInfoGroups.map(group => {
                                                        const epicTitle = group.epic?.epicName || group.epic?.summary || group.parentSummary ||
                                                            (group.key === 'NO_EPIC' ? 'No Epic Linked' : group.key);
                                                        return (
                                                            <div key={group.key} className="alert-epic">
                                                                <div className="alert-epic-head">
                                                                    <div className="alert-epic-title">
                                                                        <span className="alert-pill">EPIC</span>
                                                                        <span>{epicTitle}</span>
                                                                    </div>
                                                                    {group.key !== 'NO_EPIC' && (
                                                                        <a
                                                                            className="alert-epic-link"
                                                                            href={`${jiraUrl}/browse/${group.key}`}
                                                                            target="_blank"
                                                                            rel="noopener noreferrer"
                                                                        >
                                                                            Open epic ↗
                                                                        </a>
                                                                    )}
                                                                </div>
                                                                <div className="alert-stories">
                                                                    {group.tasks.map(task => {
                                                                        const teamInfo = getTeamInfo(task);
                                                                        return (
                                                                            <div key={task.key} className="alert-story">
                                                                                <span className="alert-pill team">{teamInfo.name}</span>
                                                                                <div className="alert-story-main">
                                                                                    <a
                                                                                        className="alert-story-link"
                                                                                        href={`${jiraUrl}/browse/${task.key}`}
                                                                                        target="_blank"
                                                                                        rel="noopener noreferrer"
                                                                                    >
                                                                                        {task.key} · {task.fields.summary}
                                                                                    </a>
                                                                                </div>
                                                                                <a
                                                                                    className="alert-action"
                                                                                    href={`${jiraUrl}/browse/${task.key}`}
                                                                                    target="_blank"
                                                                                    rel="noopener noreferrer"
                                                                                >
                                                                                    Add estimate →
                                                                                </a>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            )}
                                        </div>
                                    )}

	                                    {blockedTasks.length > 0 && (
	                                        <div className="alert-card blocked">
                                            <div className="alert-card-header">
                                                <button
                                                    className="alert-toggle"
                                                    onClick={() => setShowBlockedAlert(prev => !prev)}
                                                    title={showBlockedAlert ? 'Collapse blocked panel' : 'Expand blocked panel'}
                                                >
                                                    <span className="alert-toggle-icon" aria-hidden="true">
                                                        <svg className={`alert-toggle-chevron ${showBlockedAlert ? '' : 'collapsed'}`} viewBox="0 0 12 12">
                                                            <path d="M2.5 4.5l3.5 3 3.5-3" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
                                                        </svg>
                                                    </span>
                                                    <span className="alert-toggle-label">
                                                        {showBlockedAlert ? 'Hide' : 'Show'}
                                                    </span>
                                                </button>
                                                <div className="alert-title">⛔️ Blocked</div>
                                                <div className="alert-subtitle">Let’s unblock these fast—call out what’s stuck, who’s needed, and what “done” looks like.</div>
                                                <span className="alert-chip">{blockedTasks.length} blocked</span>
                                            </div>
	                                            {showBlockedAlert && (
	                                                <div className="alert-card-body">
	                                                    {blockedGroups.map(group => {
	                                                        const epicTitle = group.epic?.epicName || group.epic?.summary || group.parentSummary ||
	                                                            (group.key === 'NO_EPIC' ? 'No Epic Linked' : group.key);
	                                                        return (
	                                                            <div key={group.key} className="alert-epic">
	                                                                <div className="alert-epic-head">
                                                                    <div className="alert-epic-title">
                                                                        <span className="alert-pill">EPIC</span>
                                                                        <span>{epicTitle}</span>
                                                                    </div>
                                                                    {group.key !== 'NO_EPIC' && (
                                                                        <a
                                                                            className="alert-epic-link"
                                                                            href={`${jiraUrl}/browse/${group.key}`}
                                                                            target="_blank"
                                                                            rel="noopener noreferrer"
                                                                        >
                                                                            Open epic ↗
                                                                        </a>
                                                                    )}
                                                                </div>
                                                                <div className="alert-stories">
                                                                    {group.tasks.map(task => {
                                                                        const teamInfo = getTeamInfo(task);
                                                                        const statusLabel = task.fields.status?.name || 'Blocked';
                                                                        return (
                                                                            <div key={task.key} className="alert-story">
                                                                                <span className="alert-pill team">{teamInfo.name}</span>
                                                                                <div className="alert-story-main">
                                                                                    <a
                                                                                        className="alert-story-link"
                                                                                        href={`${jiraUrl}/browse/${task.key}`}
                                                                                        target="_blank"
                                                                                        rel="noopener noreferrer"
                                                                                    >
                                                                                        {task.key} · {task.fields.summary}
                                                                                    </a>
                                                                                </div>
                                                                                <span className="alert-pill status">{statusLabel}</span>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                        );
	                                                    })}
	                                                </div>
	                                            )}
	                                        </div>
	                                    )}

	                                    {noEpicTasks.length > 0 && (
	                                        <div className="alert-card no-epic">
	                                            <div className="alert-card-header">
	                                                <button
	                                                    className="alert-toggle"
	                                                    onClick={() => setShowNoEpicAlert(prev => !prev)}
	                                                    title={showNoEpicAlert ? 'Collapse missing epic panel' : 'Expand missing epic panel'}
	                                                >
	                                                    <span className="alert-toggle-icon" aria-hidden="true">
	                                                        <svg className={`alert-toggle-chevron ${showNoEpicAlert ? '' : 'collapsed'}`} viewBox="0 0 12 12">
	                                                            <path d="M2.5 4.5l3.5 3 3.5-3" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
	                                                        </svg>
	                                                    </span>
	                                                    <span className="alert-toggle-label">
	                                                        {showNoEpicAlert ? 'Hide' : 'Show'}
	                                                    </span>
	                                                </button>
	                                                <div className="alert-title">🧩 Missing Epic</div>
	                                                <div className="alert-subtitle">These stories have no parent epic—pick one so they land in the right bucket.</div>
	                                                <span className="alert-chip">{noEpicTasks.length} {noEpicTasks.length === 1 ? 'story' : 'stories'}</span>
	                                            </div>
		                                            {showNoEpicAlert && (
		                                                <div className="alert-card-body">
		                                                    <div className="alert-stories">
		                                                        {noEpicTasksSorted.map(task => {
	                                                            const teamInfo = getTeamInfo(task);
	                                                            const statusLabel = task.fields.status?.name || 'Unknown';
	                                                            return (
	                                                                <div key={task.key} className="alert-story">
	                                                                    <span className="alert-pill team">{teamInfo.name}</span>
	                                                                    <div className="alert-story-main">
	                                                                        <a
	                                                                            className="alert-story-link"
	                                                                            href={`${jiraUrl}/browse/${task.key}`}
	                                                                            target="_blank"
	                                                                            rel="noopener noreferrer"
	                                                                        >
	                                                                            {task.key} · {task.fields.summary}
	                                                                        </a>
	                                                                    </div>
	                                                                    <span className="alert-pill status">{statusLabel}</span>
	                                                                    <a
	                                                                        className="alert-action"
	                                                                        href={`${jiraUrl}/browse/${task.key}`}
	                                                                        target="_blank"
	                                                                        rel="noopener noreferrer"
	                                                                    >
	                                                                        Choose epic →
	                                                                    </a>
	                                                                </div>
	                                                            );
		                                                        })}
		                                                    </div>
		                                                </div>
		                                            )}
		                                        </div>
		                                    )}

	                                    {emptyEpics.length > 0 && (
	                                        <div className="alert-card empty-epic">
	                                            <div className="alert-card-header">
	                                                <button
	                                                    className="alert-toggle"
	                                                    onClick={() => setShowEmptyEpicAlert(prev => !prev)}
	                                                    title={showEmptyEpicAlert ? 'Collapse empty epic panel' : 'Expand empty epic panel'}
	                                                >
	                                                    <span className="alert-toggle-icon" aria-hidden="true">
	                                                        <svg className={`alert-toggle-chevron ${showEmptyEpicAlert ? '' : 'collapsed'}`} viewBox="0 0 12 12">
	                                                            <path d="M2.5 4.5l3.5 3 3.5-3" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
	                                                        </svg>
	                                                    </span>
	                                                    <span className="alert-toggle-label">
	                                                        {showEmptyEpicAlert ? 'Hide' : 'Show'}
	                                                    </span>
	                                                </button>
	                                                <div className="alert-title">🧺 Empty Epic</div>
	                                                <div className="alert-subtitle">These epics have zero stories—please review and create at least one story to make them actionable.</div>
	                                                <span className="alert-chip">{emptyEpics.length} {emptyEpics.length === 1 ? 'epic' : 'epics'}</span>
	                                            </div>
		                                            {showEmptyEpicAlert && (
		                                                <div className="alert-card-body">
		                                                    <div className="alert-stories">
		                                                        {emptyEpicsSorted.map(epic => (
	                                                            <div key={epic.key} className="alert-story">
	                                                                <span className="alert-pill team">{epic.teamName || 'Unknown Team'}</span>
	                                                                <div className="alert-story-main">
	                                                                    <a
	                                                                        className="alert-story-link"
	                                                                        href={`${jiraUrl}/browse/${epic.key}`}
	                                                                        target="_blank"
	                                                                        rel="noopener noreferrer"
	                                                                    >
	                                                                        {epic.key} · {epic.epicName || epic.summary}
	                                                                    </a>
	                                                                </div>
	                                                                {epic.status?.name && (
	                                                                    <span className="alert-pill status">{epic.status.name}</span>
	                                                                )}
	                                                                <a
	                                                                    className="alert-action"
	                                                                    href={`${jiraUrl}/browse/${epic.key}`}
	                                                                    target="_blank"
	                                                                    rel="noopener noreferrer"
	                                                                >
	                                                                    Create story →
	                                                                </a>
	                                                            </div>
		                                                        ))}
		                                                    </div>
		                                                </div>
		                                            )}
		                                        </div>
		                                    )}

		                                    {doneStoryEpics.length > 0 && (
		                                        <div className="alert-card done-epic">
	                                            <div className="alert-card-header">
	                                                <button
	                                                    className="alert-toggle"
	                                                    onClick={() => setShowDoneEpicAlert(prev => !prev)}
	                                                    title={showDoneEpicAlert ? 'Collapse ready-to-close epics panel' : 'Expand ready-to-close epics panel'}
	                                                >
	                                                    <span className="alert-toggle-icon" aria-hidden="true">
	                                                        <svg className={`alert-toggle-chevron ${showDoneEpicAlert ? '' : 'collapsed'}`} viewBox="0 0 12 12">
	                                                            <path d="M2.5 4.5l3.5 3 3.5-3" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
	                                                        </svg>
	                                                    </span>
	                                                    <span className="alert-toggle-label">
	                                                        {showDoneEpicAlert ? 'Hide' : 'Show'}
	                                                    </span>
	                                                </button>
	                                                <div className="alert-title">✅ Epic Ready to Close</div>
	                                                <div className="alert-subtitle">All stories are done, but the epic is still open—time to close the loop.</div>
	                                                <span className="alert-chip">{doneStoryEpics.length} {doneStoryEpics.length === 1 ? 'epic' : 'epics'}</span>
	                                            </div>
	                                            {showDoneEpicAlert && (
	                                                <div className="alert-card-body">
	                                                    <div className="alert-stories">
	                                                        {doneStoryEpicsSorted.map(epic => (
	                                                            <div key={epic.key} className="alert-story">
	                                                                <span className="alert-pill team">{epic.teamName || 'Unknown Team'}</span>
	                                                                <div className="alert-story-main">
	                                                                    <a
	                                                                        className="alert-story-link"
	                                                                        href={`${jiraUrl}/browse/${epic.key}`}
	                                                                        target="_blank"
	                                                                        rel="noopener noreferrer"
	                                                                    >
	                                                                        {epic.key} · {epic.epicName || epic.summary}
	                                                                    </a>
	                                                                </div>
	                                                                {epic.assignee?.displayName && (
	                                                                    <span className="alert-pill status">{epic.assignee.displayName}</span>
	                                                                )}
	                                                                <a
	                                                                    className="alert-action"
	                                                                    href={`${jiraUrl}/browse/${epic.key}`}
	                                                                    target="_blank"
	                                                                    rel="noopener noreferrer"
	                                                                >
	                                                                    Close epic →
	                                                                </a>
	                                                            </div>
	                                                        ))}
	                                                    </div>
	                                                </div>
	                                            )}
	                                        </div>
	                                    )}
	                                </div>
	                            )}
		                            <div className="stats">
                                <div
                                    className={`stat-card total ${statusFilter === null ? 'active' : ''}`}
                                    onClick={() => setStatusFilter(null)}
                                >
                                    <div className="stat-value">{tasks.length}</div>
                                    <div className="stat-label">Total Tasks</div>
                                </div>
                                <div
                                    className={`stat-card done ${statusFilter === 'done' ? 'active' : ''}`}
                                    onClick={() => setStatusFilter(statusFilter === 'done' ? null : 'done')}
                                >
                                    <div className="stat-value">{doneTasksCount}</div>
                                    <div className="stat-label">Done Tasks</div>
                                </div>
                                <div
                                    className={`stat-card high-priority ${statusFilter === 'high-priority' ? 'active' : ''}`}
                                    onClick={() => setStatusFilter(statusFilter === 'high-priority' ? null : 'high-priority')}
                                >
                                    <div className="stat-value">{highPriorityCount}</div>
                                    <div className="stat-label">High Priority</div>
                                </div>
                                <div
                                    className={`stat-card in-progress ${statusFilter === 'in-progress' ? 'active' : ''}`}
                                    onClick={() => setStatusFilter(statusFilter === 'in-progress' ? null : 'in-progress')}
                                >
                                    <div className="stat-value">{inProgressTasksCount}</div>
                                    <div className="stat-label">In Progress</div>
                                </div>
                                <div
                                    className={`stat-card todo-accepted ${statusFilter === 'todo-accepted' ? 'active' : ''}`}
                                    onClick={() => setStatusFilter(statusFilter === 'todo-accepted' ? null : 'todo-accepted')}
                                >
                                    <div className="stat-value">{todoAcceptedTasksCount}</div>
                                    <div className="stat-label">To Do / Pending / Accepted</div>
                                </div>
                            </div>

                            <div className="toggle-container">
                                <button
                                    className={`toggle ${showTech ? 'active' : ''}`}
                                    onClick={() => {
                                        setShowTech(!showTech);
                                    }}
                                >
                                    {showTech
                                        ? `Hide Tech Tasks (${techTasksCount})`
                                        : `Show Tech Tasks (${techTasksCount})`}
                                </button>
                                <button
                                    className={`toggle ${showProduct ? 'active' : ''}`}
                                    onClick={() => setShowProduct(!showProduct)}
                                >
                                    {showProduct ? `Hide Product Tasks (${productTasksCount})` : `Show Product Tasks (${productTasksCount})`}
                                </button>
                                {doneTasks.length > 0 && (
                                    <button
                                        className={`toggle ${showDone ? 'active' : ''}`}
                                        onClick={() => setShowDone(!showDone)}
                                    >
                                        {showDone ? `Hide Done Tasks (${doneTasks.length})` : `Show Done Tasks (${doneTasks.length})`}
                                    </button>
                                )}
                                {killedTasks.length > 0 && (
                                    <button
                                        className={`toggle ${showKilled ? 'active' : ''}`}
                                        onClick={() => setShowKilled(!showKilled)}
                                    >
                                        {showKilled ? `Hide Killed Tasks (${killedTasks.length})` : `Show Killed Tasks (${killedTasks.length})`}
                                    </button>
                                )}
                            </div>

                            {visibleTasks.length === 0 ? (
                                <div className="empty-state">
                                    <h2>No tasks found</h2>
                                    <p>There are no tasks matching the current criteria</p>
                                </div>
                            ) : (
                                <div className="task-list">
                                    {epicGroups.map(epicGroup => {
                                        const epicInfo = epicGroup.epic;
                                        const epicTitle = epicInfo?.epicName || epicInfo?.summary || epicGroup.parentSummary ||
                                            (epicGroup.key === 'NO_EPIC' ? 'No Epic Linked' : epicGroup.key);
                                        const epicTotalSp = epicGroup.storyPoints || 0;

                                        return (
                                            <div key={epicGroup.key} className="epic-block">
	                                                <div className="epic-header">
	                                                    <div className="epic-title">
	                                                        <div className="epic-title-row">
                                                            <span className="epic-icon" aria-hidden="true" title="EPIC">
                                                                <svg viewBox="0 0 24 24" fill="none">
                                                                    <rect x="3" y="3" width="18" height="18" rx="3" stroke="#1D7AFC" strokeWidth="2"/>
                                                                    <path d="M7.5 12.5l3 3 6-6" stroke="#1D7AFC" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                                                </svg>
                                                            </span>
                                                            {epicGroup.key !== 'NO_EPIC' ? (
                                                                <a
                                                                    className="epic-link"
                                                                    href={`${jiraUrl}/browse/${epicGroup.key}`}
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                >
                                                                    <span className="epic-name">{epicTitle}</span>
                                                                    <span className="epic-key">{epicGroup.key}</span>
                                                                </a>
                                                            ) : (
                                                                <>
                                                                    <span className="epic-name">{epicTitle}</span>
                                                                    <span className="epic-key">Unassigned</span>
                                                                </>
                                                            )}
                                                        </div>
	                                                    </div>
	                                                    <div className="epic-meta">
	                                                        <span>SP: {epicTotalSp.toFixed(1)}</span>
	                                                        {epicInfo?.assignee?.displayName && (
	                                                            <span className="task-assignee epic-assignee">
	                                                                <span className="task-assignee-icon" aria-hidden="true">
	                                                                    <svg viewBox="0 0 24 24" fill="none">
	                                                                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z" stroke="currentColor" strokeWidth="2" />
	                                                                        <path d="M4 20c0-3.31 3.58-6 8-6s8 2.69 8 6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
	                                                                    </svg>
	                                                                </span>
	                                                                <span>{epicInfo.assignee.displayName}</span>
	                                                            </span>
	                                                        )}
	                                                    </div>
	                                                </div>
                                                {epicGroup.tasks.map(task => {
                                                    const isKilled = task.fields.status?.name === 'Killed';
                                                    const isDone = task.fields.status?.name === 'Done';
                                                    const teamInfo = getTeamInfo(task);
                                                    return (
                                                        <div
                                                            key={task.key}
                                                            className={`task-item priority-${task.fields.priority?.name.toLowerCase()} ${isDone ? 'status-done' : ''} ${isKilled ? 'status-killed' : ''}`}
                                                        >
                                                            <div className="task-header">
                                                                <button
                                                                    className="task-remove"
                                                                    onClick={() => removeTask(task.key)}
                                                                    title="Remove task from view"
                                                                >
                                                                    ×
                                                                </button>
                                                                <div className="task-headline">
                                                                    <span className="story-icon" aria-hidden="true" title="STORY">
                                                                        <svg viewBox="0 0 24 24" fill="none">
                                                                            <path d="M7 4h10a2 2 0 012 2v14l-7-4-7 4V6a2 2 0 012-2z" stroke="#55A630" strokeWidth="2" strokeLinejoin="round"/>
                                                                        </svg>
                                                                    </span>
                                                                    <h3 className="task-title">
                                                                        <a href={`${jiraUrl}/browse/${task.key}`} target="_blank" rel="noopener noreferrer">
                                                                            {task.fields.summary}
                                                                        </a>
                                                                    </h3>
                                                                    <span className="task-inline-meta">
                                                                        <a
                                                                            className="task-key-link"
                                                                            href={`${jiraUrl}/browse/${task.key}`}
                                                                            target="_blank"
                                                                            rel="noopener noreferrer"
                                                                        >
                                                                            {task.key}
                                                                        </a>
                                                                        {task.fields.customfield_10004 && (
                                                                            <span className="task-inline-sp">
                                                                                {task.fields.customfield_10004} SP
                                                                            </span>
                                                                        )}
                                                                    </span>
                                                                    {showPlanning && (
                                                                        <input
                                                                            type="checkbox"
                                                                            className="task-checkbox"
                                                                            checked={!!selectedTasks[task.key]}
                                                                            onChange={() => toggleTaskSelection(task.key)}
                                                                            title="Select for sprint planning"
                                                                        />
                                                                    )}
                                                                </div>
                                                                <span className={`task-priority ${task.fields.priority?.name.toLowerCase()}`}>
                                                                    {task.fields.priority?.name || 'None'}
                                                                </span>
                                                            </div>
                                                            <div className="task-meta">
                                                                <span className={`task-status ${task.fields.status?.name.toLowerCase().replace(/\s+/g, '-')}`}>
                                                                    {task.fields.status?.name}
                                                                </span>
                                                                <span className="task-team">{teamInfo.name}</span>
                                                                {task.fields.assignee && (
                                                                    <span className="task-assignee">
                                                                        <span className="task-assignee-icon" aria-hidden="true">
                                                                            <svg viewBox="0 0 24 24" fill="none">
                                                                                <path d="M12 12a4.5 4.5 0 1 0-4.5-4.5A4.5 4.5 0 0 0 12 12Z" stroke="currentColor" strokeWidth="1.6"/>
                                                                                <path d="M4 20c1.8-4 6-5.5 8-5.5S18.2 16 20 20" stroke="currentColor" strokeWidth="1.6" strokeLinecap="round"/>
                                                                            </svg>
                                                                        </span>
                                                                        {task.fields.assignee.displayName}
                                                                    </span>
                                                                )}
                                                                {task.fields.updated && (
                                                                    <span className="task-updated">
                                                                        Last Update: {new Date(task.fields.updated).toLocaleDateString('en-CA')}
                                                                    </span>
                                                                )}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        );
                                    })}
                                </div>
                            )}

                            <div style={{marginTop: '3rem', textAlign: 'center'}}>
                                <button onClick={fetchTasks}>
                                    Refresh
                                </button>
                            </div>
                        </>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
