<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Jira Â· Sprint Tasks v2.0</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@300;400;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f8f7f4;
            --bg-secondary: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --accent: #d4380d;
            --good: #389e0d;
            --warn: #cf1322;
            --muted: #bfbfbf;
            --alert-missing: #fa8c16;
            --alert-blocked: #d4380d;
            --border: #e0ddd7;
            --shadow: rgba(0, 0, 0, 0.04);
        }

        body {
            font-family: 'Crimson Pro', serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1040px;
            margin: 0 auto;
            padding: 2.5rem 1.5rem 3rem;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        header {
            margin-bottom: 1.6rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1.1rem;
        }

        h1 {
            font-size: 3rem;
            font-weight: 300;
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
            animation: slideDown 0.8s ease-out 0.2s both;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .subtitle {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            animation: slideDown 0.8s ease-out 0.4s both;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-input {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            text-transform: none;
            letter-spacing: normal;
            width: 260px;
            transition: all 0.2s;
        }

        .header-actions {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: nowrap;
        }

        .secondary.compact {
            padding: 0.4rem 0.75rem;
            font-size: 0.7rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(212, 56, 13, 0.1);
        }

        .search-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }

        .search-wrap {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-clear {
            position: absolute;
            right: 0.35rem;
            background: transparent;
            border: none;
            font-size: 1rem;
            line-height: 1;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.1rem 0.3rem;
        }

        .search-clear:hover {
            color: var(--text-primary);
        }

        .sprint-selector {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            margin-top: 1rem;
            position: relative;
        }

        .sprint-filters {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .sprint-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sprint-selector label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin: 0;
        }

        .sprint-selector button {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            margin: 0;
        }

        select {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(212, 56, 13, 0.1);
        }

        select:hover {
            border-color: var(--text-secondary);
        }

        select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .team-dropdown {
            position: relative;
            display: inline-block;
            align-items: center;
        }

        .team-dropdown-toggle {
            border: 1px solid var(--border);
            background: transparent;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            width: 220px;
            display: inline-flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.6rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .team-dropdown-toggle span {
            flex: 1;
            text-align: left;
        }

        .team-dropdown-toggle:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--border);
        }

        .team-dropdown-toggle:focus {
            outline: none;
            border-color: var(--border);
            box-shadow: none;
        }

        .team-dropdown-toggle svg {
            width: 0.75rem;
            height: 0.75rem;
            transition: transform 0.2s ease;
        }

        .team-dropdown-toggle.open svg {
            transform: rotate(180deg);
        }

        .team-dropdown-panel {
            position: absolute;
            top: calc(100% + 0.35rem);
            left: 0;
            width: 240px;
            max-height: 220px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid var(--border);
            box-shadow: 0 12px 28px rgba(22, 22, 22, 0.12);
            padding: 0.5rem 0.6rem;
            z-index: 20;
            text-align: left;
            box-sizing: border-box;
        }

        .sprint-selector .team-dropdown-panel label.team-dropdown-option {
            display: grid;
            grid-template-columns: 14px 1fr;
            align-items: center;
            column-gap: 0.5rem;
            padding: 0.25rem 0.2rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.55rem;
            color: var(--text-primary);
            text-align: left;
            text-transform: none;
            letter-spacing: normal;
            line-height: 1.2;
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
            margin: 0;
        }

        .sprint-selector .team-dropdown-panel label.team-dropdown-option:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .sprint-selector .team-dropdown-panel label.team-dropdown-option input {
            margin: 0;
        }

        .sprint-selector .team-dropdown-panel label.team-dropdown-option span {
            text-align: left;
        }

        .team-dropdown-option + .team-dropdown-option {
            border-top: 1px dashed var(--border);
        }

        .config-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 2rem;
            margin-bottom: 3rem;
            animation: slideUp 0.6s ease-out 0.4s both;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        input {
            width: 100%;
            padding: 0.875rem;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            font-family: 'Crimson Pro', serif;
            font-size: 1rem;
            transition: all 0.2s;
        }

        input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(212, 56, 13, 0.1);
        }

        button {
            background: var(--text-primary);
            color: var(--bg-primary);
            border: none;
            padding: 0.875rem 2rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 1rem;
        }

        button:hover {
            background: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        button.secondary:hover {
            background: var(--bg-primary);
            transform: none;
        }

        button.toggle {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            margin: 0 0.5rem;
        }

        button.toggle:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
            transform: none;
        }

        button.toggle.active {
            background: var(--text-primary);
            color: var(--bg-primary);
            border-color: var(--text-primary);
        }

        .toggle-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.25rem;
            flex-wrap: wrap;
        }

	        .alert-panels {
	            display: grid;
	            grid-template-columns: 1fr;
	            gap: 1rem;
	            margin: 1rem 0 1.2rem;
	        }

        .alert-panels.collapsed {
            gap: 0.6rem;
            margin: 0.6rem 0 0.85rem;
        }

	        .alert-card {
	            background: var(--bg-secondary);
	            border: 1px solid var(--border);
	            border-left: 6px solid var(--accent);
	            padding: 1.2rem 1.4rem;
	            box-shadow: 0 10px 30px var(--shadow);
	        }

        .alert-card.collapsed {
            padding: 0.7rem 1rem;
        }

        .alert-card.collapsed .alert-card-header {
            margin-bottom: 0;
        }

        .alert-card.collapsed .alert-subtitle {
            display: none;
        }

        .alert-card.missing {
            border-left-color: var(--alert-missing);
        }

        .alert-card.blocked {
            border-left-color: var(--alert-blocked);
        }

        .alert-card.no-epic {
            border-left-color: #722ed1;
        }

	        .alert-card.empty-epic {
	            border-left-color: #fa8c16;
	        }

	        .alert-card.done-epic {
	            border-left-color: #52c41a;
	        }

	        .alert-card-header {
	            display: flex;
	            align-items: center;
	            justify-content: space-between;
	            gap: 0.75rem;
	            margin-bottom: 0.8rem;
	            flex-wrap: wrap;
	        }

        .alert-title {
            font-weight: 700;
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: 0.45rem;
        }

        .alert-subtitle {
            flex: 1;
            color: var(--text-secondary);
            font-size: 0.9rem;
            min-width: 220px;
        }

        .alert-chip {
            background: #1a1a1a;
            color: #fff;
            padding: 0.2rem 0.65rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-family: 'IBM Plex Mono', monospace;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            cursor: pointer;
        }

        .alert-chip:hover {
            background: #2a2a2a;
        }

        .alert-toggle {
            background: transparent;
            border: none;
            color: var(--text-primary);
            padding: 0;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .alert-toggle:hover {
            background: transparent;
            transform: none;
            box-shadow: none;
        }

        .alert-toggle-icon {
            width: 1.15rem;
            height: 1.15rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #444;
        }

        .alert-toggle-chevron {
            width: 0.7rem;
            height: 0.7rem;
            display: block;
            transition: transform 0.2s ease;
        }

        .alert-toggle-chevron.collapsed {
            transform: rotate(-90deg);
        }

        .alert-toggle-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            letter-spacing: 0.02em;
        }

	        .alert-card-body {
	            margin-top: 0.5rem;
	        }

        .alert-epic {
            border: 1px solid var(--border);
            padding: 0.85rem;
            margin-bottom: 0.6rem;
            background: #faf9f7;
        }

        .alert-epic-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            margin-bottom: 0.55rem;
            flex-wrap: wrap;
        }

        .alert-epic-title {
            display: flex;
            align-items: center;
            gap: 0.45rem;
            font-weight: 600;
        }

        .alert-epic-link {
            font-size: 0.85rem;
            color: var(--accent);
            text-decoration: none;
        }

        .alert-stories {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .alert-story {
            display: flex;
            align-items: flex-start;
            gap: 0.55rem;
            padding: 0.5rem 0.4rem;
            border-radius: 6px;
            border: 1px dashed var(--border);
            background: #fff;
        }

        .alert-story:hover {
            border-color: var(--accent);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }

        .alert-pill {
            padding: 0.25rem 0.55rem;
            border-radius: 999px;
            background: #f0f0f0;
            font-size: 0.75rem;
            font-family: 'IBM Plex Mono', monospace;
            color: #444;
            white-space: nowrap;
        }

        .alert-pill.team {
            background: #e6f4ff;
            color: #0958d9;
        }

        .alert-pill.status {
            background: #fff1f0;
            color: #d4380d;
        }

        .alert-story-main {
            flex: 1;
        }

        .alert-story-link {
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 600;
        }

        .alert-story-note {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 0.2rem;
        }

        .alert-action {
            color: var(--accent);
            font-weight: 600;
            text-decoration: none;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            white-space: nowrap;
        }

        .task-list {
            animation: fadeIn 0.8s ease-out 0.6s both;
        }

        .task-item {
            background: var(--bg-secondary);
            border-left: 4px solid var(--border);
            padding: 1.25rem 1.5rem;
            margin-bottom: 0.9rem;
            transition: all 0.3s;
            animation: slideUp 0.6s ease-out both;
        }

        .task-item:nth-child(1) { animation-delay: 0.7s; }
        .task-item:nth-child(2) { animation-delay: 0.8s; }
        .task-item:nth-child(3) { animation-delay: 0.9s; }
        .task-item:nth-child(4) { animation-delay: 1s; }
        .task-item:nth-child(5) { animation-delay: 1.1s; }

        .task-item:hover {
            transform: translateX(4px);
            box-shadow: -6px 0 18px var(--shadow);
        }

        /* Standard Jira priorities */
        .task-item.priority-blocker,
        .task-item.priority-highest {
            border-left-color: #a8071a;
        }

        .task-item.priority-critical,
        .task-item.priority-high {
            border-left-color: #d4380d;
        }

        .task-item.priority-major,
        .task-item.priority-medium {
            border-left-color: #faad14;
        }

        .task-item.priority-minor,
        .task-item.priority-low {
            border-left-color: #bfbfbf;
        }

        .task-item.priority-trivial,
        .task-item.priority-lowest {
            border-left-color: #d9d9d9;
        }

        .task-item.status-done {
            background: #f6ffed;
            border-left-color: #52c41a;
        }

        .task-item.status-killed {
            background: #f5f5f5;
            border-left-color: #d9d9d9;
            opacity: 0.6;
        }

        .task-item.status-killed .task-title,
        .task-item.status-killed .task-inline-meta,
        .task-item.status-killed .task-meta {
            color: #8c8c8c;
        }

        .task-item.status-killed .task-priority {
            color: #8c8c8c;
            border-color: #d9d9d9;
        }

        .task-item.status-killed:hover {
            opacity: 0.75;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .task-remove {
            position: absolute;
            top: -1.1rem;
            right: -1.1rem;
            width: 1.5rem;
            height: 1.5rem;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s;
            padding: 0;
            margin: 0;
            border-radius: 2px;
        }

        .task-item:hover .task-remove {
            opacity: 1;
        }

        .task-remove:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: none;
        }

        .task-headline {
            display: flex;
            align-items: baseline;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .task-title {
            font-size: 1.05rem;
            font-weight: 400;
            line-height: 1.25;
        }

        .task-title a {
            color: inherit;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.2s;
        }

        .task-title a:hover {
            border-bottom-color: var(--accent);
        }

        .task-inline-meta {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.68rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .task-key-link {
            color: inherit;
            text-decoration: none;
            border-bottom: 1px solid transparent;
        }

        .task-key-link:hover {
            border-bottom-color: var(--accent);
        }

        .task-inline-sp {
            color: #d48806;
            font-weight: 600;
        }

        .task-headline .task-checkbox {
            margin-left: 0.2rem;
        }

        .task-priority {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            padding: 0.2rem 0.6rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        /* Standard Jira priorities */
        .task-priority.blocker,
        .task-priority.highest {
            color: #a8071a;
            border-color: #a8071a;
            background: #fff1f0;
        }

        .task-priority.critical,
        .task-priority.high {
            color: #d4380d;
            border-color: #d4380d;
            background: #fff2e8;
        }

        .task-priority.major,
        .task-priority.medium {
            color: #d48806;
            border-color: #d48806;
            background: #fffbe6;
        }

        .task-priority.minor,
        .task-priority.low {
            color: #8c8c8c;
            border-color: #bfbfbf;
            background: #fafafa;
        }

        .task-priority.trivial,
        .task-priority.lowest {
            color: #bfbfbf;
            border-color: #d9d9d9;
            background: #fafafa;
        }

        .task-meta {
            display: flex;
            gap: 1rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            flex-wrap: wrap;
        }

        .task-team {
            background: #f6f4ff;
            color: #4b3fb0;
            padding: 0.18rem 0.45rem;
            border-radius: 2px;
            border: 1px solid #c7b8ff;
        }

        .task-assignee {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            color: var(--text-secondary);
        }

        .task-assignee-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            color: #8c8c8c;
        }

        .task-assignee-icon svg {
            width: 14px;
            height: 14px;
        }

        .epic-block {
            border: 1px solid var(--border);
            margin-bottom: 1.1rem;
            background: var(--bg-secondary);
            padding: 0.75rem;
        }

        .epic-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            padding: 0.5rem 0;
            margin-bottom: 0.75rem;
            position: sticky;
            top: calc(var(--planning-offset, 0px) + 0.5rem);
            background: var(--bg-secondary);
            z-index: 3;
            box-shadow: 0 1px 0 var(--border);
        }

        .epic-title {
            font-size: 1.1rem;
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .epic-title-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .epic-link {
            display: inline-flex;
            align-items: baseline;
            gap: 0.45rem;
            color: inherit;
            text-decoration: none;
        }

        .epic-link:hover {
            text-decoration: underline;
            text-decoration-thickness: 1px;
            text-underline-offset: 3px;
        }

        .epic-name {
            font-weight: 600;
        }

        .epic-key {
            font-family: 'IBM Plex Mono', monospace;
            color: var(--text-secondary);
            font-size: 0.9rem;
            letter-spacing: 0.02em;
        }

        .epic-icon,
        .story-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .epic-icon svg {
            width: 18px;
            height: 18px;
        }

        .story-icon svg {
            width: 16px;
            height: 16px;
        }

        .epic-title small {
            font-family: 'IBM Plex Mono', monospace;
            color: var(--text-secondary);
            letter-spacing: 0.05em;
        }

	        .epic-meta {
	            font-family: 'IBM Plex Mono', monospace;
	            color: var(--text-secondary);
	            text-transform: uppercase;
	            letter-spacing: 0.05em;
	            display: flex;
	            align-items: center;
	            gap: 0.65rem;
	        }

	        .epic-assignee {
	            text-transform: none;
	            letter-spacing: 0;
	        }

        .team-group {
            margin-bottom: 1rem;
        }

        .team-heading {
            font-family: 'IBM Plex Mono', monospace;
            color: #2f54eb;
            margin-bottom: 0.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .task-meta > span:not(.task-status) {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }


        .task-updated {
            color: var(--text-secondary);
        }

        .task-status {
            padding: 0.2rem 0.6rem;
            border-radius: 2px;
            font-weight: 500;
        }

        .task-status.killed {
            background: #595959;
            color: white;
        }

        .task-status.done {
            background: #52c41a;
            color: white;
        }

        .task-status.in-progress {
            background: #69c0ff;
            color: white;
        }

        .task-status.to-do {
            background: #597ef7;
            color: white;
        }

        .task-status.blocked {
            background: #ff4d4f;
            color: white;
        }

        .task-status.accepted {
            background: #597ef7;
            color: white;
        }

        .task-status.pending {
            background: #597ef7;
            color: white;
        }

        .task-status.postponed {
            background: #fa8c16;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 4rem 0;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--text-secondary);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        .error {
            background: #fff2e8;
            border: 1px solid #ffbb96;
            padding: 1.5rem;
            margin-bottom: 2rem;
            color: var(--accent);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 0.6rem;
            text-align: center;
            animation: slideUp 0.6s ease-out both;
            cursor: pointer;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(89, 126, 247, 0.2);
            background: #f6f8ff;
            border-color: #91a7ff;
        }

        .stat-card.active {
            border-color: #597ef7;
            box-shadow: 0 0 0 2px rgba(89, 126, 247, 0.25);
            background: #f0f5ff;
        }

        .stat-card.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
            pointer-events: none;
        }

        .stat-card:nth-child(1) { animation-delay: 0.5s; }
        .stat-card:nth-child(2) { animation-delay: 0.6s; }
        .stat-card:nth-child(3) { animation-delay: 0.7s; }
        .stat-card:nth-child(4) { animation-delay: 0.8s; }
        .stat-card:nth-child(5) { animation-delay: 0.9s; }
        .stat-card:nth-child(6) { animation-delay: 1s; }

        .stat-value {
            font-size: 1.35rem;
            font-weight: 300;
            color: var(--accent);
            line-height: 1;
            margin-bottom: 0.25rem;
        }

        .stat-card.total .stat-value {
            color: var(--text-primary);
        }

        .stat-card.done .stat-value {
            color: #52c41a;
        }

        .stat-card.in-progress .stat-value {
            color: #597ef7;
        }

        .stat-card.todo-accepted .stat-value {
            color: #9254de;
        }

        .stat-card.high-priority .stat-value {
            color: #d4380d;
        }

        .stat-card.minor .stat-value {
            color: #64748b;
        }

        .stat-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state h2 {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 1rem;
        }

        /* Sprint Planning Styles */
        .planning-button {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 0;
        }

        .planning-button:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
            transform: none;
        }

        .planning-button.active {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        .planning-button svg {
            width: 0.75rem;
            height: 0.75rem;
            transition: transform 0.3s;
        }

        .planning-button.active svg {
            transform: rotate(180deg);
        }

        .planning-panel {
            background: transparent;
            border: 1px solid transparent;
            margin-top: 0;
            margin-bottom: 0;
            overflow: hidden;
            max-height: 0;
            padding: 0;
            opacity: 0;
            transition: max-height 0.6s ease, opacity 0.6s ease, padding 0.6s ease, margin 0.6s ease, border-color 0.6s ease, background 0.6s ease;
        }

        .planning-panel.open {
            background: var(--bg-secondary);
            border-color: var(--border);
            max-height: 1600px;
            padding: 0.75rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
            opacity: 1;
            overflow: visible;
            position: sticky;
            top: 0.5rem;
            z-index: 4;
            box-shadow: 0 8px 24px rgba(26, 26, 26, 0.08);
        }

        .stats-panel {
            background: transparent;
            border: 1px solid transparent;
            margin-top: 0;
            margin-bottom: 0;
            overflow: hidden;
            max-height: 0;
            padding: 0;
            opacity: 0;
            transition: max-height 0.6s ease, opacity 0.6s ease, padding 0.6s ease, margin 0.6s ease, border-color 0.6s ease, background 0.6s ease;
        }

        .stats-panel.open {
            background: var(--bg-secondary);
            border-color: var(--border);
            max-height: 2000px;
            padding: 0.75rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
            opacity: 1;
            overflow: visible;
            box-shadow: 0 8px 24px rgba(26, 26, 26, 0.08);
        }

        .stats-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.6rem;
            align-items: end;
            margin-bottom: 0.8rem;
        }

        .stats-control-group label {
            display: block;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            margin-bottom: 0.3rem;
            font-family: 'IBM Plex Mono', monospace;
        }

        .stats-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 0.35rem;
        }

        .stats-actions button {
            width: 100%;
            min-height: 32px;
            padding: 0.4rem 0.6rem;
            font-size: 0.7rem;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .stats-card {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 0.6rem;
            padding: 0.75rem;
            box-shadow: 0 8px 18px rgba(29, 29, 29, 0.06);
        }

        .stats-card h4 {
            margin: 0 0 0.35rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-secondary);
            font-family: 'IBM Plex Mono', monospace;
        }

        .stats-card .stat-value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stats-note {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 0.4rem;
        }

        .stats-bars {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 0.75rem;
            align-items: start;
            margin-bottom: 0.5rem;
        }

        .stats-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.35rem;
        }

        .stats-bar-value {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .stats-bar-track {
            width: 100%;
            height: 140px;
            background: rgba(29, 122, 252, 0.08);
            border-radius: 0.6rem;
            position: relative;
            overflow: hidden;
        }

        .stats-bar-fill {
            width: 100%;
            background: linear-gradient(180deg, #1d7afc, #0bb5ff);
            border-radius: 0.6rem;
            position: absolute;
            left: 0;
            bottom: 0;
        }

        .stats-bar-fill.good {
            background: linear-gradient(180deg, #1d9a6c, #2cb67d);
        }

        .stats-bar-fill.warn {
            background: linear-gradient(180deg, #f59e0b, #f06b3b);
        }

        .stats-bar-fill.bad {
            background: linear-gradient(180deg, #ef4444, #f87171);
        }

        .stats-bar-fill.secondary {
            background: linear-gradient(180deg, #f06b3b, #f59e0b);
        }

        .stats-bar-fill.tech {
            background: linear-gradient(180deg, #2cb67d, #1d9a6c);
        }

        .stats-bar-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: center;
            max-width: 100%;
            line-height: 1.1;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .stats-category {
            margin-top: 0.8rem;
        }

        .stats-category-title {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            margin-bottom: 0.4rem;
        }

        .stats-view-toggle {
            display: inline-flex;
            gap: 0.4rem;
            margin: 0.6rem 0 0.8rem;
            flex-wrap: wrap;
        }

        .stats-view {
            opacity: 0;
            transform: translateY(6px);
            max-height: 0;
            overflow: hidden;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease, max-height 0.2s ease;
        }

        .stats-view.open {
            opacity: 1;
            transform: translateY(0);
            max-height: 2400px;
            pointer-events: auto;
        }

        .priority-radar {
            width: 100%;
            max-width: 500px;
            height: auto;
            margin: 0.2rem auto 0.6rem;
            display: block;
        }

        .priority-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem 1rem;
            justify-content: center;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 0.45rem;
        }

        .priority-axis-note {
            text-align: center;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.6rem;
            color: var(--text-secondary);
            margin-bottom: 0.8rem;
        }

        .priority-legend span {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            cursor: pointer;
        }

        .priority-legend i {
            width: 10px;
            height: 10px;
            border-radius: 3px;
            display: inline-block;
        }

        .epic-stat-toggle {
            margin-left: 0.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            padding: 0.25rem 0.45rem;
            background: #fff;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .epic-stat-toggle.active {
            background: #111;
            color: #fff;
            border-color: #111;
        }

        .epic-stat-toggle svg {
            width: 0.75rem;
            height: 0.75rem;
        }

        .stats-toggle {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            padding: 0.3rem 0.7rem;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-family: 'IBM Plex Mono', monospace;
            transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
        }

        .stats-toggle.active {
            background: var(--text-primary);
            color: var(--bg-primary);
            border-color: var(--text-primary);
        }

        .stats-toggle:hover {
            background: transparent;
            color: var(--text);
            border-color: rgba(22, 119, 255, 0.35);
            transform: none;
        }

        .stats-card.selectable {
            cursor: pointer;
            transition: border-color 0.15s ease, box-shadow 0.15s ease, transform 0.15s ease;
        }

        .stats-card.selectable:hover {
            border-color: rgba(22, 119, 255, 0.35);
            transform: translateY(-1px);
        }

        .stats-card.active {
            border-color: #111;
            box-shadow: 0 10px 22px rgba(26, 26, 26, 0.12);
        }

        @media (min-width: 1200px) {
            .stats-bars {
                grid-template-columns: repeat(8, minmax(90px, 1fr));
            }
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
            font-family: 'IBM Plex Mono', monospace;
            border-top: 1px solid var(--border);
            margin-top: 0.6rem;
        }

        .stats-table th,
        .stats-table td {
            padding: 0.35rem 0.5rem;
            border-bottom: 1px dashed var(--border);
        }

        .stats-table th {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        .stats-table th.metric,
        .stats-table td.metric {
            text-align: right;
        }

        .stats-table th.dimension,
        .stats-table td.dimension {
            text-align: left;
        }

        .stats-table .stats-group-row th {
            border-bottom: 1px solid var(--border);
            font-size: 0.58rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            text-align: center;
            padding-top: 0.5rem;
            padding-bottom: 0.4rem;
        }

        .stats-col.product {
            background: #fff7e6;
        }

        .stats-col.tech {
            background: #e6f7ff;
        }

        .stats-col.total {
            background: #f6ffed;
        }

        .capacity-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 0.6rem 0.75rem;
            margin: 0 0 1rem;
        }

        .capacity-grid-wrapper {
            max-height: 520px;
            overflow-y: auto;
            overflow-x: auto;
            padding-right: 0.25rem;
            padding-bottom: 0.25rem;
            -webkit-overflow-scrolling: touch;
        }

        .capacity-header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .capacity-title {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        .capacity-subtitle {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.6rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .capacity-grid {
            display: grid;
            gap: 0.2rem;
            min-width: 860px;
        }

        .capacity-row {
            display: grid;
            grid-template-columns:
                minmax(160px, 1.4fr)
                minmax(112px, 0.6fr) minmax(70px, 0.5fr) minmax(70px, 0.5fr)
                minmax(112px, 0.6fr) minmax(70px, 0.5fr) minmax(70px, 0.5fr)
                minmax(112px, 0.6fr) minmax(70px, 0.5fr) minmax(70px, 0.5fr);
            align-items: center;
            padding: 0.08rem 0;
        }

        .capacity-group-row {
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.25rem;
            margin-bottom: 0.1rem;
        }

        .capacity-group-cell {
            grid-column: span 3;
            text-align: center;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        .capacity-group-cell.product {
            grid-column: 2 / span 3;
        }

        .capacity-group-cell.tech {
            grid-column: 5 / span 3;
        }

        .capacity-group-cell.total {
            grid-column: 8 / span 3;
        }

        .capacity-cell {
            padding: 0.3rem 0.4rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-primary);
        }

        .capacity-cell.metric {
            border-left: 1px solid var(--border);
            text-align: right;
        }

        .capacity-cell.product-col {
            background: #fff7e6;
        }

        .capacity-cell.tech-col {
            background: #e6f7ff;
        }

        .capacity-cell.total-col {
            background: #f6ffed;
        }

        .capacity-cell.divider-right {
            border-right: 2px solid var(--border);
        }

        .capacity-header-row .capacity-cell {
            font-size: 0.58rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .capacity-divider {
            border-top: 1px dashed var(--border);
        }

        .capacity-team {
            font-family: 'IBM Plex Mono', monospace;
            color: var(--text-primary);
        }


        .capacity-total {
            font-weight: 500;
        }

        .capacity-empty {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
            padding: 0.25rem 0;
        }

        .capacity-scroll-hint {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-secondary);
            margin-top: 0.3rem;
            text-align: right;
        }

        .metric-value {
            font-weight: 600;
        }

        .metric-muted {
            color: var(--muted);
        }

        .metric-accepted {
            color: var(--good);
        }

        .metric-warn {
            color: var(--warn);
        }

        .postponed-cell {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
        }

        .postponed-link {
            opacity: 0.6;
            font-size: 0.85em;
            text-decoration: none;
            color: inherit;
            transition: opacity 0.2s ease, color 0.2s ease;
        }

        .postponed-cell:hover .postponed-link {
            opacity: 1;
            color: var(--accent);
        }

        .todo-link {
            opacity: 0.6;
            font-size: 0.85em;
            text-decoration: none;
            color: inherit;
            transition: opacity 0.2s ease, color 0.2s ease;
        }

        .postponed-cell:hover .todo-link {
            opacity: 1;
            color: var(--accent);
        }

        .accepted-link {
            opacity: 0.6;
            font-size: 0.85em;
            text-decoration: none;
            color: inherit;
            transition: opacity 0.2s ease, color 0.2s ease;
        }

        .postponed-cell:hover .accepted-link {
            opacity: 1;
            color: var(--accent);
        }

        .stats-link {
            opacity: 0.6;
            font-size: 0.85em;
            text-decoration: none;
            color: inherit;
            transition: opacity 0.2s ease, color 0.2s ease;
        }

        .postponed-cell:hover .stats-link {
            opacity: 1;
            color: var(--accent);
        }

        .planning-stats {
            display: flex;
            gap: 0.85rem;
            align-items: center;
            justify-content: flex-start;
            font-family: 'IBM Plex Mono', monospace;
            flex-wrap: wrap;
            overflow-x: hidden;
        }

        .planning-stats.compact {
            gap: 0.6rem;
            font-size: 0.65rem;
            justify-content: flex-start;
        }

        .planning-stats.compact .planning-stat-label {
            font-size: 0.62rem;
            letter-spacing: 0.04em;
        }

        .planning-stats.compact .planning-stat-value {
            font-size: 0.62rem;
        }

        .planning-stat-separator {
            margin-left: 0.4rem;
            color: var(--text-secondary);
        }

        .team-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .team-stat-card {
            background: #fff;
            border: 1px solid var(--border);
            padding: 0.5rem 0.6rem;
            text-align: left;
            box-shadow: 0 6px 16px var(--shadow);
        }

        .team-stat-value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .team-stat-label {
            margin-bottom: 0.2rem;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        .team-stat-line {
            display: flex;
            align-items: baseline;
            gap: 0.35rem;
            flex-wrap: nowrap;
        }

        .team-stat-line .team-stat-value {
            font-size: 0.62rem;
            white-space: nowrap;
        }

        .project-card .team-stat-value {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .team-stat-line .team-stat-meta {
            margin-top: 0;
            white-space: nowrap;
            line-height: 1;
        }

        .team-stat-meta {
            margin-top: 0.2rem;
            font-size: 0.6rem;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--text-secondary);
        }

        .team-stat-value.muted {
            font-size: 0.62rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .uncheck-button {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            padding: 0.4rem 1rem;
            font-size: 0.7rem;
            margin: 0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .uncheck-button:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: none;
        }

        .uncheck-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .uncheck-button:disabled:hover {
            background: transparent;
            color: var(--text-secondary);
            border-color: var(--border);
        }

        .planning-action-button {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            padding: 0.4rem 1rem;
            font-size: 0.7rem;
            margin: 0;
            cursor: pointer;
            transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .planning-action-button:hover {
            background: rgba(22, 119, 255, 0.08);
            color: var(--text);
            border-color: rgba(22, 119, 255, 0.25);
            transform: none;
        }

        .planning-action-button.active {
            background: #f6ffed;
            border-color: #b7eb8f;
            color: #389e0d;
        }

        .planning-action-button.active:hover {
            background: #f6ffed;
            color: #389e0d;
            border-color: #b7eb8f;
        }

        .planning-action-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .planning-action-button:disabled:hover {
            background: transparent;
            color: var(--text-secondary);
            border-color: var(--border);
        }

        .planning-action-button svg {
            width: 1rem;
            height: 1rem;
        }

        .planning-icon-button {
            width: 2.05rem;
            height: 2.05rem;
            padding: 0;
            border-radius: 999px;
            justify-content: center;
            gap: 0;
        }

        .planning-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: nowrap;
            white-space: nowrap;
        }

        .planning-stat {
            display: flex;
            align-items: baseline;
            gap: 0.35rem;
        }

        .planning-stat-label {
            font-size: 0.62rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .planning-stat-label[data-tooltip] {
            position: relative;
            cursor: help;
        }

        .planning-stat-label[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 0;
            top: 1.2rem;
            background: #111;
            color: #fff;
            font-size: 0.6rem;
            line-height: 1.2;
            padding: 0.35rem 0.45rem;
            border-radius: 0.3rem;
            white-space: normal;
            width: max-content;
            max-width: 220px;
            z-index: 20;
        }

        .planning-stat-value {
            font-size: 0.65rem;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1;
        }

        .planning-stat-value.over {
            color: #d4380d;
        }

        .planning-stat-value.under {
            color: #d4380d;
        }

        .task-checkbox-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .task-checkbox {
            width: 0.75rem;
            height: 0.75rem;
            min-width: 0.75rem;
            min-height: 0.75rem;
            cursor: pointer;
            appearance: none;
            border: 1.5px solid var(--border);
            border-radius: 2px;
            background: var(--bg-secondary);
            transition: all 0.2s;
            position: relative;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .task-checkbox:hover {
            border-color: var(--text-secondary);
        }

        .task-checkbox:checked {
            background: #52c41a;
            border-color: #52c41a;
        }

        .task-checkbox:checked::after {
            content: 'â';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.55rem;
            font-weight: bold;
            line-height: 1;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Backend server URL
        const DEFAULT_BACKEND_PORT = 5050;
        const BACKEND_URL = window.BACKEND_URL ||
            (window.location.protocol.startsWith('http')
                ? `${window.location.protocol}//${window.location.hostname}:${DEFAULT_BACKEND_PORT}`
                : `http://localhost:${DEFAULT_BACKEND_PORT}`);

        // Get current quarter in format "2025Q1"
        function getCurrentQuarter() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1; // 1-12
            const quarter = Math.ceil(month / 3);
            return `${year}Q${quarter}`;
        }

        // Cookie helper functions
        function setCookie(name, value, days = 365) {
            const expires = new Date();
            expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
            document.cookie = `${name}=${JSON.stringify(value)};expires=${expires.toUTCString()};path=/`;
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) {
                    try {
                        return JSON.parse(c.substring(nameEQ.length, c.length));
                    } catch (e) {
                        return null;
                    }
                }
            }
            return null;
        }

        const UI_PREFS_KEY = 'jira_dashboard_ui_prefs_v1';

        function loadUiPrefs() {
            try {
                const raw = window.localStorage.getItem(UI_PREFS_KEY);
                if (!raw) return null;
                return JSON.parse(raw);
            } catch (e) {
                return null;
            }
        }

        function saveUiPrefs(prefs) {
	            try {
	                window.localStorage.setItem(UI_PREFS_KEY, JSON.stringify(prefs));
	            } catch (e) {
	                // ignore
	            }
	        }

        function App() {
            const savedPrefsRef = useRef(loadUiPrefs() || {});
            const [productTasks, setProductTasks] = useState([]);
            const [techTasks, setTechTasks] = useState([]);
            const [readyToCloseProductTasks, setReadyToCloseProductTasks] = useState([]);
            const [readyToCloseTechTasks, setReadyToCloseTechTasks] = useState([]);
            const [missingPlanningInfoTasks, setMissingPlanningInfoTasks] = useState([]);
            const [productEpicsInScope, setProductEpicsInScope] = useState([]);
            const [techEpicsInScope, setTechEpicsInScope] = useState([]);
            const [readyToCloseProductEpicsInScope, setReadyToCloseProductEpicsInScope] = useState([]);
            const [readyToCloseTechEpicsInScope, setReadyToCloseTechEpicsInScope] = useState([]);
            const [techLoaded, setTechLoaded] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [showKilled, setShowKilled] = useState(savedPrefsRef.current.showKilled ?? false);
            const [showDone, setShowDone] = useState(savedPrefsRef.current.showDone ?? true);
            const [showTech, setShowTech] = useState(savedPrefsRef.current.showTech ?? true);
            const [showProduct, setShowProduct] = useState(savedPrefsRef.current.showProduct ?? true);
            const [sprintName, setSprintName] = useState('Sprint');
            const [statusFilter, setStatusFilter] = useState(savedPrefsRef.current.statusFilter ?? null); // null = show all, 'in-progress', 'todo-accepted', 'done', 'high-priority'
            const [selectedSprint, setSelectedSprint] = useState(savedPrefsRef.current.selectedSprint ?? null); // Sprint ID
            const [availableSprints, setAvailableSprints] = useState([]);
            const [sprintsLoading, setSprintsLoading] = useState(true);
            const [jiraUrl, setJiraUrl] = useState('');
            const [selectedTasks, setSelectedTasks] = useState(() => {
                // Load from cookie on init
                return getCookie('selectedTasks') || {};
            });
            const [showPlanning, setShowPlanning] = useState(savedPrefsRef.current.showPlanning ?? false);
            const [showStats, setShowStats] = useState(savedPrefsRef.current.showStats ?? false);
            const [searchQuery, setSearchQuery] = useState(savedPrefsRef.current.searchQuery ?? '');
            const normalizeSelectedTeams = (value) => {
                if (Array.isArray(value)) {
                    return value.length ? value : ['all'];
                }
                if (typeof value === 'string' && value.trim()) {
                    return [value];
                }
                return ['all'];
            };
            const [selectedTeams, setSelectedTeams] = useState(
                normalizeSelectedTeams(savedPrefsRef.current.selectedTeams ?? savedPrefsRef.current.selectedTeam ?? 'all')
            );
            const [epicDetails, setEpicDetails] = useState({});
            const [planningOffset, setPlanningOffset] = useState(0);
            const planningPanelRef = useRef(null);
            const resolveStatsView = (value) => (value === 'teams' || value === 'priority') ? value : 'teams';
            const resolveStatsGraphMode = (value) => (value === 'weighted' || value === 'absolute') ? value : 'weighted';
            const [statsView, setStatsView] = useState(resolveStatsView(savedPrefsRef.current.statsView));
            const [statsGraphMode, setStatsGraphMode] = useState(resolveStatsGraphMode(savedPrefsRef.current.statsGraphMode));
            const [priorityHoverIndex, setPriorityHoverIndex] = useState(null);
            const [showTeamDropdown, setShowTeamDropdown] = useState(false);
            const teamDropdownRef = useRef(null);
            const [capacityEnabled, setCapacityEnabled] = useState(false);
            const [capacityByTeam, setCapacityByTeam] = useState({});
            const [capacityLoading, setCapacityLoading] = useState(false);
            const [excludedStatsEpics, setExcludedStatsEpics] = useState(savedPrefsRef.current.excludedStatsEpics ?? []);
            const [showMissingAlert, setShowMissingAlert] = useState(savedPrefsRef.current.showMissingAlert ?? true);
            const [showBlockedAlert, setShowBlockedAlert] = useState(savedPrefsRef.current.showBlockedAlert ?? true);
            const [showEmptyEpicAlert, setShowEmptyEpicAlert] = useState(savedPrefsRef.current.showEmptyEpicAlert ?? true);
            const [showDoneEpicAlert, setShowDoneEpicAlert] = useState(savedPrefsRef.current.showDoneEpicAlert ?? true);
            const epicOrderRef = useRef({});
            const epicOrderCounterRef = useRef(0);

            useEffect(() => {
                // Load config and sprints on component mount
                loadConfig();
                loadSprints();
            }, []);


            const normalizeStatus = (status) => {
                return (status || '').toLowerCase().replace(/\s+/g, ' ').trim();
            };

            useEffect(() => {
                if (!showPlanning) {
                    setPlanningOffset(0);
                }
            }, [showPlanning]);

            useEffect(() => {
                if (showPlanning) {
                    setShowStats(false);
                }
            }, [showPlanning]);

            useEffect(() => {
                if (showPlanning && !isCompletedSprintSelected) {
                    includePlanningTasksByStatus(['Accepted']);
                }
            }, [showPlanning, isCompletedSprintSelected]);

            useEffect(() => {
                if (showStats) {
                    setShowPlanning(false);
                }
            }, [showStats]);

            useEffect(() => {
                if (!capacityEnabled) {
                    setCapacityByTeam({});
                }
            }, [capacityEnabled]);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (!teamDropdownRef.current) return;
                    if (!teamDropdownRef.current.contains(event.target)) {
                        setShowTeamDropdown(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            useEffect(() => {
                // Save selected tasks to cookie whenever they change
                setCookie('selectedTasks', selectedTasks);
            }, [selectedTasks]);

            useEffect(() => {
                saveUiPrefs({
                    selectedSprint,
                    selectedTeams,
                    showPlanning,
                    showStats,
                    showTech,
                    showProduct,
                    showDone,
                    showKilled,
                    statusFilter,
                    searchQuery,
                    statsView,
                    statsGraphMode,
                    excludedStatsEpics,
                    showMissingAlert,
                    showBlockedAlert,
                    showEmptyEpicAlert,
                    showDoneEpicAlert
                });
            }, [
                selectedSprint,
                selectedTeams,
                showPlanning,
                showStats,
                showTech,
                showProduct,
                showDone,
                showKilled,
                statusFilter,
                searchQuery,
                statsView,
                statsGraphMode,
                excludedStatsEpics,
                showMissingAlert,
                showBlockedAlert,
                showEmptyEpicAlert,
                showDoneEpicAlert
            ]);

            const loadConfig = async () => {
                try {
                    const response = await fetch(`${BACKEND_URL}/api/config`);
                    if (response.ok) {
                        const config = await response.json();
                        setJiraUrl(config.jiraUrl || '');
                        setCapacityEnabled(Boolean(config.capacityProject));
                    }
                } catch (err) {
                    console.error('Failed to load config:', err);
                }
            };

	            useEffect(() => {
	                // Load tasks when sprint changes (team is filtered client-side)
	                if (selectedSprint !== null) {
	                    setEpicDetails({});
	                    setProductEpicsInScope([]);
	                    setTechEpicsInScope([]);
	                    setMissingPlanningInfoTasks([]);
	                    loadProductTasks();
	                    loadTechTasks();
	                    fetchMissingPlanningInfo(selectedSprint);
	                }
	            }, [selectedSprint]);

	            const fetchMissingPlanningInfo = async (sprintId) => {
	                try {
	                    if (!sprintId) return;
	                    const params = new URLSearchParams({ sprint: String(sprintId), t: Date.now().toString() });
	                    const response = await fetch(`${BACKEND_URL}/api/missing-info?${params.toString()}`, {
	                        method: 'GET',
	                        headers: { 'Content-Type': 'application/json' },
	                        cache: 'no-cache'
	                    });
	                    if (!response.ok) return;
	                    const data = await response.json();
	                    setMissingPlanningInfoTasks(data.issues || []);
	                } catch (e) {
	                    // ignore (alerts are best-effort)
	                }
	            };

            useEffect(() => {
                setTechLoaded(false);
            }, [selectedSprint]);

            useEffect(() => {
                epicOrderRef.current = {};
                epicOrderCounterRef.current = 0;
            }, [selectedSprint]);


            const loadSprints = async (forceRefresh = false) => {
                setSprintsLoading(true);
                try {
                    const params = new URLSearchParams({
                        t: Date.now().toString()
                    });
                    if (forceRefresh) {
                        params.append('refresh', 'true');
                    }
                    const response = await fetch(`${BACKEND_URL}/api/sprints?${params}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        cache: 'no-cache'
                    });

                    if (!response.ok) {
                        throw new Error(`Error ${response.status}`);
                    }

                    const data = await response.json();
                    const sprints = data.sprints || [];
                    setAvailableSprints(sprints);

                    const preferredSprintId = savedPrefsRef.current.selectedSprint;
                    const preferredSprint = preferredSprintId ? sprints.find(s => String(s.id) === String(preferredSprintId)) : null;

                    if (preferredSprint) {
                        setSelectedSprint(preferredSprint.id);
                        setSprintName(preferredSprint.name);
                    } else {
                        // Auto-select current quarter if available
                        const currentQuarter = getCurrentQuarter();
                        const currentSprint = sprints.find(s => s.name === currentQuarter);
                        if (currentSprint) {
                            setSelectedSprint(currentSprint.id);
                            setSprintName(currentSprint.name);
                        } else if (sprints.length > 0) {
                            // If current quarter not found, select the last sprint
                            const lastSprint = sprints[sprints.length - 1];
                            setSelectedSprint(lastSprint.id);
                            setSprintName(lastSprint.name);
                        }
                    }

                    console.log('â Loaded sprints:', sprints);
                } catch (err) {
                    console.error('Failed to load sprints:', err);
                    setError(`Failed to load sprints: ${err.message}`);
                } finally {
                    setSprintsLoading(false);
                }
            };

            const priorityOrder = {
                'Blocker': 1,
                'Highest': 1,
                'Critical': 2,
                'High': 2,
                'Major': 3,
                'Medium': 3,
                'Minor': 4,
                'Low': 4,
                'Trivial': 5,
                'Lowest': 5
            };

            const fetchCapacity = async (sprintName) => {
                if (!capacityEnabled || !sprintName) return;
                setCapacityLoading(true);
                try {
                    const teams = capacityTeamNames;
                    const params = new URLSearchParams({
                        sprint: sprintName,
                        t: Date.now().toString()
                    });
                    if (teams.length) {
                        params.append('teams', teams.join(','));
                    }
                    const response = await fetch(`${BACKEND_URL}/api/capacity?${params.toString()}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                        cache: 'no-cache'
                    });
                    if (!response.ok) {
                        setCapacityByTeam({});
                        return;
                    }
                    const data = await response.json();
                    if (!data?.enabled) {
                        setCapacityByTeam({});
                        return;
                    }
                    const normalized = {};
                    Object.entries(data.capacities || {}).forEach(([name, value]) => {
                        const key = normalizeCapacityKey(name);
                        const numeric = Number(value);
                        if (!key || Number.isNaN(numeric)) return;
                        normalized[key] = numeric;
                    });
                    setCapacityByTeam(normalized);
                } catch (err) {
                    setCapacityByTeam({});
                } finally {
                    setCapacityLoading(false);
                }
            };

            const priorityAxis = ['Blocker', 'Critical', 'Major', 'Minor', 'Low', 'Trivial'];
            const priorityLabelByKey = {
                blocker: 'Blocker',
                critical: 'Critical',
                major: 'Major',
                minor: 'Minor',
                low: 'Low',
                trivial: 'Trivial'
            };
            const radarPalette = ['#1d7afc', '#2cb67d', '#f59e0b', '#ef4444', '#8b5cf6', '#14b8a6', '#ec4899', '#f97316'];

            const getTeamInfo = (task) => {
                const team = task.fields?.team;
                const teamName = task.fields?.teamName || team?.name || team?.displayName || team?.teamName || 'Unknown Team';
                const teamId = task.fields?.teamId || team?.id || team?.teamId || team?.key || teamName;
                return { id: teamId, name: teamName };
            };

	            const fetchTasks = async (project, options = {}) => {
	                const useLoading = options.useLoading !== false;
	                const setErrors = options.setErrorOnFailure !== false;
	                if (useLoading) {
	                    setLoading(true);
	                }
	                if (setErrors && options.clearError !== false) {
	                    setError('');
	                }

                try {
                    const sprintParam = options.sprintOverride !== undefined ? options.sprintOverride : (selectedSprint || '');
                    // Add cache busting parameter and sprint parameter
                    const params = new URLSearchParams({
                        t: Date.now().toString(),
                        sprint: sprintParam,
                        // always pull all teams; filtering happens client-side so capacity table can show every team
                        team: 'all',
                        project: project || 'all'
                    });
                    const response = await fetch(`${BACKEND_URL}/api/tasks-with-team-name?${params}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        cache: 'no-cache'
                    });

                    console.log('Response status:', response.status);
                    console.log('Response ok:', response.ok);

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ 
                            error: `HTTP ${response.status}` 
                        }));
                        console.error('Error data:', errorData);
                        throw new Error(errorData.error || `Error ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('Success! Received data:', data);

                    // Sort by priority
                    const sortedTasks = (data.issues || []).sort((a, b) => {
                        const priorityA = priorityOrder[a.fields.priority?.name] || 999;
                        const priorityB = priorityOrder[b.fields.priority?.name] || 999;
                        return priorityA - priorityB;
                    });

	                    if (options.updateEpics !== false) {
	                        setEpicDetails(prev => ({ ...prev, ...(data.epics || {}) }));
	                        if (project === 'product') {
	                            setProductEpicsInScope(data.epicsInScope || []);
	                        } else if (project === 'tech') {
	                            setTechEpicsInScope(data.epicsInScope || []);
	                        }
	                    }
	                    if (options.epicsInScopeSetter) {
	                        options.epicsInScopeSetter(data.epicsInScope || []);
	                    }
	                    return sortedTasks;
	                } catch (err) {
                    if (setErrors) {
                        const errorMsg = `Failed to load tasks: ${err.message}. Make sure the Python server is running on ${BACKEND_URL}`;
                        setError(errorMsg);
                    }
                    console.error('Full error details:', err);
                    return [];
                } finally {
                    if (useLoading) {
                        setLoading(false);
                    }
                }
            };

            const loadProductTasks = async () => {
                const data = await fetchTasks('product');
                setProductTasks(data);
            };

            const loadTechTasks = async () => {
                const data = await fetchTasks('tech');
                setTechTasks(data);
                setTechLoaded(true);
            };

	            const loadReadyToCloseProductTasks = async () => {
	                const data = await fetchTasks('product', {
	                    sprintOverride: '',
	                    updateEpics: false,
	                    epicsInScopeSetter: setReadyToCloseProductEpicsInScope,
	                    useLoading: false,
	                    setErrorOnFailure: false
	                });
	                setReadyToCloseProductTasks(data);
	            };

	            const loadReadyToCloseTechTasks = async () => {
	                const data = await fetchTasks('tech', {
	                    sprintOverride: '',
	                    updateEpics: false,
	                    epicsInScopeSetter: setReadyToCloseTechEpicsInScope,
	                    useLoading: false,
	                    setErrorOnFailure: false
	                });
	                setReadyToCloseTechTasks(data);
	            };

            useEffect(() => {
                loadReadyToCloseProductTasks();
                loadReadyToCloseTechTasks();
            }, []);


            const formatPercent = (value) => `${(value * 100).toFixed(2)}%`;

            const priorityWeights = {
                blocker: 0.4,
                critical: 0.3,
                major: 0.2,
                minor: 0.06,
                low: 0.03,
                trivial: 0.01
            };

            const priorityAliases = {
                highest: 'blocker',
                high: 'major',
                medium: 'minor',
                lowest: 'trivial'
            };

            const normalizePriority = (name) => {
                const key = String(name || '').toLowerCase().trim();
                return priorityAliases[key] || key;
            };

            const getPriorityLabel = (name) => {
                const key = normalizePriority(name);
                return priorityLabelByKey[key] || name;
            };

            const computePriorityWeighted = (priorities) => {
                const totals = { done: 0, incomplete: 0, killed: 0 };
                Object.entries(priorities || {}).forEach(([priorityName, counts]) => {
                    const normalized = normalizePriority(priorityName);
                    const weight = priorityWeights[normalized] || 0;
                    totals.done += weight * (counts.done || 0);
                    totals.incomplete += weight * (counts.incomplete || 0);
                    totals.killed += weight * (counts.killed || 0);
                });
                return totals;
            };

            const computeRate = (metrics) => {
                const done = metrics.done || 0;
                const incomplete = metrics.incomplete || 0;
                const denom = done + incomplete;
                return denom > 0 ? done / denom : 0;
            };

            const getRateClass = (rate) => {
                if (rate >= 1) return 'good';
                if (rate >= 0.6 && rate < 0.8) return 'warn';
                if (rate < 0.6) return 'bad';
                return '';
            };

            const normalizeCapacityKey = (name) => {
                if (!name) return '';
                return String(name)
                    .replace(/\u00a0/g, ' ')
                    .replace(/^\[archived\]\s*/i, '')
                    .replace(/^r&d\s+/i, '')
                    .replace(/^(product|tech)\s*-\s*/i, '')
                    .replace(/\s+/g, ' ')
                    .trim()
                    .toLowerCase();
            };

            const toCapacityShortName = (name) => {
                if (!name) return '';
                return String(name)
                    .replace(/\u00a0/g, ' ')
                    .replace(/^\[archived\]\s*/i, '')
                    .replace(/^r&d\s+/i, '')
                    .replace(/^(product|tech)\s*-\s*/i, '')
                    .replace(/\s+/g, ' ')
                    .trim();
            };

            const buildRadarPoints = ({ values, radius, center, maxValue, axes }) => {
                const count = axes.length;
                return axes.map((axis, index) => {
                    const value = Math.max(0, values[axis] || 0);
                    const ratio = maxValue > 0 ? value / maxValue : 0;
                    const angle = (Math.PI * 2 * index) / count - Math.PI / 2;
                    const r = ratio * radius;
                    const x = center + r * Math.cos(angle);
                    const y = center + r * Math.sin(angle);
                    return `${x.toFixed(2)},${y.toFixed(2)}`;
                }).join(' ');
            };

            const buildLocalStatsFromTasks = (taskList, excludedSet) => {
                const teams = {};
                const projectsSummary = {
                    product: { done: 0, incomplete: 0, killed: 0, priorities: {} },
                    tech: { done: 0, incomplete: 0, killed: 0, priorities: {} }
                };
                const totals = { done: 0, incomplete: 0, killed: 0 };
                const storyPointsTotals = { total: 0, done: 0, incomplete: 0, killed: 0 };

                const bumpPriority = (target, priorityName, bucket) => {
                    if (!target.priorities) target.priorities = {};
                    if (!target.priorities[priorityName]) {
                        target.priorities[priorityName] = { done: 0, incomplete: 0, killed: 0 };
                    }
                    target.priorities[priorityName][bucket] += 1;
                };

                const bumpPriorityPoints = (target, priorityName, points) => {
                    if (!target.priorityPoints) target.priorityPoints = {};
                    if (!target.priorityPoints[priorityName]) {
                        target.priorityPoints[priorityName] = 0;
                    }
                    target.priorityPoints[priorityName] += points;
                };

                (taskList || []).forEach(task => {
                    const epicKey = task.fields?.epicKey || 'NO_EPIC';
                    if (excludedSet?.has(epicKey)) {
                        return;
                    }
                    const status = normalizeStatus(task.fields?.status?.name);
                    const isKilled = status === 'killed';
                    const isDone = status === 'done';
                    const priorityName = task.fields?.priority?.name || 'Unspecified';
                    const pointsRaw = task.fields?.customfield_10004;
                    const pointsValue = Number(pointsRaw);
                    const storyPoints = Number.isFinite(pointsValue) ? pointsValue : 0;
                    storyPointsTotals.total += storyPoints;
                    const teamInfo = getTeamInfo(task);
                    const teamKey = teamInfo.id || teamInfo.name || 'unknown';
                    const projectBucket = String(task.key || '').startsWith('TECH-') ? 'tech' : 'product';

                    if (!teams[teamKey]) {
                        teams[teamKey] = {
                            id: teamInfo.id || teamKey,
                            name: teamInfo.name || teamKey,
                            done: 0,
                            incomplete: 0,
                            killed: 0,
                            priorities: {},
                            priorityPoints: {},
                            projects: {
                                product: { done: 0, incomplete: 0, killed: 0, priorities: {} },
                                tech: { done: 0, incomplete: 0, killed: 0, priorities: {} }
                            }
                        };
                    }

                    const teamEntry = teams[teamKey];
                    if (isKilled) {
                        teamEntry.killed += 1;
                        teamEntry.projects[projectBucket].killed += 1;
                        projectsSummary[projectBucket].killed += 1;
                        totals.killed += 1;
                        storyPointsTotals.killed += storyPoints;
                        bumpPriority(teamEntry, priorityName, 'killed');
                        bumpPriority(teamEntry.projects[projectBucket], priorityName, 'killed');
                        bumpPriority(projectsSummary[projectBucket], priorityName, 'killed');
                        return;
                    }

                    bumpPriorityPoints(teamEntry, priorityName, storyPoints);
                    if (isDone) {
                        teamEntry.done += 1;
                        teamEntry.projects[projectBucket].done += 1;
                        projectsSummary[projectBucket].done += 1;
                        totals.done += 1;
                        storyPointsTotals.done += storyPoints;
                        bumpPriority(teamEntry, priorityName, 'done');
                        bumpPriority(teamEntry.projects[projectBucket], priorityName, 'done');
                        bumpPriority(projectsSummary[projectBucket], priorityName, 'done');
                        return;
                    }

                    teamEntry.incomplete += 1;
                    teamEntry.projects[projectBucket].incomplete += 1;
                    projectsSummary[projectBucket].incomplete += 1;
                    totals.incomplete += 1;
                    storyPointsTotals.incomplete += storyPoints;
                    bumpPriority(teamEntry, priorityName, 'incomplete');
                    bumpPriority(teamEntry.projects[projectBucket], priorityName, 'incomplete');
                    bumpPriority(projectsSummary[projectBucket], priorityName, 'incomplete');
                });

                const sortedTeams = Object.values(teams).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                return {
                    sprint: selectedSprintInfo?.name || '',
                    totals,
                    storyPoints: storyPointsTotals,
                    projects: projectsSummary,
                    teams: sortedTeams
                };
            };

	            const tasks = showTech ? [...productTasks, ...techTasks] : [...productTasks];
	            const capacityTasks = [...productTasks, ...techTasks];
	            const readyToCloseTasks = [...readyToCloseProductTasks, ...readyToCloseTechTasks];
	            const epicsInScope = React.useMemo(() => {
	                const seen = new Set();
	                const merged = [...productEpicsInScope, ...techEpicsInScope].filter(epic => {
	                    if (!epic?.key) return false;
	                    if (seen.has(epic.key)) return false;
	                    seen.add(epic.key);
	                    return true;
	                });
	                return merged;
	            }, [productEpicsInScope, techEpicsInScope]);
	            const readyToCloseEpicsInScope = React.useMemo(() => {
	                const seen = new Set();
	                const merged = [...readyToCloseProductEpicsInScope, ...readyToCloseTechEpicsInScope].filter(epic => {
	                    if (!epic?.key) return false;
	                    if (seen.has(epic.key)) return false;
	                    seen.add(epic.key);
	                    return true;
	                });
	                return merged;
	            }, [readyToCloseProductEpicsInScope, readyToCloseTechEpicsInScope]);
            const killedTasks = tasks.filter(t => t.fields.status?.name === 'Killed');
            const doneTasks = tasks.filter(t => t.fields.status?.name === 'Done');
            const techTasksCount = techTasks.length;
            const productTasksCount = productTasks.length;

            const teamOptions = ['all', ...new Set(capacityTasks.map(t => getTeamInfo(t).id || 'unknown'))]
                .map(id => ({ id, name: id === 'all' ? 'All Teams' : getTeamInfo(capacityTasks.find(t => getTeamInfo(t).id === id) || {}).name }))
                .filter((team, index, arr) => arr.findIndex(t => t.id === team.id) === index);
            const teamNameById = React.useMemo(() => {
                const map = new Map();
                teamOptions.forEach(team => {
                    if (team.id && team.id !== 'all') {
                        map.set(team.id, team.name);
                    }
                });
                return map;
            }, [teamOptions]);

            const selectedSprintInfo = React.useMemo(() => {
                if (!selectedSprint) return null;
                return (availableSprints || []).find(sprint => String(sprint.id) === String(selectedSprint)) || null;
            }, [availableSprints, selectedSprint]);
            const selectedSprintState = (selectedSprintInfo?.state || '').toLowerCase();
            const isCompletedSprintSelected = selectedSprintState === 'closed';
            const isFutureSprintSelected = selectedSprintState === 'future';
            const selectedTeamSet = React.useMemo(() => new Set(selectedTeams.filter(id => id !== 'all')), [selectedTeams]);
            const isAllTeamsSelected = selectedTeams.includes('all') || selectedTeamSet.size === 0;

            const selectedTeamsLabel = React.useMemo(() => {
                if (isAllTeamsSelected) return 'All Teams';
                if (selectedTeamSet.size === 1) {
                    const id = Array.from(selectedTeamSet)[0];
                    return teamNameById.get(id) || '1 Team';
                }
                return `${selectedTeamSet.size} Teams`;
            }, [isAllTeamsSelected, selectedTeamSet, teamNameById]);

            const toggleTeamSelection = (teamId) => {
                if (teamId === 'all') {
                    setSelectedTeams(['all']);
                    return;
                }
                setSelectedTeams((prev) => {
                    const next = new Set((prev || []).filter(id => id !== 'all'));
                    if (next.has(teamId)) {
                        next.delete(teamId);
                    } else {
                        next.add(teamId);
                    }
                    return next.size ? Array.from(next) : ['all'];
                });
            };

            const excludedEpicSet = React.useMemo(() => new Set(excludedStatsEpics || []), [excludedStatsEpics]);
            const localStatsData = React.useMemo(() => {
                if (!capacityTasks.length) return null;
                return buildLocalStatsFromTasks(capacityTasks, excludedEpicSet);
            }, [capacityTasks, selectedSprintInfo?.name, excludedEpicSet]);

            const effectiveStatsData = localStatsData;

            useEffect(() => {
                if (isCompletedSprintSelected && showPlanning) {
                    setShowPlanning(false);
                }
            }, [isCompletedSprintSelected, showPlanning]);

            useEffect(() => {
                if (isFutureSprintSelected && showStats) {
                    setShowStats(false);
                }
            }, [isFutureSprintSelected, showStats]);

            const baseFilteredTasks = tasks.filter(task => {
                // Filter by search query
                if (searchQuery.trim() !== '') {
	                    const query = searchQuery.toLowerCase();
	                    const summary = task.fields.summary?.toLowerCase() || '';
	                    const key = String(task.key || '').toLowerCase();
	                    const assignee = task.fields.assignee?.displayName?.toLowerCase() || '';
                    const epicKey = String(task.fields.epicKey || '').toLowerCase();
                    const epicSummary = task.fields.epicKey ? (epicDetails[task.fields.epicKey]?.summary?.toLowerCase() || '') : '';
                    const epicAssignee = task.fields.epicKey ? (epicDetails[task.fields.epicKey]?.assignee?.displayName?.toLowerCase() || '') : '';

                    if (!summary.includes(query) && !key.includes(query) && !assignee.includes(query) &&
                        !epicAssignee.includes(query) && !epicKey.includes(query) && !epicSummary.includes(query)) {
                        return false;
                    }
                }

                // Filter by Team
                if (!isAllTeamsSelected) {
                    const teamInfo = getTeamInfo(task);
                    if (!selectedTeamSet.has(teamInfo.id)) {
                        return false;
                    }
                }

                // Filter by Killed status
                if (!showKilled && task.fields.status?.name === 'Killed') {
                    return false;
                }

                // Filter by Done status
                if (!showDone && task.fields.status?.name === 'Done') {
                    return false;
                }

                // Filter by task type
                const isTech = task.key.startsWith('TECH-');
                if (isTech && !showTech) {
                    return false;
                }
                if (!isTech && !showProduct) {
                    return false;
                }
                return true;
            });

            const visibleTasks = baseFilteredTasks.filter(task => {
                // Filter by status (from clickable elements)
                if (statusFilter === 'in-progress') {
                    return task.fields.status?.name === 'In Progress';
                }
                if (statusFilter === 'todo-accepted') {
                    const status = task.fields.status?.name;
                    return status === 'To Do' || status === 'Pending' || status === 'Accepted';
                }
                if (statusFilter === 'done') {
                    return task.fields.status?.name === 'Done';
                }
                if (statusFilter === 'high-priority') {
                    const priority = task.fields.priority?.name;
                    return priority === 'Blocker' || priority === 'Highest' ||
                           priority === 'Critical' || priority === 'High';
                }
                if (statusFilter === 'minor-priority') {
                    const priority = task.fields.priority?.name;
                    return priority === 'Minor' || priority === 'Low' ||
                           priority === 'Trivial' || priority === 'Lowest';
                }
                return true;
            });

            const statsTeams = effectiveStatsData?.teams || [];
            const allowedStatsTeamIds = React.useMemo(() => {
                if (!isAllTeamsSelected) {
                    return new Set(Array.from(selectedTeamSet));
                }
                return null;
            }, [isAllTeamsSelected, selectedTeamSet]);

            const filteredStatsTeams = statsTeams.filter(team => {
                if (!allowedStatsTeamIds) return true;
                const id = team.id || team.name || 'unknown';
                return allowedStatsTeamIds.has(id);
            });

            const priorityTeamIds = React.useMemo(() => {
                if (!isAllTeamsSelected) {
                    return Array.from(selectedTeamSet);
                }
                return teamOptions
                    .map(team => team.id)
                    .filter(id => id && id !== 'all');
            }, [isAllTeamsSelected, selectedTeamSet, teamOptions]);

            const getStatsTeamLabel = (team) => {
                if (!team) return 'Unknown Team';
                if (!isAllTeamsSelected && team.id && teamNameById.has(team.id)) {
                    return teamNameById.get(team.id);
                }
                return team.name || team.id || 'Unknown Team';
            };

            const priorityRows = React.useMemo(() => {
                const totals = {};
                const pointsTotals = {};
                (filteredStatsTeams || []).forEach(team => {
                    Object.entries(team.priorities || {}).forEach(([priorityName, counts]) => {
                        const label = getPriorityLabel(priorityName);
                        if (!totals[label]) {
                            totals[label] = { done: 0, incomplete: 0, killed: 0 };
                        }
                        totals[label].done += counts.done || 0;
                        totals[label].incomplete += counts.incomplete || 0;
                        totals[label].killed += counts.killed || 0;
                    });
                    Object.entries(team.priorityPoints || {}).forEach(([priorityName, points]) => {
                        const label = getPriorityLabel(priorityName);
                        pointsTotals[label] = (pointsTotals[label] || 0) + (points || 0);
                    });
                });
                return Object.entries(totals)
                    .map(([name, counts]) => ({
                        name,
                        done: counts.done,
                        incomplete: counts.incomplete,
                        killed: counts.killed,
                        rate: computeRate(counts),
                        points: pointsTotals[name] || 0
                    }))
                    .sort((a, b) => {
                        const orderA = priorityOrder[a.name] || 999;
                        const orderB = priorityOrder[b.name] || 999;
                        if (orderA !== orderB) return orderA - orderB;
                        return String(a.name || '').localeCompare(String(b.name || ''));
                    });
            }, [filteredStatsTeams, priorityOrder]);

            const priorityRadar = React.useMemo(() => {
                const series = (filteredStatsTeams || []).map(team => {
                    const pointsByPriority = {};
                    Object.entries(team.priorityPoints || {}).forEach(([priorityName, points]) => {
                        const label = getPriorityLabel(priorityName);
                        pointsByPriority[label] = (pointsByPriority[label] || 0) + (points || 0);
                    });
                    return {
                        id: team.id || team.name || 'unknown',
                        name: getStatsTeamLabel(team),
                        pointsByPriority
                    };
                });
                const maxValue = Math.max(
                    1,
                    ...series.flatMap(item => priorityAxis.map(axis => item.pointsByPriority[axis] || 0))
                );
                return { series, maxValue };
            }, [filteredStatsTeams, getStatsTeamLabel, priorityAxis]);

            const getTeamScopedMetrics = (team, projectKey = 'all') => {
                if (!team) {
                    return { done: 0, incomplete: 0, killed: 0, priorities: {} };
                }
                if (projectKey === 'all') {
                    return {
                        done: team.done || 0,
                        incomplete: team.incomplete || 0,
                        killed: team.killed || 0,
                        priorities: team.priorities || {}
                    };
                }
                const projectScope = team.projects?.[projectKey];
                return {
                    done: projectScope?.done || 0,
                    incomplete: projectScope?.incomplete || 0,
                    killed: projectScope?.killed || 0,
                    priorities: projectScope?.priorities || {}
                };
            };

            const statsTeamRows = filteredStatsTeams.map(team => {
                const scoped = getTeamScopedMetrics(team);
                const scopedProduct = getTeamScopedMetrics(team, 'product');
                const scopedTech = getTeamScopedMetrics(team, 'tech');
                const weighted = computePriorityWeighted(scoped.priorities);
                const weightedProduct = computePriorityWeighted(scopedProduct.priorities);
                const weightedTech = computePriorityWeighted(scopedTech.priorities);
                const straightRate = computeRate(scoped);
                const weightedRate = computeRate(weighted);
                return {
                    id: team.id || team.name || 'unknown',
                    name: getStatsTeamLabel(team),
                    straight: scoped,
                    product: scopedProduct,
                    tech: scopedTech,
                    weighted,
                    weightedProduct,
                    weightedTech,
                    straightRate,
                    weightedRate,
                    priorityPoints: team.priorityPoints || {}
                };
            });

            const statsTotals = statsTeamRows.reduce((acc, row) => {
                acc.straight.done += row.straight.done;
                acc.straight.incomplete += row.straight.incomplete;
                acc.straight.killed += row.straight.killed;
                acc.product.done += row.product.done;
                acc.product.incomplete += row.product.incomplete;
                acc.product.killed += row.product.killed;
                acc.tech.done += row.tech.done;
                acc.tech.incomplete += row.tech.incomplete;
                acc.tech.killed += row.tech.killed;
                acc.weighted.done += row.weighted.done;
                acc.weighted.incomplete += row.weighted.incomplete;
                acc.weighted.killed += row.weighted.killed;
                acc.weightedProduct.done += row.weightedProduct.done;
                acc.weightedProduct.incomplete += row.weightedProduct.incomplete;
                acc.weightedProduct.killed += row.weightedProduct.killed;
                acc.weightedTech.done += row.weightedTech.done;
                acc.weightedTech.incomplete += row.weightedTech.incomplete;
                acc.weightedTech.killed += row.weightedTech.killed;
                return acc;
            }, {
                straight: { done: 0, incomplete: 0, killed: 0 },
                product: { done: 0, incomplete: 0, killed: 0 },
                tech: { done: 0, incomplete: 0, killed: 0 },
                weighted: { done: 0, incomplete: 0, killed: 0 },
                weightedProduct: { done: 0, incomplete: 0, killed: 0 },
                weightedTech: { done: 0, incomplete: 0, killed: 0 }
            });
            const statsStoryPointsTotal = effectiveStatsData?.storyPoints?.total || 0;

            const groupTasksByEpic = (taskList) => {
                const grouped = {};
                taskList.forEach(task => {
                    const epicKey = task.fields.epicKey || 'NO_EPIC';
                    if (!grouped[epicKey]) {
                        if (epicOrderRef.current[epicKey] === undefined) {
                            epicOrderRef.current[epicKey] = epicOrderCounterRef.current++;
                        }
                        grouped[epicKey] = {
                            epic: epicDetails[epicKey] || null,
                            key: epicKey,
                            tasks: [],
                            storyPoints: 0,
                            parentSummary: task.fields.parentSummary || null
                        };
                    }

                    grouped[epicKey].tasks.push(task);
                    const sp = parseFloat(task.fields.customfield_10004 || 0);
                    if (!Number.isNaN(sp)) {
                        grouped[epicKey].storyPoints += sp;
                    }
                    if (!grouped[epicKey].parentSummary && task.fields.parentSummary) {
                        grouped[epicKey].parentSummary = task.fields.parentSummary;
                    }
                });
                return grouped;
            };

            const epicGroups = Object.values(groupTasksByEpic(visibleTasks))
                .sort((a, b) => (epicOrderRef.current[a.key] ?? 999999) - (epicOrderRef.current[b.key] ?? 999999));

            const highPriorityCount = baseFilteredTasks.filter(t => {
                const priority = t.fields.priority?.name;
                return priority === 'Blocker' || priority === 'Highest' ||
                       priority === 'Critical' || priority === 'High';
            }).length;

            const minorPriorityCount = baseFilteredTasks.filter(t => {
                const priority = t.fields.priority?.name;
                return priority === 'Minor' || priority === 'Low' ||
                       priority === 'Trivial' || priority === 'Lowest';
            }).length;

            const doneTasksCount = baseFilteredTasks.filter(t =>
                t.fields.status?.name === 'Done'
            ).length;

            const inProgressTasksCount = baseFilteredTasks.filter(t =>
                t.fields.status?.name === 'In Progress'
            ).length;

            const todoAcceptedTasksCount = baseFilteredTasks.filter(t => {
                const status = t.fields.status?.name;
                return status === 'To Do' || status === 'Pending' || status === 'Accepted';
            }).length;

            const sumStoryPoints = (taskList) => taskList.reduce((sum, task) => {
                const sp = parseFloat(task.fields.customfield_10004 || 0);
                return sum + (Number.isNaN(sp) ? 0 : sp);
            }, 0);

            const totalStoryPoints = sumStoryPoints(baseFilteredTasks);
            const doneStoryPoints = sumStoryPoints(baseFilteredTasks.filter(t => t.fields.status?.name === 'Done'));
            const highPriorityStoryPoints = sumStoryPoints(baseFilteredTasks.filter(t => {
                const priority = t.fields.priority?.name;
                return priority === 'Blocker' || priority === 'Highest' ||
                       priority === 'Critical' || priority === 'High';
            }));
            const minorPriorityStoryPoints = sumStoryPoints(baseFilteredTasks.filter(t => {
                const priority = t.fields.priority?.name;
                return priority === 'Minor' || priority === 'Low' ||
                       priority === 'Trivial' || priority === 'Lowest';
            }));
            const inProgressStoryPoints = sumStoryPoints(baseFilteredTasks.filter(t => t.fields.status?.name === 'In Progress'));
            const todoAcceptedStoryPoints = sumStoryPoints(baseFilteredTasks.filter(t => {
                const status = t.fields.status?.name;
                return status === 'To Do' || status === 'Pending' || status === 'Accepted';
            }));

            const removeTask = (taskKey) => {
                setProductTasks(prev => prev.filter(t => t.key !== taskKey));
                setTechTasks(prev => prev.filter(t => t.key !== taskKey));
            };

            const toggleTaskSelection = (taskKey) => {
                setSelectedTasks(prev => {
                    const newSelected = { ...prev };
                    if (newSelected[taskKey]) {
                        delete newSelected[taskKey];
                    } else {
                        newSelected[taskKey] = true;
                    }
                    return newSelected;
                });
            };

            const clearSelectedTasks = () => {
                setSelectedTasks({});
            };

            const selectPlanningTasksByStatus = (statuses) => {
                const allowed = new Set((statuses || []).map(normalizeStatus));
                setSelectedTasks(() => {
                    const next = {};
                    visibleTasks.forEach(task => {
                        const status = normalizeStatus(task.fields.status?.name);
                        if (allowed.has(status)) {
                            next[task.key] = true;
                        }
                    });
                    return next;
                });
            };

            const includePlanningTasksByStatus = (statuses) => {
                const allowed = new Set((statuses || []).map(normalizeStatus));
                setSelectedTasks(prev => {
                    const next = { ...prev };
                    visibleTasks.forEach(task => {
                        const status = normalizeStatus(task.fields.status?.name);
                        if (allowed.has(status)) {
                            next[task.key] = true;
                        }
                    });
                    return next;
                });
            };

            const toggleIncludeByStatus = (statuses) => {
                const allowed = new Set((statuses || []).map(normalizeStatus));
                setSelectedTasks(prev => {
                    const next = { ...prev };
                    const matching = visibleTasks.filter(task =>
                        allowed.has(normalizeStatus(task.fields.status?.name))
                    );
                    const allSelected = matching.length > 0 && matching.every(task => prev[task.key]);
                    matching.forEach(task => {
                        if (allSelected) {
                            delete next[task.key];
                        } else {
                            next[task.key] = true;
                        }
                    });
                    return next;
                });
            };

            // Calculate sum of Story Points for selected tasks
            const calculateSelectedSP = () => {
                let sum = 0;
                visibleTasks.forEach(task => {
                    if (selectedTasks[task.key]) {
                        const sp = task.fields.customfield_10004;
                        if (sp) {
                            sum += parseFloat(sp);
                        }
                    }
                });
                return sum;
            };

            const selectedTasksList = visibleTasks.filter(task => selectedTasks[task.key]);
            const acceptedTasks = visibleTasks.filter(task =>
                normalizeStatus(task.fields.status?.name) === 'accepted'
            );
            const todoPendingTasks = visibleTasks.filter(task => {
                const status = normalizeStatus(task.fields.status?.name);
                return status === 'to do' || status === 'pending';
            });
            const isAcceptedIncluded = acceptedTasks.length > 0 &&
                acceptedTasks.every(task => selectedTasks[task.key]);
            const isTodoIncluded = todoPendingTasks.length > 0 &&
                todoPendingTasks.every(task => selectedTasks[task.key]);

            const selectedPlanningTasksList = selectedTasksList.filter(task => {
                const epicKey = task.fields?.epicKey || 'NO_EPIC';
                return !excludedEpicSet.has(epicKey);
            });
            const selectedSP = selectedTasksList.reduce((sum, task) => {
                const sp = parseFloat(task.fields.customfield_10004 || 0);
                return sum + (Number.isNaN(sp) ? 0 : sp);
            }, 0);
            const selectedCount = selectedTasksList.length;

            const getCapacityStatus = (selected, capacity) => {
                if (!capacity) {
                    return { label: '', text: '', status: '', title: '' };
                }
                const ratio = capacity > 0 ? selected / capacity : 0;
                const overPercent = Math.max(0, (ratio - 1) * 100);
                const underPercent = Math.max(0, (1 - ratio) * 100);
                const status = ratio > 1.2 ? 'over' : ratio < 0.9 ? 'under' : '';
                const suffix = ratio >= 1
                    ? `${overPercent.toFixed(0)}% over`
                    : `${underPercent.toFixed(0)}% under`;
                const shortLabel = ratio >= 1
                    ? `${overPercent.toFixed(0)}% over`
                    : `${underPercent.toFixed(0)}% under`;
                const minToRemove = ratio > 1.2 ? (ratio - 1.2) * capacity : 0;
                const minToAdd = ratio < 0.9 ? (0.9 - ratio) * capacity : 0;
                const title = ratio > 1.2
                    ? `Please remove at least ${minToRemove.toFixed(1)} SP to reach 120%.`
                    : ratio < 0.9
                        ? `Please add at least ${minToAdd.toFixed(1)} SP to reach 90%.`
                        : '';
                return {
                    label: shortLabel,
                    text: `${selected.toFixed(1)} selected | ${capacity.toFixed(1)} capacity | ${suffix}`,
                    status,
                    title
                };
            };

            const getTeamCapacityMeta = (selected, capacity) => {
                if (!capacity) return { text: '', status: '', title: '' };
                const delta = selected - capacity;
                if (delta <= 0) {
                    return {
                        text: `${Math.abs(delta).toFixed(1)} SP left`,
                        status: '',
                        title: ''
                    };
                }
                const pct = capacity > 0 ? (delta / capacity) * 100 : 0;
                const status = pct >= 20 ? 'over' : '';
                return {
                    text: `â ${delta.toFixed(1)} SP Â· ${pct.toFixed(0)}%`,
                    status,
                    title: 'Please remove some story points or add capacity.'
                };
            };


            const selectedTeamStats = selectedPlanningTasksList.reduce((acc, task) => {
                const teamInfo = getTeamInfo(task);
                const sp = parseFloat(task.fields.customfield_10004 || 0);
                if (!acc[teamInfo.id]) {
                    acc[teamInfo.id] = { name: teamInfo.name, storyPoints: 0 };
                }
                acc[teamInfo.id].storyPoints += sp;
                return acc;
            }, {});

            const selectedProjectStats = selectedPlanningTasksList.reduce((acc, task) => {
                const projectKey = task.key.startsWith('TECH-') ? 'TECH' : 'PRODUCT';
                const sp = parseFloat(task.fields.customfield_10004 || 0);
                if (!acc[projectKey]) {
                    acc[projectKey] = 0;
                }
                acc[projectKey] += sp;
                return acc;
            }, {});

            const selectedTeamProjectStats = selectedPlanningTasksList.reduce((acc, task) => {
                const teamInfo = getTeamInfo(task);
                const bucket = task.key.startsWith('TECH-') ? 'tech' : 'product';
                const sp = parseFloat(task.fields.customfield_10004 || 0);
                if (!acc[teamInfo.id]) {
                    acc[teamInfo.id] = { product: 0, tech: 0 };
                }
                acc[teamInfo.id][bucket] += Number.isNaN(sp) ? 0 : sp;
                return acc;
            }, {});

            const capacitySplit = { product: 0.7, tech: 0.3 };
            const capacityMultiplier = showProduct && showTech
                ? 1
                : showProduct
                    ? capacitySplit.product
                    : showTech
                        ? capacitySplit.tech
                        : 1;

            const teamCapacityStats = capacityTasks.reduce((acc, task) => {
                const status = normalizeStatus(task.fields.status?.name);
                const sp = parseFloat(task.fields.customfield_10004 || 0);
                if (!sp) {
                    return acc;
                }

                const teamInfo = getTeamInfo(task);
                if (!acc[teamInfo.id]) {
                    acc[teamInfo.id] = {
                        name: teamInfo.name,
                        product: { todoPending: 0, accepted: 0, postponed: 0 },
                        tech: { todoPending: 0, accepted: 0, postponed: 0 }
                    };
                }

                const bucket = task.key.startsWith('TECH-') ? 'tech' : 'product';
                if (status === 'to do' || status === 'pending') {
                    acc[teamInfo.id][bucket].todoPending += sp;
                }
                if (status === 'accepted') {
                    acc[teamInfo.id][bucket].accepted += sp;
                }
                if (status === 'postponed') {
                    acc[teamInfo.id][bucket].postponed += sp;
                }

                return acc;
            }, {});

            const teamCapacityEntries = Object.entries(teamCapacityStats)
                .map(([id, info]) => ({
                    id,
                    name: info.name,
                    product: info.product,
                    tech: info.tech,
                    total: {
                        todoPending: info.product.todoPending + info.tech.todoPending,
                        accepted: info.product.accepted + info.tech.accepted,
                        postponed: info.product.postponed + info.tech.postponed
                    }
                }))
                .sort((a, b) => a.name.localeCompare(b.name));

            const displayedTeamCapacityEntries = !isAllTeamsSelected
                ? teamCapacityEntries.filter(entry => selectedTeamSet.has(entry.id))
                : teamCapacityEntries;

            const displayedTeamOptions = !isAllTeamsSelected
                ? teamOptions.filter(team => team.id !== 'all' && selectedTeamSet.has(team.id))
                : teamOptions.filter(team => team.id !== 'all');

            const capacityTeamNames = React.useMemo(() => (
                displayedTeamOptions
                    .map(team => toCapacityShortName(team.name))
                    .filter(Boolean)
            ), [displayedTeamOptions]);

            useEffect(() => {
                if (!capacityEnabled) return;
                if (!selectedSprintInfo?.name) return;
                fetchCapacity(selectedSprintInfo.name);
            }, [capacityEnabled, selectedSprintInfo?.name, capacityTeamNames.join('|')]);

            const capacityTeamIds = !isAllTeamsSelected
                ? Array.from(selectedTeamSet)
                : teamCapacityEntries.map(entry => entry.id);

            const getTeamCapacity = (teamName) => {
                if (!capacityEnabled) return 0;
                const key = normalizeCapacityKey(teamName);
                if (!key) return 0;
                if (capacityByTeam[key]) return capacityByTeam[key];
                const entry = Object.entries(capacityByTeam).find(([capacityKey]) =>
                    capacityKey.includes(key) || key.includes(capacityKey)
                );
                return entry ? entry[1] : 0;
            };

            const excludedCapacityByTeamId = React.useMemo(() => {
                if (!capacityEnabled) return {};
                return capacityTasks.reduce((acc, task) => {
                    const epicKey = task.fields?.epicKey || 'NO_EPIC';
                    if (!excludedEpicSet.has(epicKey)) return acc;
                    const teamInfo = getTeamInfo(task);
                    const sp = parseFloat(task.fields.customfield_10004 || 0);
                    if (Number.isNaN(sp)) return acc;
                    acc[teamInfo.id] = (acc[teamInfo.id] || 0) + sp;
                    return acc;
                }, {});
            }, [capacityEnabled, capacityTasks, excludedEpicSet]);

            const getTeamNetCapacity = (team) => {
                if (!capacityEnabled) return 0;
                const base = getTeamCapacity(team.name);
                const excluded = excludedCapacityByTeamId[team.id] || 0;
                return Math.max(0, base - excluded);
            };

            const totalCapacityBase = capacityEnabled
                ? displayedTeamOptions.reduce((sum, team) => sum + getTeamCapacity(team.name), 0)
                : 0;
            const excludedCapacityTotal = capacityEnabled
                ? displayedTeamOptions.reduce((sum, team) => sum + (excludedCapacityByTeamId[team.id] || 0), 0)
                : 0;
            const estimatedCapacityRaw = Math.max(0, totalCapacityBase - excludedCapacityTotal);
            const totalCapacityAdjusted = totalCapacityBase * capacityMultiplier;
            const estimatedCapacityAdjusted = estimatedCapacityRaw * capacityMultiplier;
            const selectedPlanningSP = selectedPlanningTasksList.reduce((sum, task) => {
                const sp = parseFloat(task.fields.customfield_10004 || 0);
                return sum + (Number.isNaN(sp) ? 0 : sp);
            }, 0);
            const capacitySummary = getCapacityStatus(selectedSP, totalCapacityAdjusted);

            const projectCapacity = displayedTeamOptions.reduce((acc, team) => {
                const teamPlanningCapacity = getTeamNetCapacity(team);
                if (!teamPlanningCapacity) return acc;
                const stats = selectedTeamProjectStats[team.id] || { product: 0, tech: 0 };
                const totalSelected = stats.product + stats.tech;
                const techHeavy = totalSelected > 0 ? stats.tech >= stats.product : false;
                const split = techHeavy ? { product: 0.2, tech: 0.8 } : capacitySplit;
                acc.PRODUCT += teamPlanningCapacity * split.product;
                acc.TECH += teamPlanningCapacity * split.tech;
                return acc;
            }, {
                PRODUCT: 0,
                TECH: 0
            });
            if (!showProduct) projectCapacity.PRODUCT = 0;
            if (!showTech) projectCapacity.TECH = 0;

            const selectedProjectEntries = Object.entries(selectedProjectStats)
                .map(([id, storyPoints]) => ({
                    id,
                    name: id,
                    storyPoints,
                    capacity: capacityEnabled ? (projectCapacity[id] || 0) : null
                }))
                .sort((a, b) => {
                    const order = (key) => {
                        if (key === 'PRODUCT') return 0;
                        if (key === 'TECH') return 1;
                        return 99;
                    };
                    const diff = order(a.id) - order(b.id);
                    if (diff !== 0) return diff;
                    return a.name.localeCompare(b.name);
                });

            const selectedTeamEntries = displayedTeamOptions.map((team) => ({
                id: team.id,
                name: team.name,
                storyPoints: selectedTeamStats[team.id]?.storyPoints || 0,
                teamCapacity: capacityEnabled ? getTeamCapacity(team.name) * capacityMultiplier : null,
                planningCapacity: capacityEnabled ? getTeamNetCapacity(team) * capacityMultiplier : null
            }));

            const capacityTotals = displayedTeamCapacityEntries.reduce((acc, info) => {
                acc.product.todoPending += info.product.todoPending;
                acc.product.accepted += info.product.accepted;
                acc.product.postponed += info.product.postponed;
                acc.tech.todoPending += info.tech.todoPending;
                acc.tech.accepted += info.tech.accepted;
                acc.tech.postponed += info.tech.postponed;
                acc.total.todoPending += info.total.todoPending;
                acc.total.accepted += info.total.accepted;
                acc.total.postponed += info.total.postponed;
                return acc;
            }, {
                product: { todoPending: 0, accepted: 0, postponed: 0 },
                tech: { todoPending: 0, accepted: 0, postponed: 0 },
                total: { todoPending: 0, accepted: 0, postponed: 0 }
            });

            const showTotalsRow = displayedTeamCapacityEntries.length > 1;

            const formatCapacityValue = (value) => {
                const num = Number(value || 0);
                return num.toFixed(1);
            };

            const getMetricClass = (value, type, acceptedValue) => {
                const num = Number(value || 0);
                if (num === 0) {
                    return 'metric-value metric-muted';
                }
                if (type === 'accepted') {
                    return 'metric-value metric-accepted';
                }
                if (type === 'todo' && acceptedValue !== undefined && acceptedValue < num) {
                    return 'metric-value metric-warn';
                }
                return 'metric-value';
            };

            const buildTeamStatusLink = ({ teamId, teamIds, projectName, projectNames, statuses, excludeStatuses, priorityName, issueType }) => {
                const ids = teamIds || (teamId ? [teamId] : []);
                if (!jiraUrl || !ids.length) return '';
                const clauses = [];
                const projects = projectNames || (projectName ? [projectName] : []);
                if (projects.length === 1) {
                    clauses.push(`project = "${projects[0]}"`);
                } else if (projects.length > 1) {
                    const quoted = projects.map(p => `"${p}"`).join(', ');
                    clauses.push(`project in (${quoted})`);
                }
                if (ids.length === 1) {
                    clauses.push(`"Team[Team]" = "${ids[0]}"`);
                } else {
                    const quotedTeams = ids.map(id => `"${id}"`).join(', ');
                    clauses.push(`"Team[Team]" in (${quotedTeams})`);
                }
                if (selectedSprint) {
                    clauses.push(`Sprint = ${selectedSprint}`);
                }
                if (statuses && statuses.length) {
                    if (statuses.length === 1) {
                        clauses.push(`status = "${statuses[0]}"`);
                    } else {
                        const quoted = statuses.map(s => `"${s}"`).join(', ');
                        clauses.push(`status in (${quoted})`);
                    }
                } else if (excludeStatuses && excludeStatuses.length) {
                    const quoted = excludeStatuses.map(s => `"${s}"`).join(', ');
                    clauses.push(`status not in (${quoted})`);
                }
                if (priorityName) {
                    clauses.push(`priority = "${priorityName}"`);
                }
                if (issueType) {
                    clauses.push(`issuetype = "${issueType}"`);
                }
                const jql = encodeURIComponent(clauses.join(' AND '));
                return `${jiraUrl}/issues/?jql=${jql}`;
            };

            const buildStatLink = (value, options) => {
                const count = Number(value || 0);
                if (!count) return '';
                return buildTeamStatusLink(options);
            };

            const buildPriorityStatusLink = ({ priorityName, statuses, excludeStatuses }) => {
                return buildTeamStatusLink({
                    teamIds: priorityTeamIds,
                    statuses,
                    excludeStatuses,
                    priorityName,
                    issueType: 'Story'
                });
            };

            const buildPriorityStatLink = (value, options) => {
                const count = Number(value || 0);
                if (!count) return '';
                return buildPriorityStatusLink(options);
            };

            const buildPostponedLink = ({ teamId, teamIds, projectName, projectNames }) => {
                return buildTeamStatusLink({ teamId, teamIds, projectName, projectNames, statuses: ['Postponed'] });
            };

            const buildTodoPendingLink = ({ teamId, teamIds, projectName, projectNames }) => {
                return buildTeamStatusLink({ teamId, teamIds, projectName, projectNames, statuses: ['To Do', 'Pending'] });
            };

            const buildAcceptedLink = ({ teamId, teamIds, projectName, projectNames }) => {
                return buildTeamStatusLink({ teamId, teamIds, projectName, projectNames, statuses: ['Accepted'] });
            };

            const buildKeyListLink = (keys, { addSprint } = {}) => {
                if (!jiraUrl) return '';
                const list = (keys || []).filter(Boolean);
                if (!list.length) return '';
                const clauses = [`key in (${list.join(', ')})`];
                if (addSprint && selectedSprint) {
                    clauses.push(`Sprint = ${selectedSprint}`);
                }
                const jql = encodeURIComponent(clauses.join(' AND '));
                return `${jiraUrl}/issues/?jql=${jql}`;
            };

            const hasStoryPoints = (task) => {
                const sp = task.fields.customfield_10004;
                if (sp === null || sp === undefined || sp === '') {
                    return false;
                }
                const numeric = parseFloat(sp);
                return !Number.isNaN(numeric) && numeric > 0;
            };

            const isExcludedStatus = (status) => status === 'killed' || status === 'postponed' || status === 'done';

            const blockedTasks = visibleTasks.filter(task => {
                const status = normalizeStatus(task.fields.status?.name);
                if (!status) return false;
                if (isExcludedStatus(status)) return false;
                return status.includes('blocked');
            });

            const consolidatedMissingStories = React.useMemo(() => {
                const byKey = new Map();

                const shouldIncludeByTeam = (task) => {
                    if (isAllTeamsSelected) return true;
                    const teamId = task?.fields?.teamId;
                    const teamName = task?.fields?.teamName;
                    if (!teamId && !teamName) {
                        return true; // can't filter reliably, keep it visible
                    }
                    return selectedTeamSet.has(getTeamInfo(task).id);
                };

                const excluded = (task) => {
                    const status = normalizeStatus(task.fields.status?.name);
                    return isExcludedStatus(status);
                };

                // Start with server-provided missing info (covers missing Sprint)
                (missingPlanningInfoTasks || []).forEach((task) => {
                    if (!task?.key || excluded(task) || !shouldIncludeByTeam(task)) return;
                    const missing = new Set(task.fields?.missingFields || []);
                    if (missing.size === 0) return;
                    byKey.set(task.key, { task, missing });
                });

                // Merge client-side checks (covers missing Story Points / Epic / Team)
                visibleTasks.forEach((task) => {
                    if (!task?.key || excluded(task) || !shouldIncludeByTeam(task)) return;
                    const current = byKey.get(task.key) || { task, missing: new Set() };

                    if (!hasStoryPoints(task)) current.missing.add('Story Points');
                    if (!task.fields?.epicKey) current.missing.add('Epic');
                    if (!task.fields?.teamId && !task.fields?.teamName) current.missing.add('Team');

                    if (current.missing.size > 0) {
                        // Prefer the server task object if present (may carry extra fields)
                        current.task = current.task || task;
                        byKey.set(task.key, current);
                    }
                });

                return [...byKey.values()]
                    .map(({ task, missing }) => ({ task, missingFields: [...missing] }))
                    .sort((a, b) => {
                        const diff = b.missingFields.length - a.missingFields.length;
                        if (diff !== 0) return diff;
                        const priorityA = priorityOrder[a.task.fields.priority?.name] || 999;
                        const priorityB = priorityOrder[b.task.fields.priority?.name] || 999;
                        if (priorityA !== priorityB) return priorityA - priorityB;
                        return (a.task.fields.summary || '').localeCompare(b.task.fields.summary || '');
                    });
            }, [missingPlanningInfoTasks, visibleTasks, isAllTeamsSelected, selectedTeamSet]);

            const emptyEpics = epicsInScope
                .filter(epic => {
                    const status = normalizeStatus(epic.status?.name);
                    if (status === 'killed' || status === 'done' || status === 'incomplete' || status === 'in progress') return false;
                    if (!isAllTeamsSelected && epic.teamId && !selectedTeamSet.has(epic.teamId)) return false;
                    return true;
                })
                .filter(epic => typeof epic.totalStories === 'number' && epic.totalStories === 0);

	            const readyToCloseStoryStatuses = new Set(['done', 'killed', 'incomplete']);
	            const doneStoryEpics = readyToCloseEpicsInScope
	                .filter(epic => {
	                    const status = normalizeStatus(epic.status?.name);
	                    if (status === 'killed' || status === 'done' || status === 'incomplete') return false;
	                    if (!isAllTeamsSelected && epic.teamId && !selectedTeamSet.has(epic.teamId)) return false;
	                    return true;
	                })
	                .filter(epic => {
	                    const epicStories = readyToCloseTasks.filter(task => {
	                        if (!task.fields?.epicKey) return false;
	                        if (task.fields.epicKey !== epic.key) return false;
	                        if (!isAllTeamsSelected && !selectedTeamSet.has(getTeamInfo(task).id)) return false;
	                        return true;
	                    });
	                    if (epicStories.length === 0) return false;
	                    return epicStories.every(task => readyToCloseStoryStatuses.has(normalizeStatus(task.fields.status?.name)));
	                });

            const sortByPriorityThenSummary = (a, b) => {
                const priorityA = priorityOrder[a.fields.priority?.name] || 999;
                const priorityB = priorityOrder[b.fields.priority?.name] || 999;
                if (priorityA !== priorityB) return priorityA - priorityB;
                return (a.fields.summary || '').localeCompare(b.fields.summary || '');
            };

            const buildAlertGroups = (taskList) => {
                const grouped = groupTasksByEpic(taskList);
                return Object.values(grouped)
                    .map(group => ({
                        ...group,
                        tasks: [...group.tasks].sort(sortByPriorityThenSummary)
                    }))
                    .sort((a, b) => {
                        const diff = (b.tasks?.length || 0) - (a.tasks?.length || 0);
                        if (diff !== 0) return diff;
                        const nameA = (a.epic?.summary || a.parentSummary || a.key);
                        const nameB = (b.epic?.summary || b.parentSummary || b.key);
                        return nameA.localeCompare(nameB);
                    });
            };

            const blockedGroups = buildAlertGroups(blockedTasks);
            const emptyEpicsSorted = [...emptyEpics].sort((a, b) => (a.teamName || '').localeCompare(b.teamName || '') || (a.summary || '').localeCompare(b.summary || ''));
            const doneStoryEpicsSorted = [...doneStoryEpics].sort((a, b) => (a.teamName || '').localeCompare(b.teamName || '') || (a.summary || '').localeCompare(b.summary || ''));


            useEffect(() => {
                if (!showPlanning) {
                    return;
                }
                const updateOffset = () => {
                    const height = planningPanelRef.current?.getBoundingClientRect().height || 0;
                    setPlanningOffset(height);
                };
                updateOffset();
                window.addEventListener('resize', updateOffset);
                return () => window.removeEventListener('resize', updateOffset);
            }, [showPlanning, selectedCount, selectedSP, teamCapacityEntries.length]);

            const openSelectedInJira = () => {
                if (!jiraUrl) return;
                const keys = capacityTasks
                    .filter(task => selectedTasks[task.key])
                    .map(task => task.key)
                    .sort();
                if (keys.length === 0) return;
                const jql = encodeURIComponent(`key in (${keys.join(', ')})`);
                window.open(`${jiraUrl}/issues/?jql=${jql}`, '_blank', 'noopener,noreferrer');
            };

            return (
                <div className="container" style={{ '--planning-offset': `${planningOffset}px` }}>
                    <header>
                        <h1>Sprint Tasks</h1>
                        <div className="subtitle">
                            <span>Product & Tech Projects Â· {sprintName}</span>
                            <div className="header-actions">
                                <button
                                    className="secondary compact"
                                    onClick={() => loadSprints(true)}
                                    disabled={sprintsLoading}
                                    title="Refresh sprints list from Jira"
                                >
                                    {sprintsLoading ? 'Loading...' : 'Refresh Sprints'}
                                </button>
                                <button
                                    className="secondary compact"
                                    onClick={() => {
                                        loadProductTasks();
                                        loadTechTasks();
                                        loadReadyToCloseProductTasks();
                                        loadReadyToCloseTechTasks();
                                    }}
                                    disabled={loading || selectedSprint === null}
                                    title="Refresh tasks from Jira"
                                >
                                    {loading ? 'Loading...' : 'Refresh Page'}
                                </button>
                                <div className="search-wrap">
                                    <input
                                        type="text"
                                        className="search-input"
                                        placeholder="Search tickets..."
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                    />
                                    {searchQuery && (
                                        <button
                                            className="search-clear"
                                            onClick={() => setSearchQuery('')}
                                            title="Clear search"
                                            aria-label="Clear search"
                                        >
                                            Ã
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                        <div className="sprint-selector">
                            <div className="sprint-filters">
                                <label>Select Sprint:</label>
                                <select
                                    value={selectedSprint || ''}
                                    onChange={(e) => {
                                        const sprintId = parseInt(e.target.value);
                                        setSelectedSprint(sprintId);
                                        const sprint = availableSprints.find(s => s.id === sprintId);
                                        if (sprint) {
                                            setSprintName(sprint.name);
                                        }
                                    }}
                                    disabled={sprintsLoading || availableSprints.length === 0}
                                >
                                    {sprintsLoading ? (
                                        <option value="">Loading sprints...</option>
                                    ) : availableSprints.length === 0 ? (
                                        <option value="">No sprints available</option>
                                    ) : (
                                        availableSprints.map(sprint => {
                                            const state = (sprint.state || '').toLowerCase();
                                            const marker = state === 'closed' ? '[C]' : state === 'active' ? '[A]' : '[F]';
                                            return (
                                                <option key={sprint.id} value={sprint.id}>
                                                    {marker} {sprint.name}
                                                </option>
                                            );
                                        })
                                    )}
                                </select>
                                <label>Select Team:</label>
                                <div className="team-dropdown" ref={teamDropdownRef}>
                                    <button
                                        type="button"
                                        className={`team-dropdown-toggle ${showTeamDropdown ? 'open' : ''}`}
                                        onClick={() => setShowTeamDropdown(!showTeamDropdown)}
                                        disabled={tasks.length === 0 && loading}
                                    >
                                        <span>{selectedTeamsLabel}</span>
                                        <svg viewBox="0 0 12 12" fill="currentColor" aria-hidden="true">
                                            <path d="M6 9L1 4h10z"/>
                                        </svg>
                                    </button>
                                    {showTeamDropdown && (
                                        <div className="team-dropdown-panel">
                                            {teamOptions.map(team => (
                                                <label key={team.id} className="team-dropdown-option">
                                                    <input
                                                        type="checkbox"
                                                        checked={team.id === 'all' ? isAllTeamsSelected : selectedTeamSet.has(team.id)}
                                                        onChange={() => toggleTeamSelection(team.id)}
                                                    />
                                                    <span>{team.name}</span>
                                                </label>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="sprint-actions">
                                <button
                                    className={`planning-button ${showPlanning ? 'active' : ''}`}
                                    onClick={() => setShowPlanning(!showPlanning)}
                                    disabled={isCompletedSprintSelected}
                                    title="Toggle sprint planning panel"
                                >
                                    Sprint Planning
                                    <svg viewBox="0 0 12 12" fill="currentColor">
                                        <path d="M6 9L1 4h10z"/>
                                    </svg>
                                </button>
                            <button
                                className={`planning-button ${showStats ? 'active' : ''}`}
                                onClick={() => setShowStats(!showStats)}
                                title="Toggle sprint statistics"
                                disabled={isFutureSprintSelected}
                            >
                                Statistics
                                <svg viewBox="0 0 12 12" fill="currentColor">
                                    <path d="M6 9L1 4h10z"/>
                                </svg>
                                </button>
                            </div>
                        </div>
                    </header>

                    {showPlanning && !isCompletedSprintSelected && (
                        <div className="capacity-panel">
                            <div className="capacity-header">
                                <div className="capacity-title">Planned Teams Effort (Story Points)</div>
                                <div className="capacity-subtitle">1 SP â 2 days of work</div>
                            </div>
                            <div className="capacity-grid-wrapper">
                                <div className="capacity-grid">
                                    <div className="capacity-row capacity-group-row">
                                        <div className="capacity-cell"></div>
                                        <div className="capacity-group-cell product">Product</div>
                                        <div className="capacity-group-cell tech">Tech</div>
                                        <div className="capacity-group-cell total">Total</div>
                                    </div>
                                    <div className="capacity-row capacity-header-row">
                                        <div className="capacity-cell">Team</div>
                                        <div className="capacity-cell metric product-col">To Do / Pending</div>
                                        <div className="capacity-cell metric product-col">Postponed</div>
                                        <div className="capacity-cell metric product-col divider-right">Accepted</div>
                                        <div className="capacity-cell metric tech-col">To Do / Pending</div>
                                        <div className="capacity-cell metric tech-col">Postponed</div>
                                        <div className="capacity-cell metric tech-col divider-right">Accepted</div>
                                        <div className="capacity-cell metric total-col">To Do / Pending</div>
                                        <div className="capacity-cell metric total-col">Postponed</div>
                                        <div className="capacity-cell metric total-col divider-right">Accepted</div>
                                    </div>
                                    {displayedTeamCapacityEntries.map((info) => (
                                        <div key={info.id} className="capacity-row capacity-divider">
                                            <div className="capacity-cell capacity-team">{info.name}</div>
                                            <div className="capacity-cell metric product-col">
                                                <div className="postponed-cell">
                                                    <span className={getMetricClass(info.product.todoPending, 'todo', info.product.accepted)}>
                                                        {formatCapacityValue(info.product.todoPending)}
                                                    </span>
                                                    {buildTodoPendingLink({ teamId: info.id, projectName: 'PRODUCT ROADMAPS' }) && (
                                                        <a
                                                            className="todo-link"
                                                            href={buildTodoPendingLink({ teamId: info.id, projectName: 'PRODUCT ROADMAPS' })}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            title="View To Do / Pending tasks for this team in Jira"
                                                            aria-label="Open To Do / Pending tasks in Jira"
                                                        >
                                                            â
                                                        </a>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="capacity-cell metric product-col">
                                                <div className="postponed-cell">
                                                    <span className="metric-value">
                                                        {formatCapacityValue(info.product.postponed)}
                                                    </span>
                                                    {buildPostponedLink({ teamId: info.id, projectName: 'PRODUCT ROADMAPS' }) && (
                                                        <a
                                                            className="postponed-link"
                                                            href={buildPostponedLink({ teamId: info.id, projectName: 'PRODUCT ROADMAPS' })}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            title="View postponed tasks for this team in Jira"
                                                            aria-label="Open postponed tasks in Jira"
                                                        >
                                                            â
                                                        </a>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="capacity-cell metric product-col divider-right">
                                                <div className="postponed-cell">
                                                    <span className={getMetricClass(info.product.accepted, 'accepted')}>
                                                        {formatCapacityValue(info.product.accepted)}
                                                    </span>
                                                    {buildAcceptedLink({ teamId: info.id, projectName: 'PRODUCT ROADMAPS' }) && (
                                                        <a
                                                            className="accepted-link"
                                                            href={buildAcceptedLink({ teamId: info.id, projectName: 'PRODUCT ROADMAPS' })}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            title="View accepted tasks for this team in Jira"
                                                            aria-label="Open accepted tasks in Jira"
                                                        >
                                                            â
                                                        </a>
                                                    )}
                                                </div>
                                            </div>

                                            <div className="capacity-cell metric tech-col">
                                                <div className="postponed-cell">
                                                    <span className={getMetricClass(info.tech.todoPending, 'todo', info.tech.accepted)}>
                                                        {formatCapacityValue(info.tech.todoPending)}
                                                    </span>
                                                    {buildTodoPendingLink({ teamId: info.id, projectName: 'TECHNICAL ROADMAP' }) && (
                                                        <a
                                                            className="todo-link"
                                                            href={buildTodoPendingLink({ teamId: info.id, projectName: 'TECHNICAL ROADMAP' })}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            title="View To Do / Pending tasks for this team in Jira"
                                                            aria-label="Open To Do / Pending tasks in Jira"
                                                        >
                                                            â
                                                        </a>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="capacity-cell metric tech-col">
                                                <div className="postponed-cell">
                                                    <span className="metric-value">
                                                        {formatCapacityValue(info.tech.postponed)}
                                                    </span>
                                                    {buildPostponedLink({ teamId: info.id, projectName: 'TECHNICAL ROADMAP' }) && (
                                                        <a
                                                            className="postponed-link"
                                                            href={buildPostponedLink({ teamId: info.id, projectName: 'TECHNICAL ROADMAP' })}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            title="View postponed tasks for this team in Jira"
                                                            aria-label="Open postponed tasks in Jira"
                                                        >
                                                            â
                                                        </a>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="capacity-cell metric tech-col divider-right">
                                                <div className="postponed-cell">
                                                    <span className={getMetricClass(info.tech.accepted, 'accepted')}>
                                                        {formatCapacityValue(info.tech.accepted)}
                                                    </span>
                                                    {buildAcceptedLink({ teamId: info.id, projectName: 'TECHNICAL ROADMAP' }) && (
                                                        <a
                                                            className="accepted-link"
                                                            href={buildAcceptedLink({ teamId: info.id, projectName: 'TECHNICAL ROADMAP' })}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            title="View accepted tasks for this team in Jira"
                                                            aria-label="Open accepted tasks in Jira"
                                                        >
                                                            â
                                                        </a>
                                                    )}
                                                </div>
                                            </div>

                                            <div className="capacity-cell metric total-col">
                                                <div className="postponed-cell">
                                                    <span className={getMetricClass(info.total.todoPending, 'todo', info.total.accepted)}>
                                                        {formatCapacityValue(info.total.todoPending)}
                                                    </span>
                                                    {buildTodoPendingLink({ teamId: info.id, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] }) && (
                                                        <a
                                                            className="todo-link"
                                                            href={buildTodoPendingLink({ teamId: info.id, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] })}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            title="View To Do / Pending tasks for this team in Jira"
                                                            aria-label="Open To Do / Pending tasks in Jira"
                                                        >
                                                            â
                                                        </a>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="capacity-cell metric total-col">
                                                <div className="postponed-cell">
                                                    <span className="metric-value">
                                                        {formatCapacityValue(info.total.postponed)}
                                                    </span>
                                                    {buildPostponedLink({ teamId: info.id, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] }) && (
                                                        <a
                                                            className="postponed-link"
                                                            href={buildPostponedLink({ teamId: info.id, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] })}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            title="View postponed tasks for this team in Jira"
                                                            aria-label="Open postponed tasks in Jira"
                                                        >
                                                            â
                                                        </a>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="capacity-cell metric total-col divider-right">
                                                <div className="postponed-cell">
                                                    <span className={getMetricClass(info.total.accepted, 'accepted')}>
                                                        {formatCapacityValue(info.total.accepted)}
                                                    </span>
                                                    {buildAcceptedLink({ teamId: info.id, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] }) && (
                                                        <a
                                                            className="accepted-link"
                                                            href={buildAcceptedLink({ teamId: info.id, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] })}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            title="View accepted tasks for this team in Jira"
                                                            aria-label="Open accepted tasks in Jira"
                                                        >
                                                            â
                                                        </a>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    {showTotalsRow && displayedTeamCapacityEntries.length > 0 && (
                                        <div className="capacity-row capacity-divider">
                                            <div className="capacity-cell capacity-team capacity-total">Total</div>
                                        <div className="capacity-cell metric product-col capacity-total">
                                            <div className="postponed-cell">
                                                <span className={getMetricClass(capacityTotals.product.todoPending, 'todo', capacityTotals.product.accepted)}>
                                                    {formatCapacityValue(capacityTotals.product.todoPending)}
                                                </span>
                                                {buildTodoPendingLink({ teamIds: capacityTeamIds, projectName: 'PRODUCT ROADMAPS' }) && (
                                                    <a
                                                        className="todo-link"
                                                        href={buildTodoPendingLink({ teamIds: capacityTeamIds, projectName: 'PRODUCT ROADMAPS' })}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        title="View To Do / Pending tasks for selected teams in Jira"
                                                        aria-label="Open To Do / Pending tasks in Jira"
                                                    >
                                                        â
                                                    </a>
                                                )}
                                            </div>
                                        </div>
                                        <div className="capacity-cell metric product-col capacity-total">
                                            <div className="postponed-cell">
                                                <span className="metric-value">
                                                    {formatCapacityValue(capacityTotals.product.postponed)}
                                                </span>
                                                {buildPostponedLink({ teamIds: capacityTeamIds, projectName: 'PRODUCT ROADMAPS' }) && (
                                                    <a
                                                        className="postponed-link"
                                                        href={buildPostponedLink({ teamIds: capacityTeamIds, projectName: 'PRODUCT ROADMAPS' })}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        title="View postponed tasks for selected teams in Jira"
                                                        aria-label="Open postponed tasks in Jira"
                                                    >
                                                        â
                                                    </a>
                                                )}
                                            </div>
                                        </div>
                                        <div className="capacity-cell metric product-col divider-right capacity-total">
                                            <div className="postponed-cell">
                                                <span className={getMetricClass(capacityTotals.product.accepted, 'accepted')}>
                                                    {formatCapacityValue(capacityTotals.product.accepted)}
                                                </span>
                                                {buildAcceptedLink({ teamIds: capacityTeamIds, projectName: 'PRODUCT ROADMAPS' }) && (
                                                    <a
                                                        className="accepted-link"
                                                        href={buildAcceptedLink({ teamIds: capacityTeamIds, projectName: 'PRODUCT ROADMAPS' })}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        title="View accepted tasks for selected teams in Jira"
                                                        aria-label="Open accepted tasks in Jira"
                                                    >
                                                        â
                                                    </a>
                                                )}
                                            </div>
                                            </div>

                                        <div className="capacity-cell metric tech-col capacity-total">
                                            <div className="postponed-cell">
                                                <span className={getMetricClass(capacityTotals.tech.todoPending, 'todo', capacityTotals.tech.accepted)}>
                                                    {formatCapacityValue(capacityTotals.tech.todoPending)}
                                                </span>
                                                {buildTodoPendingLink({ teamIds: capacityTeamIds, projectName: 'TECHNICAL ROADMAP' }) && (
                                                    <a
                                                        className="todo-link"
                                                        href={buildTodoPendingLink({ teamIds: capacityTeamIds, projectName: 'TECHNICAL ROADMAP' })}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        title="View To Do / Pending tasks for selected teams in Jira"
                                                        aria-label="Open To Do / Pending tasks in Jira"
                                                    >
                                                        â
                                                    </a>
                                                )}
                                            </div>
                                        </div>
                                        <div className="capacity-cell metric tech-col capacity-total">
                                            <div className="postponed-cell">
                                                <span className="metric-value">
                                                    {formatCapacityValue(capacityTotals.tech.postponed)}
                                                </span>
                                                {buildPostponedLink({ teamIds: capacityTeamIds, projectName: 'TECHNICAL ROADMAP' }) && (
                                                    <a
                                                        className="postponed-link"
                                                        href={buildPostponedLink({ teamIds: capacityTeamIds, projectName: 'TECHNICAL ROADMAP' })}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        title="View postponed tasks for selected teams in Jira"
                                                        aria-label="Open postponed tasks in Jira"
                                                    >
                                                        â
                                                    </a>
                                                )}
                                            </div>
                                        </div>
                                        <div className="capacity-cell metric tech-col divider-right capacity-total">
                                            <div className="postponed-cell">
                                                <span className={getMetricClass(capacityTotals.tech.accepted, 'accepted')}>
                                                    {formatCapacityValue(capacityTotals.tech.accepted)}
                                                </span>
                                                {buildAcceptedLink({ teamIds: capacityTeamIds, projectName: 'TECHNICAL ROADMAP' }) && (
                                                    <a
                                                        className="accepted-link"
                                                        href={buildAcceptedLink({ teamIds: capacityTeamIds, projectName: 'TECHNICAL ROADMAP' })}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        title="View accepted tasks for selected teams in Jira"
                                                        aria-label="Open accepted tasks in Jira"
                                                    >
                                                        â
                                                    </a>
                                                )}
                                            </div>
                                            </div>

                                        <div className="capacity-cell metric total-col capacity-total">
                                            <div className="postponed-cell">
                                                <span className={getMetricClass(capacityTotals.total.todoPending, 'todo', capacityTotals.total.accepted)}>
                                                    {formatCapacityValue(capacityTotals.total.todoPending)}
                                                </span>
                                                {buildTodoPendingLink({ teamIds: capacityTeamIds, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] }) && (
                                                    <a
                                                        className="todo-link"
                                                        href={buildTodoPendingLink({ teamIds: capacityTeamIds, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] })}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        title="View To Do / Pending tasks for selected teams in Jira"
                                                        aria-label="Open To Do / Pending tasks in Jira"
                                                    >
                                                        â
                                                    </a>
                                                )}
                                            </div>
                                        </div>
                                        <div className="capacity-cell metric total-col capacity-total">
                                            <div className="postponed-cell">
                                                <span className="metric-value">
                                                    {formatCapacityValue(capacityTotals.total.postponed)}
                                                </span>
                                                {buildPostponedLink({ teamIds: capacityTeamIds, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] }) && (
                                                    <a
                                                        className="postponed-link"
                                                        href={buildPostponedLink({ teamIds: capacityTeamIds, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] })}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        title="View postponed tasks for selected teams in Jira"
                                                        aria-label="Open postponed tasks in Jira"
                                                    >
                                                        â
                                                    </a>
                                                )}
                                            </div>
                                        </div>
                                            <div className="capacity-cell metric total-col divider-right capacity-total">
                                                <div className="postponed-cell">
                                                    <span className={getMetricClass(capacityTotals.total.accepted, 'accepted')}>
                                                        {formatCapacityValue(capacityTotals.total.accepted)}
                                                    </span>
                                                    {buildAcceptedLink({ teamIds: capacityTeamIds, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] }) && (
                                                        <a
                                                            className="accepted-link"
                                                            href={buildAcceptedLink({ teamIds: capacityTeamIds, projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'] })}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            title="View accepted tasks for selected teams in Jira"
                                                            aria-label="Open accepted tasks in Jira"
                                                        >
                                                            â
                                                        </a>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    {displayedTeamCapacityEntries.length === 0 && (
                                        <div className="capacity-empty">No capacity data for current filters.</div>
                                    )}
                                </div>
                                {displayedTeamCapacityEntries.length > 5 && (
                                    <div className="capacity-scroll-hint">Scroll for more teams</div>
                                )}
                            </div>
                        </div>
                    )}

                    <div className={`stats-panel ${showStats ? 'open' : ''}`}>
                        <div className="stats-controls">
                            <div className="stats-control-group">
                                <label>Selected Sprint</label>
                                <div className="stats-note">
                                    {selectedSprintInfo?.name || 'Select a sprint'}
                                </div>
                            </div>
                        </div>

                        {showStats && !effectiveStatsData && (
                            <div className="stats-note">Load stats for the selected sprint.</div>
                        )}

                        {effectiveStatsData && (
                            <>
                                <div className="stats-summary">
                                    <div
                                        className={`stats-card selectable ${statsGraphMode === 'absolute' ? 'active' : ''}`}
                                        role="button"
                                        tabIndex={0}
                                        onClick={() => setStatsGraphMode('absolute')}
                                        onKeyDown={(event) => {
                                            if (event.key === 'Enter' || event.key === ' ') {
                                                event.preventDefault();
                                                setStatsGraphMode('absolute');
                                            }
                                        }}
                                        aria-pressed={statsGraphMode === 'absolute'}
                                    >
                                        <h4>Delivery Rate</h4>
                                        <div className="stat-value">
                                            {formatPercent(computeRate(statsTotals.straight))}
                                        </div>
                                        <div className="stats-note">Absolute rate</div>
                                    </div>
                                    <div
                                        className={`stats-card selectable ${statsGraphMode === 'weighted' ? 'active' : ''}`}
                                        role="button"
                                        tabIndex={0}
                                        onClick={() => setStatsGraphMode('weighted')}
                                        onKeyDown={(event) => {
                                            if (event.key === 'Enter' || event.key === ' ') {
                                                event.preventDefault();
                                                setStatsGraphMode('weighted');
                                            }
                                        }}
                                        aria-pressed={statsGraphMode === 'weighted'}
                                    >
                                        <h4>Weighted Rate</h4>
                                        <div className="stat-value">
                                            {formatPercent(computeRate(statsTotals.weighted))}
                                        </div>
                                        <div className="stats-note">Priority-weighted</div>
                                    </div>
                                    <div className="stats-card">
                                        <h4>Totals</h4>
                                        <div className="stat-value">{statsTotals.straight.done + statsTotals.straight.incomplete + statsTotals.straight.killed}</div>
                                        <div className="stats-note">
                                            {statsTotals.straight.done} done Â· {statsTotals.straight.incomplete} incomplete Â· {statsTotals.straight.killed} killed
                                        </div>
                                    </div>
                                    <div className="stats-card">
                                        <h4>Source</h4>
                                        <div className="stat-value">Sprint tasks</div>
                                        <div className="stats-note">Derived from the loaded sprint list</div>
                                    </div>
                                </div>

                                <div className="stats-view-toggle">
                                    <button
                                        className={`stats-toggle ${statsView === 'teams' ? 'active' : ''}`}
                                        onClick={() => setStatsView('teams')}
                                    >
                                        Teams
                                    </button>
                                    <button
                                        className={`stats-toggle ${statsView === 'priority' ? 'active' : ''}`}
                                        onClick={() => setStatsView('priority')}
                                    >
                                        Priority
                                    </button>
                                </div>

                                <div className={`stats-view ${statsView === 'teams' ? 'open' : ''}`}>
                                    <div className="stats-bars">
                                        {statsTeamRows.map(team => {
                                            const graphRate = statsGraphMode === 'weighted' ? team.weightedRate : team.straightRate;
                                            return (
                                                <div key={team.id} className="stats-bar">
                                                    <div className="stats-bar-value">{formatPercent(graphRate)}</div>
                                                    <div className="stats-bar-track">
                                                        <div
                                                            className={`stats-bar-fill ${getRateClass(graphRate)}`}
                                                            style={{ height: `${Math.min(100, graphRate * 100)}%` }}
                                                        />
                                                    </div>
                                                    <div className="stats-bar-label">{team.name}</div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    <table className="stats-table">
                                        <thead>
                                            <tr className="stats-group-row">
                                                <th className="dimension"></th>
                                                <th className="stats-col total" colSpan="4">Total</th>
                                                <th className="stats-col product" colSpan="4">Product</th>
                                                <th className="stats-col tech" colSpan="4">Tech</th>
                                            </tr>
                                            <tr>
                                                <th className="dimension">Team</th>
                                                <th className="metric stats-col total">Done</th>
                                                <th className="metric stats-col total">Incomplete</th>
                                                <th className="metric stats-col total">Absolute</th>
                                                <th className="metric stats-col total">Weighted</th>
                                                <th className="metric stats-col product">Done</th>
                                                <th className="metric stats-col product">Incomplete</th>
                                                <th className="metric stats-col product">Absolute</th>
                                                <th className="metric stats-col product">Weighted</th>
                                                <th className="metric stats-col tech">Done</th>
                                                <th className="metric stats-col tech">Incomplete</th>
                                                <th className="metric stats-col tech">Absolute</th>
                                                <th className="metric stats-col tech">Weighted</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {statsTeamRows.map(team => {
                                                const totalDoneLink = buildStatLink(team.straight.done, {
                                                    teamId: team.id,
                                                    projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'],
                                                    statuses: ['Done'],
                                                    issueType: 'Story'
                                                });
                                                const totalIncompleteLink = buildStatLink(team.straight.incomplete, {
                                                    teamId: team.id,
                                                    projectNames: ['PRODUCT ROADMAPS', 'TECHNICAL ROADMAP'],
                                                    excludeStatuses: ['Done', 'Killed'],
                                                    issueType: 'Story'
                                                });
                                                const productDoneLink = buildStatLink(team.product.done, {
                                                    teamId: team.id,
                                                    projectName: 'PRODUCT ROADMAPS',
                                                    statuses: ['Done'],
                                                    issueType: 'Story'
                                                });
                                                const productIncompleteLink = buildStatLink(team.product.incomplete, {
                                                    teamId: team.id,
                                                    projectName: 'PRODUCT ROADMAPS',
                                                    excludeStatuses: ['Done', 'Killed'],
                                                    issueType: 'Story'
                                                });
                                                const techDoneLink = buildStatLink(team.tech.done, {
                                                    teamId: team.id,
                                                    projectName: 'TECHNICAL ROADMAP',
                                                    statuses: ['Done'],
                                                    issueType: 'Story'
                                                });
                                                const techIncompleteLink = buildStatLink(team.tech.incomplete, {
                                                    teamId: team.id,
                                                    projectName: 'TECHNICAL ROADMAP',
                                                    excludeStatuses: ['Done', 'Killed'],
                                                    issueType: 'Story'
                                                });

                                                return (
                                                <tr key={team.id}>
                                                    <td className="dimension">{team.name}</td>
                                                    <td className="metric stats-col total">
                                                        <div className="postponed-cell">
                                                            <span>{team.straight.done}</span>
                                                            {totalDoneLink && (
                                                                <a
                                                                    className="stats-link"
                                                                    href={totalDoneLink}
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                    title="View done stories for this team in Jira"
                                                                    aria-label="Open done stories in Jira"
                                                                >
                                                                    â
                                                                </a>
                                                            )}
                                                        </div>
                                                    </td>
                                                    <td className="metric stats-col total">
                                                        <div className="postponed-cell">
                                                            <span>{team.straight.incomplete}</span>
                                                            {totalIncompleteLink && (
                                                                <a
                                                                    className="stats-link"
                                                                    href={totalIncompleteLink}
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                    title="View incomplete stories for this team in Jira"
                                                                    aria-label="Open incomplete stories in Jira"
                                                                >
                                                                    â
                                                                </a>
                                                            )}
                                                        </div>
                                                    </td>
                                                    <td className="metric stats-col total">{formatPercent(team.straightRate)}</td>
                                                    <td className="metric stats-col total">{formatPercent(team.weightedRate)}</td>
                                                    <td className="metric stats-col product">
                                                        <div className="postponed-cell">
                                                            <span>{team.product.done}</span>
                                                            {productDoneLink && (
                                                                <a
                                                                    className="stats-link"
                                                                    href={productDoneLink}
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                    title="View done product stories for this team in Jira"
                                                                    aria-label="Open done product stories in Jira"
                                                                >
                                                                    â
                                                                </a>
                                                            )}
                                                        </div>
                                                    </td>
                                                    <td className="metric stats-col product">
                                                        <div className="postponed-cell">
                                                            <span>{team.product.incomplete}</span>
                                                            {productIncompleteLink && (
                                                                <a
                                                                    className="stats-link"
                                                                    href={productIncompleteLink}
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                    title="View incomplete product stories for this team in Jira"
                                                                    aria-label="Open incomplete product stories in Jira"
                                                                >
                                                                    â
                                                                </a>
                                                            )}
                                                        </div>
                                                    </td>
                                                    <td className="metric stats-col product">{formatPercent(computeRate(team.product))}</td>
                                                    <td className="metric stats-col product">{formatPercent(computeRate(team.weightedProduct))}</td>
                                                    <td className="metric stats-col tech">
                                                        <div className="postponed-cell">
                                                            <span>{team.tech.done}</span>
                                                            {techDoneLink && (
                                                                <a
                                                                    className="stats-link"
                                                                    href={techDoneLink}
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                    title="View done tech stories for this team in Jira"
                                                                    aria-label="Open done tech stories in Jira"
                                                                >
                                                                    â
                                                                </a>
                                                            )}
                                                        </div>
                                                    </td>
                                                    <td className="metric stats-col tech">
                                                        <div className="postponed-cell">
                                                            <span>{team.tech.incomplete}</span>
                                                            {techIncompleteLink && (
                                                                <a
                                                                    className="stats-link"
                                                                    href={techIncompleteLink}
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                    title="View incomplete tech stories for this team in Jira"
                                                                    aria-label="Open incomplete tech stories in Jira"
                                                                >
                                                                    â
                                                                </a>
                                                            )}
                                                        </div>
                                                    </td>
                                                    <td className="metric stats-col tech">{formatPercent(computeRate(team.tech))}</td>
                                                    <td className="metric stats-col tech">{formatPercent(computeRate(team.weightedTech))}</td>
                                                </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>

                                <div className={`stats-view ${statsView === 'priority' ? 'open' : ''}`}>
                                    {priorityRadar.series.length > 0 && (
                                        <>
                                            <svg className="priority-radar" viewBox="0 0 360 360" role="img" aria-label="Priority distribution radar chart">
                                                <g transform="translate(180 180)">
                                                    {[0.25, 0.5, 0.75, 1].map((ratio, index) => (
                                                        <polygon
                                                            key={`grid-${index}`}
                                                            points={buildRadarPoints({
                                                                values: Object.fromEntries(priorityAxis.map(axis => [axis, ratio * priorityRadar.maxValue])),
                                                                radius: 120,
                                                                center: 0,
                                                                maxValue: priorityRadar.maxValue,
                                                                axes: priorityAxis
                                                            })}
                                                            fill="none"
                                                            stroke="#d9d9d9"
                                                            strokeWidth="1"
                                                        />
                                                    ))}
                                                    {priorityAxis.map((axis, index) => {
                                                        const angle = (Math.PI * 2 * index) / priorityAxis.length - Math.PI / 2;
                                                        const x = Math.cos(angle) * 120;
                                                        const y = Math.sin(angle) * 120;
                                                        return (
                                                            <line
                                                                key={`axis-${axis}`}
                                                                x1="0"
                                                                y1="0"
                                                                x2={x}
                                                                y2={y}
                                                                stroke="#d9d9d9"
                                                                strokeWidth="1"
                                                            />
                                                        );
                                                    })}
                                                    {priorityRadar.series.map((series, idx) => {
                                                        const color = radarPalette[idx % radarPalette.length];
                                                        const isActive = priorityHoverIndex === null || priorityHoverIndex === idx;
                                                        return (
                                                            <polygon
                                                                key={series.id}
                                                                points={buildRadarPoints({
                                                                    values: series.pointsByPriority,
                                                                    radius: 120,
                                                                    center: 0,
                                                                    maxValue: priorityRadar.maxValue,
                                                                    axes: priorityAxis
                                                                })}
                                                                fill={color}
                                                                fillOpacity={isActive ? '0.18' : '0.04'}
                                                                stroke={color}
                                                                strokeWidth={isActive ? '2.5' : '1.2'}
                                                                style={{ transition: 'all 0.2s ease', cursor: 'pointer' }}
                                                                onMouseEnter={() => setPriorityHoverIndex(idx)}
                                                                onMouseLeave={() => setPriorityHoverIndex(null)}
                                                            />
                                                        );
                                                    })}
                                                    {[0.25, 0.5, 0.75, 1].map((ratio, index) => (
                                                        <text
                                                            key={`value-${index}`}
                                                            x="0"
                                                            y={-(120 * ratio) - 6}
                                                            textAnchor="middle"
                                                            dominantBaseline="middle"
                                                            fontSize="8"
                                                            fill="#8c8c8c"
                                                            fontFamily="IBM Plex Mono, monospace"
                                                        >
                                                            {(priorityRadar.maxValue * ratio).toFixed(1)}
                                                        </text>
                                                    ))}
                                                    {priorityAxis.map((axis, index) => {
                                                        const angle = (Math.PI * 2 * index) / priorityAxis.length - Math.PI / 2;
                                                        const x = Math.cos(angle) * 150;
                                                        const y = Math.sin(angle) * 150;
                                                        return (
                                                            <text
                                                                key={`label-${axis}`}
                                                                x={x}
                                                                y={y}
                                                                textAnchor="middle"
                                                                dominantBaseline="middle"
                                                                fontSize="8"
                                                                fill="#555"
                                                                fontFamily="IBM Plex Mono, monospace"
                                                            >
                                                                {axis}
                                                            </text>
                                                        );
                                                    })}
                                                </g>
                                            </svg>
                                            <div className="priority-legend">
                                                {priorityRadar.series.map((series, idx) => {
                                                    const color = radarPalette[idx % radarPalette.length];
                                                    const isActive = priorityHoverIndex === null || priorityHoverIndex === idx;
                                                    return (
                                                        <span
                                                            key={series.id}
                                                            style={{ color: isActive ? 'var(--text-primary)' : 'var(--text-secondary)' }}
                                                            onMouseEnter={() => setPriorityHoverIndex(idx)}
                                                            onMouseLeave={() => setPriorityHoverIndex(null)}
                                                        >
                                                            <i style={{ background: color, opacity: isActive ? 0.95 : 0.45 }} />
                                                            {series.name}
                                                        </span>
                                                    );
                                                })}
                                            </div>
                                            <div className="priority-axis-note">Axis values show story points.</div>
                                        </>
                                    )}
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th className="dimension">Priority</th>
                                                <th className="metric">Story Points</th>
                                                <th className="metric">Done</th>
                                                <th className="metric">Incomplete</th>
                                                <th className="metric">Rate</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {priorityRows.map(row => {
                                                const pointsLink = buildPriorityStatLink(row.points, {
                                                    priorityName: row.name
                                                });
                                                const doneLink = buildPriorityStatLink(row.done, {
                                                    priorityName: row.name,
                                                    statuses: ['Done']
                                                });
                                                const incompleteLink = buildPriorityStatLink(row.incomplete, {
                                                    priorityName: row.name,
                                                    excludeStatuses: ['Done', 'Killed']
                                                });

                                                return (
                                                    <tr key={row.name}>
                                                        <td className="dimension">{row.name}</td>
                                                        <td className="metric">
                                                            <div className="postponed-cell">
                                                                <span>{row.points.toFixed(1)}</span>
                                                                {pointsLink && (
                                                                    <a
                                                                        className="stats-link"
                                                                        href={pointsLink}
                                                                        target="_blank"
                                                                        rel="noopener noreferrer"
                                                                        title="View stories for this priority in Jira"
                                                                        aria-label="Open stories in Jira"
                                                                    >
                                                                        â
                                                                    </a>
                                                                )}
                                                            </div>
                                                        </td>
                                                        <td className="metric">
                                                            <div className="postponed-cell">
                                                                <span>{row.done}</span>
                                                                {doneLink && (
                                                                    <a
                                                                        className="stats-link"
                                                                        href={doneLink}
                                                                        target="_blank"
                                                                        rel="noopener noreferrer"
                                                                        title="View done stories for this priority in Jira"
                                                                        aria-label="Open done stories in Jira"
                                                                    >
                                                                        â
                                                                    </a>
                                                                )}
                                                            </div>
                                                        </td>
                                                        <td className="metric">
                                                            <div className="postponed-cell">
                                                                <span>{row.incomplete}</span>
                                                                {incompleteLink && (
                                                                    <a
                                                                        className="stats-link"
                                                                        href={incompleteLink}
                                                                        target="_blank"
                                                                        rel="noopener noreferrer"
                                                                        title="View incomplete stories for this priority in Jira"
                                                                        aria-label="Open incomplete stories in Jira"
                                                                    >
                                                                        â
                                                                    </a>
                                                                )}
                                                            </div>
                                                        </td>
                                                        <td className="metric">{formatPercent(row.rate)}</td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </>
                        )}
                    </div>

	                    <div ref={planningPanelRef} className={`planning-panel ${showPlanning && !isCompletedSprintSelected ? 'open' : ''}`}>
	                        <div className="planning-stats">
	                            <div className="planning-stat">
	                                <span className="planning-stat-label">Selected Tasks:</span>
	                                <span className="planning-stat-value">{selectedCount}</span>
	                            </div>
	                            <div className="planning-stat">
                                    <span
                                        className="planning-stat-label"
                                        data-tooltip="Total selected story points."
                                    >
                                        Selected Effort:
                                    </span>
	                                <span className="planning-stat-value">{selectedSP.toFixed(1)}</span>
	                            </div>
                                {capacityEnabled && totalCapacityAdjusted > 0 && (
                                    <div className="planning-stat">
                                        <span
                                            className="planning-stat-label"
                                            data-tooltip="Estimated team capacity for the quarter (if one team selected, that team's capacity)."
                                        >
                                            Team Capacity:
                                        </span>
                                        <span className="planning-stat-value">
                                            {totalCapacityAdjusted.toFixed(1)} SP
                                        </span>
                                    </div>
                                )}
                                {capacityEnabled && totalCapacityAdjusted > 0 && (
                                    <div className="planning-stat">
                                        <span
                                            className="planning-stat-label"
                                            data-tooltip="Team capacity minus excluded mandatory activities (perf review, dev lead management, etc.)."
                                        >
                                            Planning Capacity:
                                        </span>
                                        <span className="planning-stat-value">
                                            {estimatedCapacityAdjusted.toFixed(1)} SP
                                        </span>
                                    </div>
                                )}
                                {capacityEnabled && totalCapacityAdjusted > 0 && (
                                    <div className="planning-stat">
                                        <span
                                            className="planning-stat-label"
                                            data-tooltip="Plan variance = (selected effort / team capacity - 1). Positive means over planned."
                                        >
                                            Plan Variance:
                                        </span>
                                        <span className={`planning-stat-value ${capacitySummary.status}`}>
                                            {capacitySummary.label || '0%'}
                                        </span>
                                    </div>
                                )}
	                            <div className="planning-actions">
	                                <button
	                                    className={`planning-action-button ${isAcceptedIncluded ? 'active' : ''}`}
	                                    onClick={() => toggleIncludeByStatus(['Accepted'])}
	                                    disabled={visibleTasks.length === 0}
	                                    title="Include all Accepted stories for the current view"
	                                >
	                                    Include Accepted
	                                </button>
	                                <button
	                                    className={`planning-action-button ${isTodoIncluded ? 'active' : ''}`}
	                                    onClick={() => toggleIncludeByStatus(['To Do', 'Pending'])}
	                                    disabled={visibleTasks.length === 0}
	                                    title="Include all To Do / Pending stories for the current view"
	                                >
	                                    Include To Do
	                                </button>
	                                <button
	                                    className="uncheck-button"
	                                    onClick={clearSelectedTasks}
	                                    disabled={selectedCount === 0}
	                                    title="Clear all selected tasks"
	                                >
	                                    Uncheck Selected
	                                </button>
	                                <button
	                                    className="planning-action-button planning-icon-button"
	                                    onClick={openSelectedInJira}
	                                    disabled={selectedCount === 0 || !jiraUrl}
	                                    title="Open selected stories in Jira (tip: bulk move them to Accepted)"
	                                    aria-label="Open selected stories in Jira"
	                                >
	                                    <svg viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
	                                        <path d="M10 2h4v4h-1.5V4.56L8.53 8.53l-1.06-1.06L11.44 3.5H10V2z" />
	                                        <path d="M13 9v4a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h4v1.5H3.5v8h8V9H13z" />
	                                    </svg>
	                                </button>
	                            </div>
	                        </div>
                        {selectedTeamEntries.length > 1 && (
                            <>
                                <div className="planning-stats compact" style={{ marginTop: '0.4rem' }}>
                                    <div className="planning-stat">
                                        <span className="planning-stat-label">Selected SP by Team:</span>
                                    </div>
                                </div>
                                <div className="team-stats-grid">
                                    {selectedTeamEntries.map((info) => (
                                        <div key={info.id} className="team-stat-card team-card">
                                            <div className="team-stat-label">{info.name}</div>
                                            <div className="team-stat-line">
                                                <div className="team-stat-value">{info.storyPoints.toFixed(1)} SP</div>
                                                <div className="team-stat-meta">Selected effort</div>
                                            </div>
                                            {capacityEnabled && info.teamCapacity > 0 && (
                                                <>
                                                    {(() => {
                                                        const capacityMeta = getTeamCapacityMeta(info.storyPoints, info.teamCapacity);
                                                        return (
                                                            <div className="team-stat-line" title={capacityMeta.title}>
                                                                <div className="team-stat-value muted">{info.teamCapacity.toFixed(1)} SP</div>
                                                                <div className={`team-stat-meta ${capacityMeta.status ? `planning-stat-value ${capacityMeta.status}` : ''}`}>
                                                                    {capacityMeta.text}
                                                                </div>
                                                            </div>
                                                        );
                                                    })()}
                                                </>
                                            )}
                                        </div>
                                    ))}
                                    {selectedTeamEntries.length === 0 && (
                                        <div className="planning-stat">
                                            <span className="planning-stat-value">No tasks selected</span>
                                        </div>
                                    )}
                                </div>
                            </>
                        )}
	                        <div className="planning-stats compact" style={{ marginTop: '0.35rem' }}>
                                <div className="planning-stat">
                                    <span className="planning-stat-label">Selected SP by Project:</span>
                                    {capacityEnabled && (
                                        <span className="planning-stat-separator">
                                            Estimated capacity split: 70% Product / 30% Tech (tech-heavy teams may aim for 10% / 90%)
                                        </span>
                                    )}
                                </div>
	                        </div>
	                                <div className="team-stats-grid">
	                                    {selectedProjectEntries.map((info) => (
	                                        <div key={info.id} className="team-stat-card project-card">
	                                            <div className="team-stat-label">{info.name}</div>
	                                            <div className="team-stat-line">
	                                                <div className="team-stat-value">
	                                                    {(() => {
	                                                        const total = selectedProjectEntries.reduce((sum, entry) => sum + entry.storyPoints, 0);
	                                                        const pct = total > 0 ? (info.storyPoints / total) * 100 : 0;
	                                                        return `${pct.toFixed(0)}%`;
	                                                    })()}
	                                                </div>
	                                            </div>
	                                            <div className="team-stat-line">
	                                                <div className="team-stat-value muted">{info.storyPoints.toFixed(1)} SP</div>
	                                                <div className="team-stat-meta">Selected effort</div>
	                                            </div>
	                                </div>
	                            ))}
	                            {selectedProjectEntries.length === 0 && (
	                                <div className="planning-stat">
	                                    <span className="planning-stat-value">No tasks selected</span>
	                                </div>
	                            )}
	                        </div>
	                    </div>

                    {loading ? (
                        <div className="loading">Loading tasks...</div>
                    ) : error ? (
                        <div className="error">
                            {error}
                            <div style={{ marginTop: '1rem' }}>
                                <button onClick={fetchTasks}>Retry</button>
                            </div>
                        </div>
                    ) : (
                        <>
		                            {(consolidatedMissingStories.length > 0 || blockedTasks.length > 0 || emptyEpics.length > 0 || doneStoryEpics.length > 0) && (
		                                <div className={`alert-panels ${(!showMissingAlert && !showBlockedAlert && !showEmptyEpicAlert && !showDoneEpicAlert) ? 'collapsed' : ''}`}>
		                                    {consolidatedMissingStories.length > 0 && (
		                                        <div className={`alert-card missing ${showMissingAlert ? '' : 'collapsed'}`}>
	                                            <div className="alert-card-header">
	                                                <button
	                                                    className="alert-toggle"
	                                                    onClick={() => setShowMissingAlert(prev => !prev)}
	                                                    title={showMissingAlert ? 'Collapse missing info panel' : 'Expand missing info panel'}
	                                                >
	                                                    <span className="alert-toggle-icon" aria-hidden="true">
	                                                        <svg className={`alert-toggle-chevron ${showMissingAlert ? '' : 'collapsed'}`} viewBox="0 0 12 12">
	                                                            <path d="M2.5 4.5l3.5 3 3.5-3" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
	                                                        </svg>
	                                                    </span>
	                                                    <span className="alert-toggle-label">
	                                                        {showMissingAlert ? 'Hide' : 'Show'}
	                                                    </span>
	                                                </button>
	                                                <div className="alert-title">ð§¾ Missing Info</div>
	                                                <div className="alert-subtitle">These stories are missing planning essentialsâfill the fields so they can be scheduled and estimated.</div>
		                                                <a
		                                                    className="alert-chip"
		                                                    href={buildKeyListLink(consolidatedMissingStories.map(item => item.task.key))}
		                                                    target="_blank"
		                                                    rel="noopener noreferrer"
		                                                    title="Open these stories in Jira"
		                                                >
		                                                    {consolidatedMissingStories.length} {consolidatedMissingStories.length === 1 ? 'story' : 'stories'}
		                                                </a>
		                                            </div>
	                                            {showMissingAlert && (
	                                                <div className="alert-card-body">
	                                                    <div className="alert-stories">
	                                                        {consolidatedMissingStories.map(({ task, missingFields }) => {
	                                                            const teamInfo = getTeamInfo(task);
	                                                            return (
	                                                                <div key={task.key} className="alert-story">
	                                                                    <span className="alert-pill team">{teamInfo.name}</span>
	                                                                    <div className="alert-story-main">
	                                                                        <a
	                                                                            className="alert-story-link"
	                                                                            href={`${jiraUrl}/browse/${task.key}`}
	                                                                            target="_blank"
	                                                                            rel="noopener noreferrer"
	                                                                        >
	                                                                            {task.key} Â· {task.fields.summary}
	                                                                        </a>
	                                                                    </div>
	                                                                    <span className="alert-pill status">Missing: {missingFields.join(', ')}</span>
	                                                                    <a
	                                                                        className="alert-action"
	                                                                        href={`${jiraUrl}/browse/${task.key}`}
	                                                                        target="_blank"
	                                                                        rel="noopener noreferrer"
	                                                                    >
	                                                                        Fix fields â
	                                                                    </a>
	                                                                </div>
	                                                            );
	                                                        })}
	                                                    </div>
	                                                </div>
	                                            )}
	                                        </div>
	                                    )}

	                                    {blockedTasks.length > 0 && (
	                                        <div className={`alert-card blocked ${showBlockedAlert ? '' : 'collapsed'}`}>
                                            <div className="alert-card-header">
                                                <button
                                                    className="alert-toggle"
                                                    onClick={() => setShowBlockedAlert(prev => !prev)}
                                                    title={showBlockedAlert ? 'Collapse blocked panel' : 'Expand blocked panel'}
                                                >
                                                    <span className="alert-toggle-icon" aria-hidden="true">
                                                        <svg className={`alert-toggle-chevron ${showBlockedAlert ? '' : 'collapsed'}`} viewBox="0 0 12 12">
                                                            <path d="M2.5 4.5l3.5 3 3.5-3" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
                                                        </svg>
                                                    </span>
                                                    <span className="alert-toggle-label">
                                                        {showBlockedAlert ? 'Hide' : 'Show'}
                                                    </span>
                                                </button>
                                                <div className="alert-title">âï¸ Blocked</div>
                                                <div className="alert-subtitle">Letâs unblock these fastâcall out whatâs stuck, whoâs needed, and what âdoneâ looks like.</div>
	                                                <a
	                                                    className="alert-chip"
	                                                    href={buildKeyListLink(blockedTasks.map(t => t.key), { addSprint: true })}
	                                                    target="_blank"
	                                                    rel="noopener noreferrer"
	                                                    title="Open blocked stories in Jira"
	                                                >
	                                                    {blockedTasks.length} blocked
	                                                </a>
	                                            </div>
	                                            {showBlockedAlert && (
	                                                <div className="alert-card-body">
	                                                    {blockedGroups.map(group => {
                                                        const epicTitle = group.epic?.summary || group.parentSummary ||
                                                            (group.key === 'NO_EPIC' ? 'No Epic Linked' : group.key);
	                                                        return (
	                                                            <div key={group.key} className="alert-epic">
	                                                                <div className="alert-epic-head">
                                                                    <div className="alert-epic-title">
                                                                        <span className="alert-pill">EPIC</span>
                                                                        <span>{epicTitle}</span>
                                                                    </div>
                                                                    {group.key !== 'NO_EPIC' && (
                                                                        <a
                                                                            className="alert-epic-link"
                                                                            href={`${jiraUrl}/browse/${group.key}`}
                                                                            target="_blank"
                                                                            rel="noopener noreferrer"
                                                                        >
                                                                            Open epic â
                                                                        </a>
                                                                    )}
                                                                </div>
                                                                <div className="alert-stories">
                                                                    {group.tasks.map(task => {
                                                                        const teamInfo = getTeamInfo(task);
                                                                        const statusLabel = task.fields.status?.name || 'Blocked';
                                                                        return (
                                                                            <div key={task.key} className="alert-story">
                                                                                <span className="alert-pill team">{teamInfo.name}</span>
                                                                                <div className="alert-story-main">
                                                                                    <a
                                                                                        className="alert-story-link"
                                                                                        href={`${jiraUrl}/browse/${task.key}`}
                                                                                        target="_blank"
                                                                                        rel="noopener noreferrer"
                                                                                    >
                                                                                        {task.key} Â· {task.fields.summary}
                                                                                    </a>
                                                                                </div>
                                                                                <span className="alert-pill status">{statusLabel}</span>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                        );
	                                                    })}
	                                                </div>
	                                            )}
	                                        </div>
	                                    )}

	                                    {emptyEpics.length > 0 && (
		                                        <div className={`alert-card empty-epic ${showEmptyEpicAlert ? '' : 'collapsed'}`}>
	                                            <div className="alert-card-header">
	                                                <button
	                                                    className="alert-toggle"
	                                                    onClick={() => setShowEmptyEpicAlert(prev => !prev)}
	                                                    title={showEmptyEpicAlert ? 'Collapse empty epic panel' : 'Expand empty epic panel'}
	                                                >
	                                                    <span className="alert-toggle-icon" aria-hidden="true">
	                                                        <svg className={`alert-toggle-chevron ${showEmptyEpicAlert ? '' : 'collapsed'}`} viewBox="0 0 12 12">
	                                                            <path d="M2.5 4.5l3.5 3 3.5-3" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
	                                                        </svg>
	                                                    </span>
	                                                    <span className="alert-toggle-label">
	                                                        {showEmptyEpicAlert ? 'Hide' : 'Show'}
	                                                    </span>
	                                                </button>
	                                                <div className="alert-title">ð§º Empty Epic</div>
	                                                <div className="alert-subtitle">These epics have zero storiesâplease review and create at least one story to make them actionable.</div>
	                                                <a
	                                                    className="alert-chip"
	                                                    href={buildKeyListLink(emptyEpics.map(e => e.key))}
	                                                    target="_blank"
	                                                    rel="noopener noreferrer"
	                                                    title="Open these epics in Jira"
	                                                >
	                                                    {emptyEpics.length} {emptyEpics.length === 1 ? 'epic' : 'epics'}
	                                                </a>
	                                            </div>
		                                            {showEmptyEpicAlert && (
		                                                <div className="alert-card-body">
		                                                    <div className="alert-stories">
		                                                        {emptyEpicsSorted.map(epic => (
	                                                            <div key={epic.key} className="alert-story">
	                                                                <span className="alert-pill team">{epic.teamName || 'Unknown Team'}</span>
	                                                                <div className="alert-story-main">
	                                                                    <a
	                                                                        className="alert-story-link"
	                                                                        href={`${jiraUrl}/browse/${epic.key}`}
	                                                                        target="_blank"
	                                                                        rel="noopener noreferrer"
	                                                                    >
	                                                                        {epic.key} Â· {epic.summary}
	                                                                    </a>
	                                                                </div>
	                                                                {epic.status?.name && (
	                                                                    <span className="alert-pill status">{epic.status.name}</span>
	                                                                )}
	                                                                <a
	                                                                    className="alert-action"
	                                                                    href={`${jiraUrl}/browse/${epic.key}`}
	                                                                    target="_blank"
	                                                                    rel="noopener noreferrer"
	                                                                >
	                                                                    Create story â
	                                                                </a>
	                                                            </div>
		                                                        ))}
		                                                    </div>
		                                                </div>
		                                            )}
		                                        </div>
		                                    )}

		                                    {doneStoryEpics.length > 0 && (
		                                        <div className={`alert-card done-epic ${showDoneEpicAlert ? '' : 'collapsed'}`}>
	                                            <div className="alert-card-header">
	                                                <button
	                                                    className="alert-toggle"
	                                                    onClick={() => setShowDoneEpicAlert(prev => !prev)}
	                                                    title={showDoneEpicAlert ? 'Collapse ready-to-close epics panel' : 'Expand ready-to-close epics panel'}
	                                                >
	                                                    <span className="alert-toggle-icon" aria-hidden="true">
	                                                        <svg className={`alert-toggle-chevron ${showDoneEpicAlert ? '' : 'collapsed'}`} viewBox="0 0 12 12">
	                                                            <path d="M2.5 4.5l3.5 3 3.5-3" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
	                                                        </svg>
	                                                    </span>
	                                                    <span className="alert-toggle-label">
	                                                        {showDoneEpicAlert ? 'Hide' : 'Show'}
	                                                    </span>
	                                                </button>
	                                                <div className="alert-title">â Epic Ready to Close</div>
	                                                <div className="alert-subtitle">All stories are done, killed, or incomplete, but the epic is still openâtime to close the loop.</div>
	                                                <a
	                                                    className="alert-chip"
	                                                    href={buildKeyListLink(doneStoryEpics.map(e => e.key))}
	                                                    target="_blank"
	                                                    rel="noopener noreferrer"
	                                                    title="Open these epics in Jira"
	                                                >
	                                                    {doneStoryEpics.length} {doneStoryEpics.length === 1 ? 'epic' : 'epics'}
	                                                </a>
	                                            </div>
	                                            {showDoneEpicAlert && (
	                                                <div className="alert-card-body">
	                                                    <div className="alert-stories">
	                                                        {doneStoryEpicsSorted.map(epic => (
	                                                            <div key={epic.key} className="alert-story">
	                                                                <span className="alert-pill team">{epic.teamName || 'Unknown Team'}</span>
	                                                                <div className="alert-story-main">
	                                                                    <a
	                                                                        className="alert-story-link"
	                                                                        href={`${jiraUrl}/browse/${epic.key}`}
	                                                                        target="_blank"
	                                                                        rel="noopener noreferrer"
	                                                                    >
	                                                                        {epic.key} Â· {epic.summary}
	                                                                    </a>
	                                                                </div>
	                                                                {epic.assignee?.displayName && (
	                                                                    <span className="alert-pill status">{epic.assignee.displayName}</span>
	                                                                )}
	                                                                <a
	                                                                    className="alert-action"
	                                                                    href={`${jiraUrl}/browse/${epic.key}`}
	                                                                    target="_blank"
	                                                                    rel="noopener noreferrer"
	                                                                >
	                                                                    Close epic â
	                                                                </a>
	                                                            </div>
	                                                        ))}
	                                                    </div>
	                                                </div>
	                                            )}
	                                        </div>
	                                    )}

	                                </div>
	                            )}
                            <div className="stats">
                                <div
                                    className={`stat-card total ${statusFilter === null ? 'active' : ''} ${baseFilteredTasks.length === 0 ? 'disabled' : ''}`}
                                    onClick={() => {
                                        if (baseFilteredTasks.length === 0) return;
                                        setStatusFilter(null);
                                    }}
                                >
                                    <div className="stat-value">{baseFilteredTasks.length}</div>
                                    <div className="stat-label">Total Tasks</div>
                                    <div className="stats-note">{totalStoryPoints.toFixed(1)} SP</div>
                                </div>
                                <div
                                    className={`stat-card done ${statusFilter === 'done' ? 'active' : ''} ${doneTasksCount === 0 ? 'disabled' : ''}`}
                                    onClick={() => {
                                        if (doneTasksCount === 0) return;
                                        setStatusFilter(statusFilter === 'done' ? null : 'done');
                                    }}
                                >
                                    <div className="stat-value">{doneTasksCount}</div>
                                    <div className="stat-label">Done Tasks</div>
                                    <div className="stats-note">{doneStoryPoints.toFixed(1)} SP</div>
                                </div>
                                <div
                                    className={`stat-card high-priority ${statusFilter === 'high-priority' ? 'active' : ''} ${highPriorityCount === 0 ? 'disabled' : ''}`}
                                    onClick={() => {
                                        if (highPriorityCount === 0) return;
                                        setStatusFilter(statusFilter === 'high-priority' ? null : 'high-priority');
                                    }}
                                >
                                    <div className="stat-value">{highPriorityCount}</div>
                                    <div className="stat-label">High Priority</div>
                                    <div className="stats-note">{highPriorityStoryPoints.toFixed(1)} SP</div>
                                </div>
                                <div
                                    className={`stat-card minor ${statusFilter === 'minor-priority' ? 'active' : ''} ${minorPriorityCount === 0 ? 'disabled' : ''}`}
                                    onClick={() => {
                                        if (minorPriorityCount === 0) return;
                                        setStatusFilter(statusFilter === 'minor-priority' ? null : 'minor-priority');
                                    }}
                                >
                                    <div className="stat-value">{minorPriorityCount}</div>
                                    <div className="stat-label">Minor + Lower</div>
                                    <div className="stats-note">{minorPriorityStoryPoints.toFixed(1)} SP</div>
                                </div>
                                <div
                                    className={`stat-card in-progress ${statusFilter === 'in-progress' ? 'active' : ''} ${inProgressTasksCount === 0 ? 'disabled' : ''}`}
                                    onClick={() => {
                                        if (inProgressTasksCount === 0) return;
                                        setStatusFilter(statusFilter === 'in-progress' ? null : 'in-progress');
                                    }}
                                >
                                    <div className="stat-value">{inProgressTasksCount}</div>
                                    <div className="stat-label">In Progress</div>
                                    <div className="stats-note">{inProgressStoryPoints.toFixed(1)} SP</div>
                                </div>
                                <div
                                    className={`stat-card todo-accepted ${statusFilter === 'todo-accepted' ? 'active' : ''} ${todoAcceptedTasksCount === 0 ? 'disabled' : ''}`}
                                    onClick={() => {
                                        if (todoAcceptedTasksCount === 0) return;
                                        setStatusFilter(statusFilter === 'todo-accepted' ? null : 'todo-accepted');
                                    }}
                                >
                                    <div className="stat-value">{todoAcceptedTasksCount}</div>
                                    <div className="stat-label">To Do / Pending / Accepted</div>
                                    <div className="stats-note">{todoAcceptedStoryPoints.toFixed(1)} SP</div>
                                </div>
                            </div>

                            <div className="toggle-container">
                                <button
                                    className={`toggle ${showTech ? 'active' : ''}`}
                                    onClick={() => {
                                        setShowTech(!showTech);
                                    }}
                                >
                                    {showTech
                                        ? `Hide Tech Tasks (${techTasksCount})`
                                        : `Show Tech Tasks (${techTasksCount})`}
                                </button>
                                <button
                                    className={`toggle ${showProduct ? 'active' : ''}`}
                                    onClick={() => setShowProduct(!showProduct)}
                                >
                                    {showProduct ? `Hide Product Tasks (${productTasksCount})` : `Show Product Tasks (${productTasksCount})`}
                                </button>
                                {doneTasks.length > 0 && (
                                    <button
                                        className={`toggle ${showDone ? 'active' : ''}`}
                                        onClick={() => setShowDone(!showDone)}
                                    >
                                        {showDone ? `Hide Done Tasks (${doneTasks.length})` : `Show Done Tasks (${doneTasks.length})`}
                                    </button>
                                )}
                                {killedTasks.length > 0 && (
                                    <button
                                        className={`toggle ${showKilled ? 'active' : ''}`}
                                        onClick={() => setShowKilled(!showKilled)}
                                    >
                                        {showKilled ? `Hide Killed Tasks (${killedTasks.length})` : `Show Killed Tasks (${killedTasks.length})`}
                                    </button>
                                )}
                            </div>

                            {visibleTasks.length === 0 ? (
                                <div className="empty-state">
                                    <h2>No tasks found</h2>
                                    <p>There are no tasks matching the current criteria</p>
                                </div>
                            ) : (
                                <div className="task-list">
                                    {epicGroups.map(epicGroup => {
                                        const epicInfo = epicGroup.epic;
                                        const epicTitle = epicInfo?.summary || epicGroup.parentSummary ||
                                            (epicGroup.key === 'NO_EPIC' ? 'No Epic Linked' : epicGroup.key);
                                        const epicTotalSp = epicGroup.storyPoints || 0;

                                        return (
                                            <div key={epicGroup.key} className="epic-block">
	                                                <div className="epic-header">
                                                        <div className="epic-title">
	                                                        <div className="epic-title-row">
                                                            <span className="epic-icon" aria-hidden="true" title="EPIC">
                                                                <svg viewBox="0 0 24 24" fill="none">
                                                                    <rect x="3" y="3" width="18" height="18" rx="3" stroke="#1D7AFC" strokeWidth="2"/>
                                                                    <path d="M7.5 12.5l3 3 6-6" stroke="#1D7AFC" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                                                </svg>
                                                            </span>
                                                            {epicGroup.key !== 'NO_EPIC' ? (
                                                                <a
                                                                    className="epic-link"
                                                                    href={`${jiraUrl}/browse/${epicGroup.key}`}
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                >
                                                                    <span className="epic-name">{epicTitle}</span>
                                                                    <span className="epic-key">{epicGroup.key}</span>
                                                                </a>
                                                            ) : (
                                                                <>
                                                                    <span className="epic-name">{epicTitle}</span>
                                                                    <span className="epic-key">Unassigned</span>
                                                                </>
                                                            )}
                                                            {(showStats || showPlanning) && (
                                                                <button
                                                                    className={`epic-stat-toggle ${excludedEpicSet.has(epicGroup.key) ? '' : 'active'}`}
                                                                    onClick={() => {
                                                                        const epicKey = epicGroup.key || 'NO_EPIC';
                                                                        setExcludedStatsEpics((prev) => {
                                                                            const set = new Set(prev || []);
                                                                            if (set.has(epicKey)) {
                                                                                set.delete(epicKey);
                                                                            } else {
                                                                                set.add(epicKey);
                                                                            }
                                                                            return Array.from(set);
                                                                        });
                                                                    }}
                                                                    title="Include/exclude epic in sprint stats and planning capacity"
                                                                >
                                                                    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                                                        <circle cx="12" cy="12" r="9" stroke="currentColor" strokeWidth="2" />
                                                                        <path d="M12 6v6l4 2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                                                                    </svg>
                                                                    {excludedEpicSet.has(epicGroup.key) ? 'Excluded' : 'Included'}
                                                                </button>
                                                            )}
                                                        </div>
	                                                    </div>
	                                                    <div className="epic-meta">
	                                                        <span>SP: {epicTotalSp.toFixed(1)}</span>
	                                                        {epicInfo?.assignee?.displayName && (
	                                                            <span className="task-assignee epic-assignee">
	                                                                <span className="task-assignee-icon" aria-hidden="true">
	                                                                    <svg viewBox="0 0 24 24" fill="none">
	                                                                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z" stroke="currentColor" strokeWidth="2" />
	                                                                        <path d="M4 20c0-3.31 3.58-6 8-6s8 2.69 8 6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
	                                                                    </svg>
	                                                                </span>
	                                                                <span>{epicInfo.assignee.displayName}</span>
	                                                            </span>
	                                                        )}
	                                                    </div>
	                                                </div>
                                                {epicGroup.tasks.map(task => {
                                                    const isKilled = task.fields.status?.name === 'Killed';
                                                    const isDone = task.fields.status?.name === 'Done';
                                                    const teamInfo = getTeamInfo(task);
                                                    return (
                                                        <div
                                                            key={task.key}
                                                            className={`task-item priority-${task.fields.priority?.name.toLowerCase()} ${isDone ? 'status-done' : ''} ${isKilled ? 'status-killed' : ''}`}
                                                        >
                                                            <div className="task-header">
                                                                <button
                                                                    className="task-remove"
                                                                    onClick={() => removeTask(task.key)}
                                                                    title="Remove task from view"
                                                                >
                                                                    Ã
                                                                </button>
                                                                <div className="task-headline">
                                                                    <span className="story-icon" aria-hidden="true" title="STORY">
                                                                        <svg viewBox="0 0 24 24" fill="none">
                                                                            <path d="M7 4h10a2 2 0 012 2v14l-7-4-7 4V6a2 2 0 012-2z" stroke="#55A630" strokeWidth="2" strokeLinejoin="round"/>
                                                                        </svg>
                                                                    </span>
                                                                    <h3 className="task-title">
                                                                        <a href={`${jiraUrl}/browse/${task.key}`} target="_blank" rel="noopener noreferrer">
                                                                            {task.fields.summary}
                                                                        </a>
                                                                    </h3>
                                                                    <span className="task-inline-meta">
                                                                        <a
                                                                            className="task-key-link"
                                                                            href={`${jiraUrl}/browse/${task.key}`}
                                                                            target="_blank"
                                                                            rel="noopener noreferrer"
                                                                        >
                                                                            {task.key}
                                                                        </a>
                                                                        {task.fields.customfield_10004 && (
                                                                            <span className="task-inline-sp">
                                                                                {task.fields.customfield_10004} SP
                                                                            </span>
                                                                        )}
                                                                    </span>
                                                                    {showPlanning && (
                                                                        <input
                                                                            type="checkbox"
                                                                            className="task-checkbox"
                                                                            checked={!!selectedTasks[task.key]}
                                                                            onChange={() => toggleTaskSelection(task.key)}
                                                                            title="Select for sprint planning"
                                                                        />
                                                                    )}
                                                                </div>
                                                                <span className={`task-priority ${task.fields.priority?.name.toLowerCase()}`}>
                                                                    {task.fields.priority?.name || 'None'}
                                                                </span>
                                                            </div>
                                                            <div className="task-meta">
                                                                <span className={`task-status ${task.fields.status?.name.toLowerCase().replace(/\s+/g, '-')}`}>
                                                                    {task.fields.status?.name}
                                                                </span>
                                                                <span className="task-team">{teamInfo.name}</span>
                                                                {task.fields.assignee && (
                                                                    <span className="task-assignee">
                                                                        <span className="task-assignee-icon" aria-hidden="true">
                                                                            <svg viewBox="0 0 24 24" fill="none">
                                                                                <path d="M12 12a4.5 4.5 0 1 0-4.5-4.5A4.5 4.5 0 0 0 12 12Z" stroke="currentColor" strokeWidth="1.6"/>
                                                                                <path d="M4 20c1.8-4 6-5.5 8-5.5S18.2 16 20 20" stroke="currentColor" strokeWidth="1.6" strokeLinecap="round"/>
                                                                            </svg>
                                                                        </span>
                                                                        {task.fields.assignee.displayName}
                                                                    </span>
                                                                )}
                                                                {task.fields.updated && (
                                                                    <span className="task-updated">
                                                                        Last Update: {new Date(task.fields.updated).toLocaleDateString('en-CA')}
                                                                    </span>
                                                                )}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        );
                                    })}
                                </div>
                            )}

                            <div style={{marginTop: '3rem', textAlign: 'center'}}>
                                <button onClick={fetchTasks}>
                                    Refresh
                                </button>
                            </div>
                        </>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
